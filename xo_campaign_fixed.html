<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XO Arena ‚Äî 50 Level Campaign</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#030308;--panel:#0a0a14;--panel2:#0f0f1e;--border:#1a1a35;
  --x:#ff0080;--xg:rgba(255,0,128,.4);--o:#00f5ff;--og:rgba(0,245,255,.4);
  --gold:#ffd700;--gg:rgba(255,215,0,.4);--text:#e8e8ff;--muted:#4a4a7a;
  --ok:#00ff88;--bad:#ff4444;
  --z1:#00ff88;--z2:#00aaff;--z3:#ff8800;--z4:#aa55ff;--z5:#ffd700;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{height:100%}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;min-height:100%;overflow-x:hidden}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,.04) 0,rgba(0,0,0,.04) 1px,transparent 1px,transparent 3px);pointer-events:none;z-index:9999}
#bgc,#cfc{position:fixed;inset:0;z-index:0;pointer-events:none}
#cfc{z-index:99}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:10;opacity:0;transform:translateY(20px) scale(.97);pointer-events:none;transition:opacity .45s ease,transform .45s cubic-bezier(.34,1.1,.64,1);padding:16px;overflow-y:auto}
.screen.active{opacity:1;transform:none;pointer-events:auto}
.screen.exit{opacity:0;transform:translateY(-20px);pointer-events:none;transition:opacity .3s,transform .3s}

/* ‚îÄ‚îÄ CARD BASE ‚îÄ‚îÄ */
.card{background:var(--panel);border:1px solid var(--border);border-radius:22px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
#authScreen .card{padding:38px 34px;width:min(410px,95vw);box-shadow:0 0 60px rgba(0,245,255,.05)}
#authScreen .card::before{background:linear-gradient(90deg,var(--x),var(--o))}
.logo-sym{font-family:'Orbitron',monospace;font-size:2.8rem;font-weight:900;text-align:center;background:linear-gradient(135deg,var(--x),var(--o));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:logoPulse 3s ease-in-out infinite;display:block}
@keyframes logoPulse{0%,100%{filter:drop-shadow(0 0 10px var(--xg))}50%{filter:drop-shadow(0 0 10px var(--og))}}
.logo-sub{text-align:center;font-size:.6rem;letter-spacing:.28em;color:var(--muted);text-transform:uppercase;margin:6px 0 26px}
.atabs{display:flex;background:var(--panel2);border:1px solid var(--border);border-radius:9px;padding:4px;gap:4px;margin-bottom:22px}
.atab{flex:1;padding:9px;border:none;border-radius:7px;background:transparent;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.8rem;font-weight:600;letter-spacing:.12em;text-transform:uppercase;cursor:pointer;transition:all .22s}
.atab.on{background:linear-gradient(135deg,rgba(255,0,128,.12),rgba(0,245,255,.12));color:var(--text)}
.fgrp{margin-bottom:15px}
.flbl{display:block;font-size:.65rem;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);margin-bottom:7px;font-weight:600}
.finp{width:100%;padding:11px 14px;background:var(--panel2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:.92rem;outline:none;transition:border-color .22s,box-shadow .22s}
.finp:focus{border-color:var(--o);box-shadow:0 0 16px rgba(0,245,255,.1)}
.finp::placeholder{color:var(--muted)}
.finp.err{border-color:var(--bad)}
.ferr{font-size:.7rem;color:var(--bad);margin-top:5px;display:none}
.ferr.on{display:block}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:.12em;text-transform:uppercase;cursor:pointer;border-radius:9px;transition:all .2s;font-size:.8rem}
.btn-primary{padding:13px;background:linear-gradient(135deg,var(--x),#cc0066);color:#fff;font-family:'Orbitron',monospace;font-size:.72rem;letter-spacing:.18em;width:100%;border:none;position:relative;overflow:hidden}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 24px var(--xg)}
.btn-primary:active{transform:none}
.btn-sec{padding:9px 20px;border:1px solid var(--border);background:transparent;color:var(--muted)}
.btn-sec:hover{border-color:var(--o);color:var(--o)}
.btn-danger{padding:9px 20px;border:1px solid rgba(255,68,68,.3);background:rgba(255,68,68,.07);color:var(--bad)}
.btn-danger:hover{border-color:var(--bad);background:rgba(255,68,68,.14)}
.btn-gold{padding:11px 24px;border:1px solid var(--gold);background:rgba(255,215,0,.07);color:var(--gold);font-family:'Orbitron',monospace;font-size:.7rem;letter-spacing:.16em}
.btn-gold:hover{background:rgba(255,215,0,.14);box-shadow:0 0 20px var(--gg);transform:translateY(-2px)}
.btn-green{padding:11px 24px;border:1px solid rgba(0,255,136,.3);background:rgba(0,255,136,.07);color:var(--ok);font-family:'Orbitron',monospace;font-size:.7rem;letter-spacing:.16em}
.btn-green:hover{background:rgba(0,255,136,.14);box-shadow:0 0 20px rgba(0,255,136,.3)}
.w100{width:100%}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
#homeScreen .card{padding:40px 32px;width:min(470px,95vw);text-align:center}
#homeScreen .card::before{background:linear-gradient(90deg,var(--x),var(--gold),var(--o))}
.htitle{font-family:'Orbitron',monospace;font-size:clamp(1.9rem,5vw,2.8rem);font-weight:900;background:linear-gradient(90deg,var(--x),var(--gold),var(--o));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:glitch 9s infinite}
@keyframes glitch{0%,93%,100%{filter:none;transform:none}94%{filter:drop-shadow(2px 0 var(--x)) drop-shadow(-2px 0 var(--o));transform:skewX(.5deg)}95%{filter:none;transform:none}96%{filter:drop-shadow(-1px 0 var(--x));transform:skewX(-.3deg)}97%{filter:none;transform:none}}
.hsub{font-size:.68rem;letter-spacing:.25em;color:var(--muted);text-transform:uppercase;margin:8px 0 30px}
.mcards{display:flex;flex-direction:column;gap:12px;margin-bottom:18px}
.mcard{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:18px 20px;cursor:pointer;transition:all .22s;text-align:left;position:relative;overflow:hidden}
.mcard::before{content:'';position:absolute;top:0;left:0;bottom:0;width:3px;transition:background .25s}
.mcard:hover::before{background:var(--o)}
.mcard:hover{border-color:rgba(0,245,255,.25);transform:translateX(3px)}
.mcard.camp::before{background:var(--gold)}
.mcard.camp{border-color:rgba(255,215,0,.18)}
.mcard.camp:hover{border-color:rgba(255,215,0,.4)}
.mtitle{font-family:'Orbitron',monospace;font-size:.88rem;font-weight:700;margin-bottom:4px}
.mcard.camp .mtitle{color:var(--gold)}
.msub{font-size:.74rem;color:var(--muted);line-height:1.5}
.mbadge{display:inline-block;padding:2px 9px;border-radius:99px;font-size:.56rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;margin-left:7px;vertical-align:middle}
.bg{background:rgba(255,215,0,.1);color:var(--gold);border:1px solid rgba(255,215,0,.28)}
.bx{background:rgba(255,0,128,.1);color:var(--x);border:1px solid rgba(255,0,128,.28)}

/* ‚îÄ‚îÄ LEVEL MAP ‚îÄ‚îÄ */
#mapScreen{align-items:flex-start;overflow-y:auto}
.mapwrap{width:min(840px,97vw);padding:8px 0 30px}
.maphdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:10px}
.maptitle{font-family:'Orbitron',monospace;font-size:clamp(1.2rem,3.5vw,1.9rem);font-weight:900;background:linear-gradient(90deg,var(--gold),var(--o));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.mapprog{font-size:.65rem;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin-top:4px}
.mapprog span{color:var(--gold);font-family:'Orbitron',monospace}
.zone{margin-bottom:20px;border-radius:16px;background:var(--panel);border:1px solid var(--border);overflow:hidden}
.zhdr{padding:12px 18px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)}
.znum{font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;letter-spacing:.12em;padding:3px 9px;border-radius:99px}
.zname{font-family:'Orbitron',monospace;font-size:.88rem;font-weight:700}
.zstars{font-size:.64rem;color:var(--muted);margin-left:auto}
.zgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;padding:12px}
.ltile{aspect-ratio:1;min-height:64px;border-radius:11px;border:1px solid var(--border);background:var(--panel2);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;transition:transform .18s,box-shadow .18s,border-color .18s;user-select:none}
.ltile.locked{cursor:not-allowed;opacity:.4}
.ltile:not(.locked):hover{transform:scale(1.08);z-index:2}
.ltile .lnum{font-family:'Orbitron',monospace;font-size:.78rem;font-weight:700}
.ltile .lico{font-size:1rem;margin-bottom:2px}
.ltile .lstars{display:flex;gap:2px;margin-top:3px}
.ltile .lst{font-size:.56rem;color:var(--muted)}
.ltile .lst.on{color:var(--gold)}
.ltile .llock{font-size:.9rem;color:var(--muted)}
.ltile.boss{border-width:2px}
.ltile.boss .lico{animation:bpulse 2s ease-in-out infinite}
@keyframes bpulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}

/* zone colors */
.z1 .znum,.z1 .zname{color:var(--z1)}.z1 .znum{background:rgba(0,255,136,.12);border:1px solid rgba(0,255,136,.25)}
.z1 .ltile:not(.locked){border-color:rgba(0,255,136,.18)}.z1 .ltile:not(.locked):hover{border-color:var(--z1);box-shadow:0 0 16px rgba(0,255,136,.2)}.z1 .ltile.done{background:rgba(0,255,136,.08)}.z1 .ltile.boss{border-color:var(--z1)}.z1 .lnum{color:var(--z1)}
.z2 .znum,.z2 .zname{color:var(--z2)}.z2 .znum{background:rgba(0,170,255,.12);border:1px solid rgba(0,170,255,.25)}
.z2 .ltile:not(.locked){border-color:rgba(0,170,255,.18)}.z2 .ltile:not(.locked):hover{border-color:var(--z2);box-shadow:0 0 16px rgba(0,170,255,.2)}.z2 .ltile.done{background:rgba(0,170,255,.08)}.z2 .ltile.boss{border-color:var(--z2)}.z2 .lnum{color:var(--z2)}
.z3 .znum,.z3 .zname{color:var(--z3)}.z3 .znum{background:rgba(255,136,0,.12);border:1px solid rgba(255,136,0,.25)}
.z3 .ltile:not(.locked){border-color:rgba(255,136,0,.18)}.z3 .ltile:not(.locked):hover{border-color:var(--z3);box-shadow:0 0 16px rgba(255,136,0,.2)}.z3 .ltile.done{background:rgba(255,136,0,.08)}.z3 .ltile.boss{border-color:var(--z3)}.z3 .lnum{color:var(--z3)}
.z4 .znum,.z4 .zname{color:var(--z4)}.z4 .znum{background:rgba(170,85,255,.12);border:1px solid rgba(170,85,255,.25)}
.z4 .ltile:not(.locked){border-color:rgba(170,85,255,.18)}.z4 .ltile:not(.locked):hover{border-color:var(--z4);box-shadow:0 0 16px rgba(170,85,255,.2)}.z4 .ltile.done{background:rgba(170,85,255,.08)}.z4 .ltile.boss{border-color:var(--z4)}.z4 .lnum{color:var(--z4)}
.z5 .znum,.z5 .zname{color:var(--z5)}.z5 .znum{background:rgba(255,215,0,.12);border:1px solid rgba(255,215,0,.25)}
.z5 .ltile:not(.locked){border-color:rgba(255,215,0,.18)}.z5 .ltile:not(.locked):hover{border-color:var(--z5);box-shadow:0 0 16px rgba(255,215,0,.2)}.z5 .ltile.done{background:rgba(255,215,0,.08)}.z5 .ltile.boss{border-color:var(--z5)}.z5 .lnum{color:var(--z5)}

/* ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ */
#gameScreen{align-items:center}
.ginner{display:flex;flex-direction:column;align-items:center;gap:14px;width:min(480px,97vw)}
.topbar{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px}
.gtitle{font-family:'Orbitron',monospace;font-size:clamp(1rem,3.5vw,1.5rem);font-weight:900;background:linear-gradient(90deg,var(--x),var(--gold),var(--o));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:glitch 9s infinite}
.glabel{font-size:.58rem;letter-spacing:.2em;color:var(--muted);text-transform:uppercase;margin-top:2px}
.hud{width:100%;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px 16px;display:flex;flex-wrap:wrap;align-items:center;gap:10px}
.hcell{display:flex;flex-direction:column;align-items:center;min-width:52px}
.hval{font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:700;line-height:1}
.hlbl{font-size:.56rem;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);margin-top:2px}
.hsep{width:1px;height:32px;background:var(--border)}
.hobjwrap{flex:1;min-width:100px}
.hobj{font-size:.74rem;font-weight:600;color:var(--text);margin-top:2px;line-height:1.3}
.tdanger{color:var(--bad)!important;animation:tblink .5s ease-in-out infinite}
@keyframes tblink{0%,100%{opacity:1}50%{opacity:.35}}

/* boss tracker */
.btracker{width:100%;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px 16px;display:none;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.btracker.on{display:flex}
.bpips{display:flex;gap:5px;flex-wrap:wrap}
.bpip{width:26px;height:26px;border-radius:7px;border:1px solid var(--border);background:var(--panel2);display:flex;align-items:center;justify-content:center;font-size:.7rem;transition:all .3s;font-family:'Orbitron',monospace;font-weight:700}
.bpip.wp{background:rgba(0,255,136,.14);border-color:rgba(0,255,136,.4);color:var(--ok)}
.bpip.lp{background:rgba(255,68,68,.14);border-color:rgba(255,68,68,.4);color:var(--bad)}
.blbl{font-size:.63rem;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);font-weight:600}

/* qp settings */
.qpset{width:100%;display:none;gap:10px;flex-wrap:wrap;align-items:center}
.qpset.on{display:flex}
.qplbl{font-size:.62rem;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);align-self:center}
.qpbtn{padding:6px 12px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.72rem;font-weight:600;text-transform:uppercase;cursor:pointer;border-radius:8px;transition:all .2s}
.qpbtn:hover{border-color:var(--o);color:var(--o)}
.qpbtn.on{border-color:var(--o);color:var(--o);background:rgba(0,245,255,.08)}

/* status bar */
.sbar{width:100%;background:var(--panel);border:1px solid var(--border);border-radius:11px;padding:11px 16px;display:flex;align-items:center;gap:11px;position:relative;overflow:hidden;transition:border-color .25s,box-shadow .25s}
.sbar::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;transition:background .25s,box-shadow .25s}
.sbar.xt::before{background:var(--x);box-shadow:4px 0 12px var(--xg)}.sbar.xt{border-color:rgba(255,0,128,.2)}
.sbar.ot::before{background:var(--o);box-shadow:4px 0 12px var(--og)}.sbar.ot{border-color:rgba(0,245,255,.2)}
.sbar.win::before{background:var(--gold);box-shadow:4px 0 12px var(--gg)}.sbar.win{border-color:rgba(255,215,0,.28);box-shadow:0 0 24px rgba(255,215,0,.07)}
.sico{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-weight:900;font-size:.9rem;flex-shrink:0}
.xic{background:rgba(255,0,128,.12);color:var(--x);border:1px solid rgba(255,0,128,.22)}
.oic{background:rgba(0,245,255,.12);color:var(--o);border:1px solid rgba(0,245,255,.22)}
.stic{background:rgba(255,215,0,.12);color:var(--gold);border:1px solid rgba(255,215,0,.22)}
.smain{font-size:.92rem;font-weight:600;color:var(--text)}
.ssub{font-size:.6rem;letter-spacing:.13em;color:var(--muted);text-transform:uppercase}
.tdots{display:inline-flex;gap:3px;margin-left:5px;vertical-align:middle}
.tdots span{width:4px;height:4px;background:var(--o);border-radius:50%;animation:bd 1.2s ease-in-out infinite}
.tdots span:nth-child(2){animation-delay:.2s}.tdots span:nth-child(3){animation-delay:.4s}
@keyframes bd{0%,80%,100%{opacity:.2;transform:scale(.7)}40%{opacity:1;transform:scale(1)}}

/* board */
.bouter{position:relative;padding:3px;border-radius:18px;background:linear-gradient(135deg,rgba(255,0,128,.22),rgba(0,245,255,.22));box-shadow:0 0 50px rgba(0,245,255,.06)}
.board{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;background:var(--border);border-radius:16px;overflow:hidden;width:min(290px,78vw);height:min(290px,78vw)}
.cell{background:var(--panel);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;transition:background .16s;-webkit-tap-highlight-color:transparent}
.cell:hover:not(.taken):not(.locked):not(.forb){background:#0f0f22}
.cell.taken,.cell.locked{cursor:default}
.cell.forb{cursor:not-allowed;background:rgba(255,68,68,.04)}
.cell.forb::after{content:'‚úï';position:absolute;font-size:1.1rem;color:rgba(255,68,68,.12);pointer-events:none}
.cell svg{width:52%;height:52%;position:relative;z-index:1;opacity:0;transform:scale(.2)}
.cell.revealed svg{animation:pop .32s cubic-bezier(.34,1.56,.64,1) forwards}
@keyframes pop{from{opacity:0;transform:scale(.2) rotate(-12deg)}to{opacity:1;transform:scale(1) rotate(0)}}
.cell.wc{background:rgba(255,215,0,.06)!important}
.cell.wc svg{animation:wpulse 1.5s ease-in-out infinite!important}
@keyframes wpulse{0%,100%{filter:drop-shadow(0 0 7px var(--gg));transform:scale(1)}50%{filter:drop-shadow(0 0 18px var(--gold));transform:scale(1.06)}}

.actbar{display:flex;gap:9px;flex-wrap:wrap;justify-content:center;width:100%}

/* ‚îÄ‚îÄ OVERLAYS ‚îÄ‚îÄ */
.ov{position:fixed;inset:0;background:rgba(3,3,8,.87);backdrop-filter:blur(10px);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .35s;padding:16px}
.ov.on{opacity:1;pointer-events:auto}
.ocard{background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:36px 30px;width:min(390px,95vw);text-align:center;position:relative;overflow:hidden;transform:scale(.82);opacity:0;transition:all .4s cubic-bezier(.34,1.3,.64,1)}
.ov.on .ocard{transform:scale(1);opacity:1}
.ocard::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.ov-win .ocard::before{background:linear-gradient(90deg,var(--gold),var(--ok))}
.ov-fail .ocard::before{background:linear-gradient(90deg,var(--bad),var(--x))}
.oemoji{font-size:3.5rem;display:block;animation:bIn .6s cubic-bezier(.34,1.56,.64,1) .1s both;margin-bottom:10px}
@keyframes bIn{from{transform:scale(0) rotate(-180deg)}to{transform:scale(1) rotate(0)}}
.otitle{font-family:'Orbitron',monospace;font-size:1.6rem;font-weight:900;margin-bottom:7px}
.osub{font-size:.8rem;color:var(--muted);line-height:1.6;margin-bottom:20px}
.ostars{display:flex;justify-content:center;gap:10px;margin-bottom:22px}
.ostar{font-size:2.2rem;color:var(--muted);transition:all .4s cubic-bezier(.34,1.56,.64,1)}
.ostar.on{color:var(--gold);filter:drop-shadow(0 0 8px var(--gg));animation:spop .5s cubic-bezier(.34,1.56,.64,1) both}
@keyframes spop{from{transform:scale(0) rotate(-30deg)}to{transform:scale(1) rotate(0)}}
.ostar.on:nth-child(2){animation-delay:.1s}.ostar.on:nth-child(3){animation-delay:.22s}
.obtns{display:flex;gap:9px;flex-wrap:wrap;justify-content:center}

/* round banner */
.rbanner{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:200;pointer-events:none;opacity:0}
.rbanner.on{animation:rflash 1.9s ease forwards}
@keyframes rflash{0%{opacity:0;transform:scale(.7)}18%{opacity:1;transform:scale(1)}72%{opacity:1}100%{opacity:0;transform:scale(1.08)}}
.rbtxt{font-family:'Orbitron',monospace;font-size:clamp(1.4rem,5vw,3rem);font-weight:900;padding:14px 36px;border-radius:14px;background:rgba(10,10,20,.96);border:2px solid var(--gold);color:var(--gold);text-shadow:0 0 28px var(--gg);box-shadow:0 0 50px var(--gg);letter-spacing:.08em}

/* toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(70px);background:var(--panel);border:1px solid var(--border);border-radius:9px;padding:10px 20px;font-size:.78rem;letter-spacing:.1em;z-index:999;transition:transform .4s cubic-bezier(.34,1.3,.64,1),opacity .3s;opacity:0;white-space:nowrap;max-width:90vw;text-align:center}
.toast.on{transform:translateX(-50%) translateY(0);opacity:1}
.toast.ok{border-color:rgba(0,255,136,.4);color:var(--ok)}
.toast.err{border-color:rgba(255,68,68,.4);color:var(--bad)}
.toast.info{border-color:rgba(0,245,255,.4);color:var(--o)}

.hidden{display:none!important}
</style>
</head>
<body>
<canvas id="bgc"></canvas>
<canvas id="cfc"></canvas>

<!-- ‚ïê‚ïê AUTH ‚ïê‚ïê -->
<div class="screen active" id="authScreen">
  <div class="card">
    <span class="logo-sym">XO</span>
    <div class="logo-sub">50-Level Campaign ¬∑ Minimax AI</div>
    <div class="atabs">
      <button class="atab on" id="tab-login" onclick="switchTab('login')">Login</button>
      <button class="atab" id="tab-signup" onclick="switchTab('signup')">Sign Up</button>
    </div>
    <!-- Login -->
    <div id="form-login">
      <div class="fgrp"><label class="flbl">Username</label><input id="lu" class="finp" placeholder="username" autocomplete="username"><div class="ferr" id="lerr"></div></div>
      <div class="fgrp"><label class="flbl">Password</label><input id="lp" class="finp" type="password" placeholder="password" autocomplete="current-password"></div>
      <button class="btn btn-primary w100" onclick="doLogin()" style="margin-top:4px">‚ö° ENTER THE ARENA</button>
      <p style="text-align:center;margin-top:13px;font-size:.72rem;color:var(--muted)">No account? <span style="color:var(--o);cursor:pointer" onclick="switchTab('signup')">Sign up ‚Üí</span></p>
    </div>
    <!-- Signup -->
    <div id="form-signup" class="hidden">
      <div class="fgrp"><label class="flbl">Display Name</label><input id="sn" class="finp" placeholder="Your name"><div class="ferr" id="snerr">2‚Äì20 characters</div></div>
      <div class="fgrp"><label class="flbl">Username</label><input id="su" class="finp" placeholder="3-16 chars, a-z 0-9 _" autocomplete="username"><div class="ferr" id="suerr">Username taken or invalid</div></div>
      <div class="fgrp"><label class="flbl">Password</label><input id="sp" class="finp" type="password" placeholder="min 4 characters" autocomplete="new-password"><div class="ferr" id="sperr">Min 4 characters</div></div>
      <button class="btn btn-primary w100" onclick="doSignup()" style="margin-top:4px">üöÄ CREATE ACCOUNT</button>
      <p style="text-align:center;margin-top:13px;font-size:.72rem;color:var(--muted)">Have account? <span style="color:var(--o);cursor:pointer" onclick="switchTab('login')">Login ‚Üí</span></p>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê HOME ‚ïê‚ïê -->
<div class="screen" id="homeScreen">
  <div class="card">
    <div class="htitle">XO ARENA</div>
    <div class="hsub" id="homeWelcome">Welcome back!</div>
    <div class="mcards">
      <div class="mcard camp" onclick="goCampaign()">
        <div class="mtitle">üó∫Ô∏è Campaign Mode <span class="mbadge bg">50 LEVELS</span></div>
        <div class="msub">5 zones ¬∑ puzzles ¬∑ time attacks ¬∑ boss battles ¬∑ 3-star rating</div>
      </div>
      <div class="mcard" onclick="goQuick()">
        <div class="mtitle">‚ö° Quick Play <span class="mbadge bx">FREE PLAY</span></div>
        <div class="msub">Jump in instantly. Choose difficulty and side.</div>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
      <div style="font-size:.64rem;color:var(--muted);letter-spacing:.14em">PROGRESS <span id="homeProg" style="color:var(--gold);font-family:'Orbitron',monospace">0/50</span> ¬∑ <span id="homeStars" style="color:var(--gold);font-family:'Orbitron',monospace">0</span>‚≠ê</div>
      <button class="btn btn-danger" style="padding:7px 16px;font-size:.7rem" onclick="doLogout()">‚èª Logout</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê LEVEL MAP ‚ïê‚ïê -->
<div class="screen" id="mapScreen">
  <div class="mapwrap">
    <div class="maphdr">
      <div>
        <div class="maptitle">CAMPAIGN MAP</div>
        <div class="mapprog">Completed: <span id="mapDone">0</span>/50 ¬∑ Stars: <span id="mapStars">0</span>/150</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sec" style="padding:8px 16px" onclick="toHome()">‚Üê Home</button>
        <button class="btn btn-danger" style="padding:8px 16px" onclick="doLogout()">‚èª</button>
      </div>
    </div>
    <div id="mapContent"></div>
  </div>
</div>

<!-- ‚ïê‚ïê GAME SCREEN ‚ïê‚ïê -->
<div class="screen" id="gameScreen">
  <div class="ginner">
    <!-- Top bar -->
    <div class="topbar">
      <div>
        <div class="gtitle">TIC¬∑TAC¬∑TOE</div>
        <div class="glabel" id="glabel">QUICK PLAY</div>
      </div>
      <div style="display:flex;gap:7px">
        <button class="btn btn-sec" style="padding:7px 13px;font-size:.68rem" onclick="goBackFromGame()">‚Üê BACK</button>
        <button class="btn btn-danger" style="padding:7px 13px;font-size:.68rem" onclick="doLogout()">‚èª</button>
      </div>
    </div>

    <!-- HUD -->
    <div class="hud hidden" id="hud">
      <div class="hcell"><div class="hval" id="hlvl" style="color:var(--gold)">L1</div><div class="hlbl">Level</div></div>
      <div class="hsep"></div>
      <div class="hcell hidden" id="htimercell"><div class="hval" id="htimer" style="color:var(--o)">60</div><div class="hlbl">Secs</div></div>
      <div class="hsep hidden" id="htimersep"></div>
      <div class="hcell hidden" id="hmovescell"><div class="hval" id="hmoves" style="color:var(--x)">0</div><div class="hlbl">Moves</div></div>
      <div class="hsep hidden" id="hmovessep"></div>
      <div class="hobjwrap"><div class="hlbl" id="hobjlbl">Objective</div><div class="hobj" id="hobj">‚Äî</div></div>
    </div>

    <!-- Boss tracker -->
    <div class="btracker" id="btracker">
      <div class="blbl" id="blbl">ROUND 1</div>
      <div class="bpips" id="bpips"></div>
      <div class="blbl" id="bneed">WIN 2/3</div>
    </div>

    <!-- Quick play settings -->
    <div class="qpset" id="qpset">
      <span class="qplbl">Side:</span>
      <button class="qpbtn on" id="qpX" onclick="qpSide('X',this)">X First</button>
      <button class="qpbtn" id="qpO" onclick="qpSide('O',this)">O Second</button>
      <span class="qplbl" style="margin-left:6px">Diff:</span>
      <button class="qpbtn" onclick="qpDiff('beginner',this)">Baby</button>
      <button class="qpbtn" onclick="qpDiff('easy',this)">Easy</button>
      <button class="qpbtn on" id="qpNorm" onclick="qpDiff('normal',this)">Normal</button>
      <button class="qpbtn" onclick="qpDiff('hard',this)">Hard</button>
      <button class="qpbtn" onclick="qpDiff('nightmare',this)">üíÄ Max</button>
    </div>

    <!-- Status bar -->
    <div class="sbar xt" id="sbar">
      <div class="sico xic" id="sico">X</div>
      <div><div class="smain" id="smain">Your turn</div><div class="ssub" id="ssub">Click a cell to play</div></div>
    </div>

    <!-- Board -->
    <div class="bouter"><div class="board" id="board"></div></div>

    <!-- Actions -->
    <div class="actbar">
      <button class="btn btn-gold" onclick="retryLevel()">‚Ü∫ RETRY</button>
      <button class="btn btn-sec" onclick="goBackFromGame()">‚äû LEVELS</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê WIN OVERLAY ‚ïê‚ïê -->
<div class="ov ov-win" id="ov-win">
  <div class="ocard">
    <span class="oemoji" id="oe">üèÜ</span>
    <div class="otitle" id="ot" style="color:var(--gold)">Level Complete!</div>
    <div class="osub" id="os">You did it!</div>
    <div class="ostars"><span class="ostar" id="os1">‚òÖ</span><span class="ostar" id="os2">‚òÖ</span><span class="ostar" id="os3">‚òÖ</span></div>
    <div class="obtns">
      <button class="btn btn-green" id="btnNext" onclick="nextLevel()">‚Üí NEXT</button>
      <button class="btn btn-gold" onclick="retryFromOv('win')">‚Ü∫ RETRY</button>
      <button class="btn btn-sec" onclick="closeOv('win')">MAP</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê FAIL OVERLAY ‚ïê‚ïê -->
<div class="ov ov-fail" id="ov-fail">
  <div class="ocard">
    <span class="oemoji" id="fe">üíÄ</span>
    <div class="otitle" id="ft" style="color:var(--bad)">Level Failed!</div>
    <div class="osub" id="fs">Try again!</div>
    <div class="obtns">
      <button class="btn btn-gold" onclick="retryFromOv('fail')">‚Ü∫ RETRY</button>
      <button class="btn btn-sec" onclick="closeOv('fail')">‚Üê MAP</button>
    </div>
  </div>
</div>

<!-- Round banner -->
<div class="rbanner" id="rbanner"><div class="rbtxt" id="rbtxt">ROUND 2</div></div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEVELS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ZNAMES=['','Boot Camp','Apprentice','Warrior','Champion','Legend'];
const ZEMOJI=['','ü•æ','üìò','‚öîÔ∏è','üèÜ','üëë'];

const LEVELS=[
  // Zone 1
  {id:1,z:1,name:'First Blood',    type:'win',     diff:'beginner',                   goal:'Beat the AI',              s3t:'moves',s3n:7},
  {id:2,z:1,name:'Warm Up',        type:'win',     diff:'beginner',                   goal:'Win again',                s3t:'moves',s3n:6},
  {id:3,z:1,name:'Quick Strike',   type:'moves',   diff:'beginner',n:7,               goal:'Win in ‚â§7 moves',          s3t:'moves',s3n:5},
  {id:4,z:1,name:'Efficiency',     type:'moves',   diff:'beginner',n:5,               goal:'Win in ‚â§5 moves',          s3t:'moves',s3n:4},
  {id:5,z:1,name:'Center Banned',  type:'nocenter',diff:'beginner',                   goal:'Win without center cell',  s3t:'moves',s3n:7},
  {id:6,z:1,name:'Edge Walker',    type:'nocorners',diff:'beginner',                  goal:'No corners ‚Äî edges only',  s3t:'moves',s3n:7},
  {id:7,z:1,name:'AI First',       type:'win',     diff:'beginner',aiFirst:true,      goal:'AI goes first ‚Äî still win',s3t:'moves',s3n:7},
  {id:8,z:1,name:'Speed Round',    type:'time',    diff:'beginner',n:60,              goal:'Win in ‚â§60 seconds',       s3t:'time', s3n:30},
  {id:9,z:1,name:'Corner Exile',   type:'nocorners',diff:'easy',                      goal:'No corners vs Easy AI',    s3t:'moves',s3n:6},
  {id:10,z:1,name:'‚ö° BOSS I',     type:'boss',    diff:'beginner',n:3,need:2,        goal:'Win 2 of 3 games',         s3t:'boss', s3n:3},
  // Zone 2
  {id:11,z:2,name:'Level Up',      type:'win',     diff:'easy',                       goal:'Beat Easy AI',             s3t:'moves',s3n:5},
  {id:12,z:2,name:'Swift',         type:'moves',   diff:'easy',  n:5,                 goal:'Win in ‚â§5 moves',          s3t:'moves',s3n:4},
  {id:13,z:2,name:'Clockwork',     type:'time',    diff:'easy',  n:45,                goal:'Win in ‚â§45 seconds',       s3t:'time', s3n:20},
  {id:14,z:2,name:'Puzzle I',      type:'puzzle',  puzz:0,                            goal:'Find the ONE winning move',s3t:'instant'},
  {id:15,z:2,name:'No Mans Land',  type:'nocenter',diff:'easy',                       goal:'Win without center',       s3t:'moves',s3n:5},
  {id:16,z:2,name:'Rush Hour',     type:'time',    diff:'easy',  n:30,                goal:'Win in ‚â§30 seconds',       s3t:'time', s3n:15},
  {id:17,z:2,name:'Rapid Fire',    type:'moves',   diff:'easy',  n:4,                 goal:'Win in just 4 moves!',     s3t:'moves',s3n:4},
  {id:18,z:2,name:'Puzzle II',     type:'puzzle',  puzz:1,                            goal:'One move wins it all!',    s3t:'instant'},
  {id:19,z:2,name:'Blitz Mode',    type:'time',    diff:'easy',  n:20,                goal:'Only 20 seconds!',         s3t:'time', s3n:10},
  {id:20,z:2,name:'‚ö° BOSS II',    type:'boss',    diff:'easy',  n:3,need:2,          goal:'Win 2 of 3 games',         s3t:'boss', s3n:3},
  // Zone 3
  {id:21,z:3,name:'Mid Season',    type:'win',     diff:'normal',                     goal:'Beat Normal AI',           s3t:'moves',s3n:5},
  {id:22,z:3,name:'Speedster',     type:'moves',   diff:'normal',n:5,                 goal:'Win in ‚â§5 moves',          s3t:'moves',s3n:4},
  {id:23,z:3,name:'Heart of Stone',type:'nocenter',diff:'normal',                     goal:'No center vs Normal AI',   s3t:'moves',s3n:5},
  {id:24,z:3,name:'Ticking Clock', type:'time',    diff:'normal',n:40,                goal:'Win in ‚â§40 seconds',       s3t:'time', s3n:20},
  {id:25,z:3,name:'Puzzle III',    type:'puzzle',  puzz:2,                            goal:'Spot the winning move!',   s3t:'instant'},
  {id:26,z:3,name:'Top Row Closed',type:'norow',   diff:'normal',row:0,               goal:'Top row forbidden',        s3t:'moves',s3n:5},
  {id:27,z:3,name:'Laser Focus',   type:'moves',   diff:'normal',n:4,                 goal:'Win in just 4 moves!',     s3t:'moves',s3n:4},
  {id:28,z:3,name:'Diagonal Duel', type:'noedge',  diff:'normal',                     goal:'Edges banned ‚Äî corners only',s3t:'moves',s3n:5},
  {id:29,z:3,name:'Speed Warrior', type:'time',    diff:'normal',n:25,                goal:'Only 25 seconds!',         s3t:'time', s3n:12},
  {id:30,z:3,name:'‚ö° BOSS III',   type:'boss',    diff:'normal',n:3,need:2,          goal:'Win 2 of 3 vs Normal AI',  s3t:'boss', s3n:3},
  // Zone 4
  {id:31,z:4,name:'Champions Game',type:'win',     diff:'hard',                       goal:'Beat Hard AI',             s3t:'moves',s3n:5},
  {id:32,z:4,name:'Precise',       type:'moves',   diff:'hard',  n:5,                 goal:'Win in ‚â§5 vs Hard AI',     s3t:'moves',s3n:4},
  {id:33,z:4,name:'Void Center',   type:'nocenter',diff:'hard',                       goal:'Hard AI + No center',      s3t:'moves',s3n:5},
  {id:34,z:4,name:'Champions Rush',type:'time',    diff:'hard',  n:35,                goal:'35 seconds vs Hard AI',    s3t:'time', s3n:15},
  {id:35,z:4,name:'Puzzle IV',     type:'puzzle',  puzz:3,                            goal:'Complex ‚Äî find the win!',  s3t:'instant'},
  {id:36,z:4,name:'Center Stage',  type:'centeronly',diff:'hard',                     goal:'Only center & corners!',   s3t:'moves',s3n:5},
  {id:37,z:4,name:'4-Move Miracle',type:'moves',   diff:'hard',  n:4,                 goal:'Beat Hard AI in 4 moves!', s3t:'moves',s3n:4},
  {id:38,z:4,name:'Flash Mode',    type:'time',    diff:'hard',  n:20,                goal:'Only 20 seconds!',         s3t:'time', s3n:10},
  {id:39,z:4,name:'Puzzle V',      type:'puzzle',  puzz:4,                            goal:'Hardest puzzle ‚Äî think!',  s3t:'instant'},
  {id:40,z:4,name:'‚ö° BOSS IV',    type:'boss',    diff:'hard',  n:3,need:2,          goal:'Win 2 of 3 vs Hard AI',    s3t:'boss', s3n:3},
  // Zone 5
  {id:41,z:5,name:'Legend Begins', type:'win',     diff:'nightmare',                  goal:'Nightmare AI ‚Äî good luck!',s3t:'moves',s3n:5},
  {id:42,z:5,name:'Lightning',     type:'moves',   diff:'nightmare',n:5,              goal:'5 moves vs Nightmare AI',  s3t:'moves',s3n:4},
  {id:43,z:5,name:'Void Center',   type:'nocenter',diff:'nightmare',                  goal:'No center vs Nightmare!',  s3t:'moves',s3n:5},
  {id:44,z:5,name:'Final Rush',    type:'time',    diff:'nightmare',n:30,             goal:'30 secs vs Nightmare',     s3t:'time', s3n:15},
  {id:45,z:5,name:'Puzzle VI',     type:'puzzle',  puzz:5,                            goal:'Master puzzle ‚Äî think!',   s3t:'instant'},
  {id:46,z:5,name:'Sacred Corners',type:'cornersonly',diff:'nightmare',               goal:'Only corners allowed!',    s3t:'moves',s3n:5},
  {id:47,z:5,name:'4 or Nothing',  type:'moves',   diff:'nightmare',n:4,              goal:'Beat Nightmare in 4!',     s3t:'moves',s3n:4},
  {id:48,z:5,name:'Ultra Blitz',   type:'time',    diff:'nightmare',n:15,             goal:'15 SECONDS ‚Äî GO!',         s3t:'time', s3n:8},
  {id:49,z:5,name:'Flawless',      type:'win',     diff:'nightmare',aiFirst:true,     goal:'AI first. Win anyway.',    s3t:'moves',s3n:5},
  {id:50,z:5,name:'üëë FINAL BOSS', type:'boss',    diff:'nightmare',n:5,need:3,final:true,goal:'Win 3 of 5 vs NIGHTMARE',s3t:'boss',s3n:5},
];

/* puzzles: board=pre-filled, win=correct cell indices, human='X' */
const PUZZLES=[
  {board:['X','O',null,'O','X',null,null,null,null],win:[8],hint:'Diagonal 0‚Üí4‚Üí?'},
  {board:['X','X',null,'O','O',null,null,null,null],win:[2],hint:'Complete the top row!'},
  {board:[null,'O','X','O','X',null,null,null,null],win:[6],hint:'Anti-diagonal 2‚Üí4‚Üí?'},
  {board:['X',null,'O',null,'O',null,'X',null,null],win:[3],hint:'Left column 0‚Üí?‚Üí6'},
  {board:['X','O','X',null,'X','O','O',null,null],win:[8],hint:'Diagonal 0‚Üí4‚Üí8'},
  {board:['X','O','O','X',null,null,null,'O','X'],win:[6],hint:'Left column 0‚Üí3‚Üí?'},
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BACKGROUND ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function(){
  const c=document.getElementById('bgc'),x=c.getContext('2d');
  let stars=[];
  function init(){c.width=innerWidth;c.height=innerHeight;stars=Array.from({length:100},()=>({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.3+.2,speed:Math.random()*.22+.04,opacity:Math.random()*.5+.08,col:Math.random()>.5?'#00f5ff':'#ff0080'}));}
  function draw(){x.clearRect(0,0,c.width,c.height);stars.forEach(s=>{x.beginPath();x.arc(s.x,s.y,s.r,0,Math.PI*2);x.fillStyle=s.col;x.globalAlpha=s.opacity;x.fill();s.y+=s.speed;if(s.y>c.height){s.y=0;s.x=Math.random()*c.width;}});x.globalAlpha=1;requestAnimationFrame(draw);}
  window.addEventListener('resize',init);init();draw();
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFETTI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function(){
  const c=document.getElementById('cfc'),x=c.getContext('2d');
  let pts=[];
  window.launchConfetti=function(n=130){
    c.width=innerWidth;c.height=innerHeight;
    pts=Array.from({length:n},()=>({x:Math.random()*innerWidth,y:-30-Math.random()*120,vx:(Math.random()-.5)*5,vy:Math.random()*4+2,col:['#ff0080','#00f5ff','#ffd700','#00ff88','#ff8800','#aa55ff'][Math.floor(Math.random()*6)],w:Math.random()*10+4,h:Math.random()*6+3,a:Math.random()*360,sp:(Math.random()-.5)*8}));
    (function anim(){x.clearRect(0,0,c.width,c.height);let al=0;pts.forEach(p=>{if(p.y<c.height+20){al++;p.x+=p.vx;p.y+=p.vy;p.a+=p.sp;p.vy+=.06;x.save();x.translate(p.x,p.y);x.rotate(p.a*Math.PI/180);x.fillStyle=p.col;x.globalAlpha=Math.max(0,1-p.y/c.height);x.fillRect(-p.w/2,-p.h/2,p.w,p.h);x.restore();}});x.globalAlpha=1;if(al>0)requestAnimationFrame(anim);else x.clearRect(0,0,c.width,c.height);})();
  };
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let AC=null;
function ac(){if(!AC)AC=new(window.AudioContext||window.webkitAudioContext)();return AC;}
function tone(f,t,d,v=.25){try{const a=ac(),o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,a.currentTime);g.gain.exponentialRampToValueAtTime(.001,a.currentTime+d);o.start();o.stop(a.currentTime+d);}catch(e){}}
const sfx={
  place:()=>tone(440,'sine',.12,.18),
  ai:()=>tone(320,'sine',.12,.14),
  win:()=>{tone(523,'sine',.2,.25);setTimeout(()=>tone(659,'sine',.2,.25),150);setTimeout(()=>tone(784,'sine',.4,.25),300);},
  lose:()=>{tone(294,'sawtooth',.2,.18);setTimeout(()=>tone(220,'sawtooth',.3,.18),200);},
  draw:()=>tone(350,'triangle',.35,.18),
  click:()=>tone(600,'sine',.06,.1),
  lvlup:()=>{tone(440,'sine',.1,.2);setTimeout(()=>tone(550,'sine',.1,.2),100);setTimeout(()=>tone(660,'sine',.15,.2),200);setTimeout(()=>tone(880,'sine',.28,.2),300);},
  boss:()=>{tone(180,'sawtooth',.15,.28);setTimeout(()=>tone(220,'sawtooth',.28,.28),200);},
  puzzle:()=>{tone(800,'sine',.08,.2);setTimeout(()=>tone(1000,'sine',.14,.2),100);},
  tick:()=>tone(700,'sine',.05,.12),
  wrong:()=>tone(200,'sawtooth',.15,.2),
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH/USER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getUsers(){try{return JSON.parse(localStorage.getItem('xo_u')||'{}')}catch{return{}}}
function saveUsers(u){localStorage.setItem('xo_u',JSON.stringify(u))}
function getSess(){try{return JSON.parse(localStorage.getItem('xo_s')||'null')}catch{return null}}
function setSess(u){localStorage.setItem('xo_s',JSON.stringify(u))}
function clearSess(){localStorage.removeItem('xo_s')}

let CU=null;
function getUD(u){return getUsers()[u]||null}
function saveUD(d){const u=getUsers();u[d.username]=d;saveUsers(u);}

function getLvlStars(id){return CU?.levelProgress?.[id]||0}
function setLvlStars(id,stars){
  if(!CU)return;
  const old=getLvlStars(id);
  if(stars>old){if(!CU.levelProgress)CU.levelProgress={};CU.levelProgress[id]=stars;CU.totalStars=(CU.totalStars||0)+(stars-old);}
  saveUD(CU);
}
function isUnlocked(id){return id===1||getLvlStars(id-1)>0}
function doneCount(){return Object.keys(CU?.levelProgress||{}).length}
function totStars(){return CU?.totalStars||0}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN MANAGER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let curScreen='authScreen';
function showScreen(id){
  if(id===curScreen)return;
  const old=document.getElementById(curScreen);
  old.classList.add('exit');old.classList.remove('active');
  setTimeout(()=>old.classList.remove('exit'),400);
  const nxt=document.getElementById(id);
  setTimeout(()=>{nxt.classList.add('active');curScreen=id;},60);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH HANDLERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function switchTab(t){
  sfx.click();
  document.getElementById('tab-login').classList.toggle('on',t==='login');
  document.getElementById('tab-signup').classList.toggle('on',t==='signup');
  document.getElementById('form-login').classList.toggle('hidden',t!=='login');
  document.getElementById('form-signup').classList.toggle('hidden',t!=='signup');
  document.querySelectorAll('.ferr').forEach(e=>{e.classList.remove('on')});
  document.querySelectorAll('.finp').forEach(i=>i.classList.remove('err'));
}
function showErr(id,msg,fid){const e=document.getElementById(id);if(e){e.textContent=msg;e.classList.add('on');}if(fid)document.getElementById(fid)?.classList.add('err');}
function doLogin(){
  sfx.click();
  document.querySelectorAll('.ferr').forEach(e=>e.classList.remove('on'));
  const u=document.getElementById('lu').value.trim().toLowerCase();
  const p=document.getElementById('lp').value;
  if(!u||!p){showErr('lerr','Please fill in all fields','lu');return;}
  const users=getUsers();
  if(!users[u]){showErr('lerr','Account not found ‚Äî sign up first!','lu');return;}
  if(users[u].password!==btoa(p)){showErr('lerr','Incorrect password','lp');return;}
  CU=users[u];setSess({username:u});enterGame();
}
function doSignup(){
  sfx.click();
  document.querySelectorAll('.ferr').forEach(e=>e.classList.remove('on'));
  const name=document.getElementById('sn').value.trim();
  const u=document.getElementById('su').value.trim().toLowerCase();
  const p=document.getElementById('sp').value;
  let ok=true;
  if(name.length<2||name.length>20){showErr('snerr','2‚Äì20 characters','sn');ok=false;}
  if(!/^[a-z0-9_]{3,16}$/.test(u)){showErr('suerr','3-16 chars, a-z / 0-9 / _','su');ok=false;}
  if(p.length<4){showErr('sperr','Min 4 characters','sp');ok=false;}
  if(!ok)return;
  const users=getUsers();
  if(users[u]){showErr('suerr','Username already taken','su');return;}
  CU={name,username:u,password:btoa(p),created:Date.now(),levelProgress:{},totalStars:0};
  users[u]=CU;saveUsers(users);setSess({username:u});
  showToast('Welcome, '+name+'! üéâ','ok');
  enterGame();
}
function doLogout(){sfx.click();clearSess();CU=null;stopTimer();showScreen('authScreen');}
function enterGame(){sfx.win();refreshHome();showScreen('homeScreen');}
function refreshHome(){
  if(!CU)return;
  document.getElementById('homeWelcome').textContent='Welcome back, '+CU.name+'!';
  document.getElementById('homeProg').textContent=doneCount()+'/50';
  document.getElementById('homeStars').textContent=totStars();
}
function toHome(){sfx.click();showScreen('homeScreen');refreshHome();}
function goCampaign(){sfx.click();renderMap();showScreen('mapScreen');}
function goQuick(){sfx.click();startQuick();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEVEL MAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderMap(){
  document.getElementById('mapDone').textContent=doneCount();
  document.getElementById('mapStars').textContent=totStars();
  const cont=document.getElementById('mapContent');cont.innerHTML='';
  for(let z=1;z<=5;z++){
    const zls=LEVELS.filter(l=>l.z===z);
    const zs=zls.reduce((a,l)=>a+getLvlStars(l.id),0);
    const div=document.createElement('div');div.className='zone z'+z;
    div.innerHTML=`<div class="zhdr"><span class="znum">ZONE ${z}</span><span class="zname">${ZEMOJI[z]} ${ZNAMES[z]}</span><span class="zstars">‚òÖ ${zs}/${zls.length*3}</span></div><div class="zgrid" id="zg${z}"></div>`;
    cont.appendChild(div);
    const grid=div.querySelector('#zg'+z);
    zls.forEach(lvl=>{
      const unl=isUnlocked(lvl.id),stars=getLvlStars(lvl.id),done=stars>0;
      const tile=document.createElement('div');
      tile.className='ltile'+(lvl.boss?' boss':'')+(done?' done':'')+(unl?'':' locked');
      if(unl)tile.onclick=()=>{sfx.click();startLevel(lvl.id);};
      const ico=lvl.boss?(lvl.final?'üëë':'‚ö°'):{puzzle:'üß©',time:'‚è±Ô∏è',moves:'‚ö°',nocenter:'üö´',nocorners:'üö´',norow:'üö´',noedge:'üö´',centeronly:'üè†',cornersonly:'üî≤',win:'‚öîÔ∏è',boss:'‚ö°'}[lvl.type]||'‚öîÔ∏è';
      let sh='';for(let i=1;i<=3;i++)sh+=`<span class="lst${i<=stars?' on':''}"">‚òÖ</span>`;
      tile.innerHTML=unl?`<div class="lico">${ico}</div><div class="lnum">${lvl.id}</div><div class="lstars">${sh}</div>`:`<div class="llock">üîí</div><div style="font-size:.58rem;color:var(--muted);margin-top:3px">${lvl.id}</div>`;
      grid.appendChild(tile);
    });
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME VARS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const WLINES=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
let gBoard,gActive,gTurn,gHuman,gAI,gDiff,gForbidden;
let gMoves,gElapsed,gTimerInt;
let gCamp,gLvlId,gLvl;
let gBoss;
let gPuzz;

function getForbidden(lvl){
  if(!lvl)return[];
  switch(lvl.type){
    case'nocenter':return[4];
    case'nocorners':return[0,2,6,8];
    case'noedge':return[1,3,5,7];
    case'norow':return Array.from({length:3},(_,i)=>lvl.row*3+i);
    case'centeronly':return[1,3,5,7];  // only center(4)+corners(0,2,6,8) allowed ‚Üí forbid edges
    case'cornersonly':return[1,3,4,5,7]; // only corners ‚Üí forbid center+edges
    default:return[];
  }
}

function checkWin(b){
  for(const[a,c,d]of WLINES)if(b[a]&&b[a]===b[c]&&b[a]===b[d])return{winner:b[a],line:[a,c,d]};
  return b.includes(null)?null:{winner:'draw',line:[]};
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI MINIMAX ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function minimax(b,depth,isMax,alpha,beta){
  const r=checkWin(b);
  if(r){if(r.winner===gAI)return 10-depth;if(r.winner===gHuman)return depth-10;return 0;}
  const avail=b.map((v,i)=>v===null&&!gForbidden.includes(i)?i:-1).filter(i=>i>=0);
  if(!avail.length)return 0;
  if(isMax){
    let best=-Infinity;
    for(const i of avail){b[i]=gAI;best=Math.max(best,minimax(b,depth+1,false,alpha,beta));b[i]=null;alpha=Math.max(alpha,best);if(beta<=alpha)break;}
    return best;
  }else{
    let best=Infinity;
    for(const i of avail){b[i]=gHuman;best=Math.min(best,minimax(b,depth+1,true,alpha,beta));b[i]=null;beta=Math.min(beta,best);if(beta<=alpha)break;}
    return best;
  }
}
function getAIMove(b){
  const avail=b.map((v,i)=>v===null&&!gForbidden.includes(i)?i:-1).filter(i=>i>=0);
  if(!avail.length)return-1;
  const rnd={beginner:.85,easy:.65,normal:.35,hard:0,nightmare:0}[gDiff]??0;
  if(Math.random()<rnd)return avail[Math.floor(Math.random()*avail.length)];
  if(gDiff==='nightmare'&&b[4]===null&&!gForbidden.includes(4))return 4;
  let best=-Infinity,mv=avail[0];
  for(const i of avail){b[i]=gAI;const s=minimax(b,0,false,-Infinity,Infinity);b[i]=null;if(s>best){best=s;mv=i;}}
  return mv;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SVG MARKS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function svgX(){return`<svg viewBox="0 0 100 100" fill="none"><line x1="20" y1="20" x2="80" y2="80" stroke="var(--x)" stroke-width="13" stroke-linecap="round"/><line x1="80" y1="20" x2="20" y2="80" stroke="var(--x)" stroke-width="13" stroke-linecap="round"/></svg>`;}
function svgO(){return`<svg viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="32" stroke="var(--o)" stroke-width="13"/></svg>`;}
function svgMark(v){return v==='X'?svgX():svgO();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOARD RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildBoard(){
  const el=document.getElementById('board');el.innerHTML='';
  for(let i=0;i<9;i++){
    const c=document.createElement('div');c.className='cell';
    // forbidden cells
    if(gForbidden.includes(i))c.classList.add('forb');
    // puzzle pre-fill
    if(gPuzz&&gPuzz.board[i]){c.classList.add('taken');c.innerHTML=svgMark(gPuzz.board[i]);requestAnimationFrame(()=>c.classList.add('revealed'));}
    c.addEventListener('click',()=>onCell(i));
    el.appendChild(c);
  }
}
function renderBoard(){
  const cells=document.querySelectorAll('.cell');
  cells.forEach((c,i)=>{
    const v=gBoard[i],forb=gForbidden.includes(i);
    const canClick=gActive&&!v&&!forb&&gTurn===gHuman;
    c.className='cell'+(forb?' forb':'')+(v?' taken':'')+(canClick?'':v||forb?' locked':'');
    if(v){c.innerHTML=svgMark(v);requestAnimationFrame(()=>c.classList.add('revealed'));}
    else if(!forb)c.innerHTML='';
  });
}
function highlightWin(line){document.querySelectorAll('.cell').forEach((c,i)=>{if(line.includes(i))c.classList.add('wc');});}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATUS BAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setStatus(state,txt='',sub=''){
  const bar=document.getElementById('sbar'),ico=document.getElementById('sico'),main=document.getElementById('smain'),ss=document.getElementById('ssub');
  bar.className='sbar';
  if(state==='human'){
    bar.classList.add('xt');ico.className='sico '+(gHuman==='X'?'xic':'oic');ico.textContent=gHuman;
    main.textContent='Your turn';ss.textContent='Click a cell to play';
  }else if(state==='ai'){
    bar.classList.add('ot');ico.className='sico oic';ico.textContent=gAI;
    main.innerHTML='AI thinking<span class="tdots"><span></span><span></span><span></span></span>';ss.textContent=gDiff.toUpperCase()+' difficulty';
  }else if(state==='puzzle'){
    bar.classList.add('xt');ico.className='sico xic';ico.textContent='?';
    main.textContent='Find the winning move!';ss.textContent='Hint: '+txt;
  }else if(state==='win'){
    bar.classList.add('win');ico.className='sico stic';ico.textContent='‚òÖ';
    main.textContent=txt;ss.textContent=sub;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function stopTimer(){clearInterval(gTimerInt);gTimerInt=null;}
function startTimer(limit){
  gElapsed=0;stopTimer();
  document.getElementById('htimercell').classList.remove('hidden');
  document.getElementById('htimersep').classList.remove('hidden');
  document.getElementById('htimer').textContent=limit;
  gTimerInt=setInterval(()=>{
    if(!gActive){stopTimer();return;}
    gElapsed++;
    const rem=limit-gElapsed;
    const el=document.getElementById('htimer');
    el.textContent=rem;el.className='hval'+(rem<=5?' tdanger':'');
    if(rem<=5)sfx.tick();
    if(rem<=0){stopTimer();gActive=false;setStatus('win','‚è∞ Time Up!','Clock beat you!');setTimeout(()=>showFail("‚è∞ Time's Up!","The clock ran out ‚Äî retry!"),600);}
  },1000);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HUD SETUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setupHUD(lvl){
  const hud=document.getElementById('hud');
  if(!gCamp||!lvl){hud.classList.add('hidden');return;}
  hud.classList.remove('hidden');
  document.getElementById('hlvl').textContent='L'+lvl.id;
  document.getElementById('hobj').textContent=lvl.goal;
  document.getElementById('glabel').textContent='LEVEL '+lvl.id+' ‚Äî '+lvl.name;
  // hide optional cells first
  ['htimercell','htimersep','hmovescell','hmovessep'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  if(lvl.type==='time'){
    document.getElementById('htimer').textContent=lvl.n;
  }
  if(lvl.type==='moves'||lvl.type==='puzzle'){
    document.getElementById('hmovescell').classList.remove('hidden');
    document.getElementById('hmovessep').classList.remove('hidden');
    document.getElementById('hmoves').textContent='0'+(lvl.n?'/'+lvl.n:'');
  }
}
function setupBossUI(lvl){
  const tr=document.getElementById('btracker');
  if(!lvl||lvl.type!=='boss'){tr.classList.remove('on');return;}
  tr.classList.add('on');
  document.getElementById('bneed').textContent='WIN '+lvl.need+'/'+lvl.n;
  renderPips(lvl);
}
function renderPips(lvl){
  const pc=document.getElementById('bpips');pc.innerHTML='';
  for(let i=0;i<lvl.n;i++){
    const p=document.createElement('div');p.className='bpip';
    if(i<gBoss.results.length){const r=gBoss.results[i];p.classList.add(r==='win'?'wp':'lp');p.textContent=r==='win'?'W':'L';}
    else p.textContent=i+1;
    pc.appendChild(p);
  }
  document.getElementById('blbl').textContent='ROUND '+(gBoss.round+1);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê START GAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function resetVars(){
  stopTimer();gBoard=Array(9).fill(null);gActive=false;
  gMoves=0;gElapsed=0;gTurn='X';gPuzz=null;gForbidden=[];
}

function startLevel(id){
  const lvl=LEVELS.find(l=>l.id===id);if(!lvl)return;
  gCamp=true;gLvlId=id;gLvl=lvl;
  resetVars();
  gHuman='X';gAI='O';gDiff=lvl.diff||'normal';
  gForbidden=getForbidden(lvl);
  if(lvl.type==='boss')gBoss={wins:0,losses:0,round:0,results:[]};
  if(lvl.type==='puzzle'){gPuzz=PUZZLES[lvl.puzz];gBoard=[...gPuzz.board];}
  document.getElementById('qpset').classList.remove('on');
  setupHUD(lvl);setupBossUI(lvl);
  showScreen('gameScreen');
  setTimeout(()=>beginRound(lvl),320);
}

function startQuick(){
  gCamp=false;gLvl=null;gLvlId=0;
  resetVars();gHuman='X';gAI='O';gDiff='normal';gForbidden=[];
  document.getElementById('hud').classList.add('hidden');
  document.getElementById('btracker').classList.remove('on');
  document.getElementById('qpset').classList.add('on');
  document.getElementById('glabel').textContent='QUICK PLAY';
  // reset qp button states
  document.getElementById('qpX').classList.add('on');
  document.getElementById('qpO').classList.remove('on');
  document.getElementById('qpNorm').classList.add('on');
  showScreen('gameScreen');
  setTimeout(()=>beginRound(null),320);
}

function beginRound(lvl){
  gActive=true;gTurn='X';gMoves=0;
  if(!gPuzz)gBoard=Array(9).fill(null);
  buildBoard();

  if(lvl&&lvl.type==='puzzle'){setStatus('puzzle',gPuzz.hint);return;}

  // Does AI go first?
  const aiFirst=!!(lvl?.aiFirst)||(gHuman==='O');
  if(aiFirst){
    gTurn=gAI;setStatus('ai');
    setTimeout(doAI,600);
    return;
  }
  setStatus('human');
  if(lvl?.type==='time')startTimer(lvl.n);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CELL CLICK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function onCell(i){
  if(!gActive)return;
  if(gBoard[i])return;
  if(gForbidden.includes(i))return;

  // ‚îÄ‚îÄ PUZZLE ‚îÄ‚îÄ
  if(gPuzz){
    if(gPuzz.win.includes(i)){
      sfx.puzzle();gBoard[i]=gHuman;
      const cells=document.querySelectorAll('.cell');
      cells[i].innerHTML=svgX();requestAnimationFrame(()=>cells[i].classList.add('revealed'));
      gActive=false;
      // highlight win line
      for(const[a,b,c]of WLINES)if(gBoard[a]&&gBoard[a]===gBoard[b]&&gBoard[a]===gBoard[c]){highlightWin([a,b,c]);break;}
      setStatus('win','üß© Puzzle Solved!','Perfect move!');
      setLvlStars(gLvlId,3);
      setTimeout(()=>{sfx.lvlup();launchConfetti(90);showWin(3,gLvl);},650);
    }else{
      // wrong cell ‚Äî flash red, keep playing
      const cells=document.querySelectorAll('.cell');
      cells[i].style.background='rgba(255,68,68,.16)';
      setTimeout(()=>cells[i].style.background='',500);
      sfx.wrong();showToast('Wrong cell ‚Äî think again!','err');
    }
    return;
  }

  // ‚îÄ‚îÄ NORMAL GAME ‚îÄ‚îÄ
  if(gTurn!==gHuman)return;
  sfx.place();
  gBoard[i]=gHuman;gMoves++;

  // update moves display
  if(gCamp&&gLvl?.type==='moves'){
    document.getElementById('hmoves').textContent=gMoves+(gLvl.n?'/'+gLvl.n:'');
  }

  renderBoard();
  const r=checkWin(gBoard);
  if(r){stopTimer();onEnd(r);return;}

  // moves limit exceeded ‚Üí auto fail
  if(gCamp&&gLvl?.type==='moves'&&gMoves>=gLvl.n){
    const full=!gBoard.includes(null);
    if(!full){stopTimer();gActive=false;setStatus('win','‚ö° Move Limit Reached!','Used too many moves!');setTimeout(()=>showFail('Move Limit Reached!','You used more than '+gLvl.n+' moves ‚Äî retry!'),700);return;}
  }

  gTurn=gAI;setStatus('ai');
  const delay={beginner:200,easy:280,normal:380,hard:500,nightmare:640}[gDiff]||380;
  setTimeout(doAI,delay);
}

function doAI(){
  if(!gActive)return;
  const mv=getAIMove([...gBoard]);
  if(mv<0){stopTimer();onEnd(checkWin(gBoard)||{winner:'draw',line:[]});return;}
  sfx.ai();gBoard[mv]=gAI;renderBoard();
  const r=checkWin(gBoard);
  if(r){stopTimer();onEnd(r);return;}
  gTurn=gHuman;setStatus('human');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME END ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function onEnd(r){
  gActive=false;
  const isWin=r.winner===gHuman,isDraw=r.winner==='draw';
  if(r.line.length)highlightWin(r.line);
  if(isWin)sfx.win();else if(isDraw)sfx.draw();else sfx.lose();
  setStatus('win',isWin?'üéâ You Win!':(isDraw?"ü§ù It's a Draw!":'ü§ñ AI Wins!'),isWin?'Great strategy!':(isDraw?'Perfectly balanced':'AI outplayed you'));
  if(gCamp&&gLvl){
    if(gLvl.type==='boss')handleBoss(isWin);
    else evalCamp(isWin,isDraw);
  }else{
    if(isWin)launchConfetti(80);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAMPAIGN EVALUATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function evalCamp(isWin,isDraw){
  const lvl=gLvl;
  if(!isWin){
    const msgs={moves:'Win within the move limit to pass!',time:'You needed to win before time ran out!',nocenter:'Win the game (without using center)!',nocorners:'Win the game (without using corners)!',norow:'Win the game (without forbidden row)!',noedge:'Win the game (without edges)!',centeronly:'Win (only center & corners allowed)!',cornersonly:'Win (only corners allowed)!',win:isDraw?'You need a WIN ‚Äî draw is not enough!':'The AI won ‚Äî retry!',puzzle:'Find the correct winning move!'};
    setTimeout(()=>showFail('Level Failed!',msgs[lvl.type]||'Try again!'),800);
    return;
  }
  // win ‚Äî calc stars
  let stars=2;
  if(lvl.s3t==='moves'&&gMoves<=lvl.s3n)stars=3;
  else if(lvl.s3t==='time'&&gElapsed<=lvl.s3n)stars=3;
  else if(lvl.s3t==='instant')stars=3; // puzzle always 3 if solved (handled above)
  setLvlStars(lvl.id,stars);
  sfx.lvlup();launchConfetti(120);
  setTimeout(()=>showWin(stars,lvl),850);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOSS BATTLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function handleBoss(isWin){
  const lvl=gLvl;
  gBoss.round++;
  if(isWin)gBoss.wins++;else gBoss.losses++;
  gBoss.results.push(isWin?'win':'loss');
  renderPips(lvl);

  const canWin=gBoss.wins>=lvl.need;
  const cannotWin=gBoss.losses>(lvl.n-lvl.need);
  const allDone=gBoss.round>=lvl.n;

  if(canWin){
    const stars=gBoss.wins===lvl.n?3:2;
    setLvlStars(lvl.id,stars);
    sfx.lvlup();launchConfetti(160);
    setTimeout(()=>showWin(stars,lvl,true),900);
  }else if(cannotWin||allDone){
    sfx.boss();
    setTimeout(()=>showFail('Boss Defeated You!','Got '+gBoss.wins+'/'+lvl.need+' wins needed ‚Äî retry!'),800);
  }else{
    // next round
    const banner=document.getElementById('rbanner'),txt=document.getElementById('rbtxt');
    txt.textContent='ROUND '+(gBoss.round+1);banner.className='rbanner on';
    setTimeout(()=>banner.className='rbanner',1900);
    setTimeout(()=>{
      gBoard=Array(9).fill(null);gActive=true;gTurn='X';gMoves=0;
      buildBoard();renderBoard();
      const af=gHuman==='O';
      if(af){gTurn=gAI;setStatus('ai');setTimeout(doAI,600);}else setStatus('human');
    },2000);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OVERLAYS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showWin(stars,lvl,boss=false){
  const ov=document.getElementById('ov-win');
  document.getElementById('oe').textContent=stars===3?'üèÜ':(boss?'‚ö°':'üéâ');
  document.getElementById('ot').textContent=boss?'Boss Defeated!':(stars===3?'‚≠ê Perfect!':'Level Complete!');
  document.getElementById('os').textContent=stars===3?'Maximum stars! You are unstoppable!':(stars===2?'Well done! Can you earn 3 stars?':'You passed ‚Äî keep going!');
  const s1=document.getElementById('os1'),s2=document.getElementById('os2'),s3=document.getElementById('os3');
  [s1,s2,s3].forEach(s=>s.className='ostar');
  setTimeout(()=>{if(stars>=1)s1.classList.add('on');},280);
  setTimeout(()=>{if(stars>=2)s2.classList.add('on');},420);
  setTimeout(()=>{if(stars>=3)s3.classList.add('on');},560);
  const nxt=LEVELS.find(l=>l.id===(lvl?.id||0)+1);
  document.getElementById('btnNext').style.display=nxt?'':'none';
  ov.classList.add('on');
}
function showFail(title,sub){
  document.getElementById('ft').textContent=title;
  document.getElementById('fs').textContent=sub;
  document.getElementById('ov-fail').classList.add('on');
}
function closeOv(which){sfx.click();document.getElementById('ov-'+which).classList.remove('on');renderMap();showScreen('mapScreen');}
function retryFromOv(which){sfx.click();document.getElementById('ov-'+which).classList.remove('on');retryLevel();}
function nextLevel(){
  sfx.click();document.getElementById('ov-win').classList.remove('on');
  const nxt=LEVELS.find(l=>l.id===gLvlId+1);
  if(nxt)startLevel(nxt.id);else{renderMap();showScreen('mapScreen');}
}
function retryLevel(){
  stopTimer();
  document.getElementById('ov-win').classList.remove('on');
  document.getElementById('ov-fail').classList.remove('on');
  if(gCamp&&gLvl){
    if(gLvl.type==='boss')gBoss={wins:0,losses:0,round:0,results:[]};
    resetVars();
    gHuman='X';gAI='O';gDiff=gLvl.diff||'normal';gForbidden=getForbidden(gLvl);
    if(gLvl.type==='puzzle'){gPuzz=PUZZLES[gLvl.puzz];gBoard=[...gPuzz.board];}
    setupBossUI(gLvl.type==='boss'?gLvl:null);
    setTimeout(()=>beginRound(gLvl),80);
  }else{
    gBoard=Array(9).fill(null);gActive=true;gTurn='X';gMoves=0;
    buildBoard();
    if(gHuman==='O'){gTurn=gAI;setStatus('ai');setTimeout(doAI,600);}else setStatus('human');
  }
}
function goBackFromGame(){
  sfx.click();stopTimer();gActive=false;
  document.getElementById('ov-win').classList.remove('on');
  document.getElementById('ov-fail').classList.remove('on');
  if(gCamp){renderMap();showScreen('mapScreen');}else{showScreen('homeScreen');}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QUICK PLAY CONTROLS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function qpSide(s,btn){
  sfx.click();gHuman=s;gAI=s==='X'?'O':'X';
  document.getElementById('qpX').classList.toggle('on',s==='X');
  document.getElementById('qpO').classList.toggle('on',s==='O');
  gBoard=Array(9).fill(null);gActive=true;gTurn='X';gMoves=0;
  buildBoard();renderBoard();
  if(gHuman==='O'){gTurn=gAI;setStatus('ai');setTimeout(doAI,600);}else setStatus('human');
}
function qpDiff(d,btn){
  sfx.click();gDiff=d;
  document.querySelectorAll('.qpbtn').forEach(b=>{if(['Baby','Easy','Normal','Hard','üíÄ Max'].some(t=>b.textContent.includes(t.split(' ').pop())))b.classList.remove('on');});
  btn.classList.add('on');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showToast(msg,type=''){
  const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+type+' on';
  clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),2800);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê KEYBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.addEventListener('keydown',e=>{
  if(e.key!=='Enter')return;
  if(document.getElementById('authScreen').classList.contains('active')){
    const login=!document.getElementById('form-login').classList.contains('hidden');
    if(login)doLogin();else doSignup();
  }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTO-LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.addEventListener('load',()=>{
  const sess=getSess();
  if(sess?.username){const d=getUD(sess.username);if(d){CU=d;enterGame();return;}}
});
</script>
</body>
</html>
