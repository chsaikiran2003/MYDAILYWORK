<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RuleBot ‚Äî Powered by AI</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
[data-theme="dark"]{--bg:#0b0d13;--sidebar:#0e1018;--surface:#161922;--surface2:#1d2132;--border:rgba(255,255,255,0.06);--border2:rgba(255,255,255,0.10);--accent:#6c63ff;--accent2:#8b85ff;--accent3:#4a43cc;--green:#22c55e;--teal:#2dd4bf;--pink:#f472b6;--text:#e2e4f0;--muted:#4a5068;--muted2:#6b7494;--user-bg:#181c2e;--card:#0f111a;--shadow:rgba(0,0,0,0.6);--code-bg:#070a10;}
[data-theme="light"]{--bg:#f3f4f9;--sidebar:#ffffff;--surface:#ffffff;--surface2:#eef0f8;--border:rgba(0,0,0,0.07);--border2:rgba(0,0,0,0.12);--accent:#6c63ff;--accent2:#5550dd;--accent3:#4a43cc;--green:#16a34a;--teal:#0d9488;--pink:#db2777;--text:#1a1d2e;--muted:#9ba3b8;--muted2:#6b7280;--user-bg:#eef0fa;--card:#f5f6fc;--shadow:rgba(0,0,0,0.1);--code-bg:#1e2235;}
:root{--serif:'Instrument Serif',Georgia,serif;--sans:'DM Sans',system-ui,sans-serif;--sidebar-w:262px;}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:var(--sans);display:flex;font-size:15px;transition:background .25s,color .25s}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
#mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);z-index:99}
@media(max-width:768px){.sidebar{position:fixed!important;left:-100%!important;top:0;height:100vh;z-index:100;transition:left .3s}.sidebar.open{left:0!important}#mob-overlay.show{display:block}.topbar{padding:10px 14px!important}.mob-menu-btn{display:grid!important}.msg-group{padding:14px 14px!important}.input-zone{padding:6px 14px 14px!important}}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);backdrop-filter:blur(6px);z-index:200;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex;animation:fadeIn .18s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:26px;width:100%;max-width:440px;animation:slideUp .22s ease;box-shadow:0 24px 80px var(--shadow);max-height:90vh;overflow-y:auto}
@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.modal-title{font-family:var(--serif);font-size:1.15rem;color:var(--text)}
.modal-close{width:30px;height:30px;background:var(--surface2);border:none;border-radius:8px;color:var(--muted2);cursor:pointer;font-size:17px;display:grid;place-items:center;transition:.15s}
.modal-close:hover{background:var(--border2);color:var(--text)}
.modal-section{margin-bottom:18px}
.modal-label{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:9px}
.modal-row{display:flex;align-items:center;justify-content:space-between;padding:11px 13px;background:var(--card);border:1px solid var(--border);border-radius:10px;margin-bottom:7px;transition:.15s;gap:10px}
.modal-row:hover{border-color:var(--border2)}
.modal-row-label{font-size:.84rem;color:var(--text);font-weight:500}
.modal-row-sub{font-size:.7rem;color:var(--muted);margin-top:2px}
.toggle{width:40px;height:22px;background:var(--surface2);border-radius:11px;cursor:pointer;position:relative;transition:background .2s;border:none;flex-shrink:0}
.toggle.on{background:var(--accent)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 4px rgba(0,0,0,.3)}
.toggle.on::after{transform:translateX(18px)}
.sdot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.sdot.g{background:var(--green);box-shadow:0 0 7px rgba(34,197,94,.6)}
.sdot.y{background:#facc15;box-shadow:0 0 7px rgba(250,204,21,.5)}
.share-link-box{display:flex;gap:8px;margin-top:8px}
.share-link-input{flex:1;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:9px 13px;color:var(--muted2);font-size:.81rem;font-family:var(--sans);outline:none}
.copy-btn{padding:9px 15px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:.81rem;font-weight:600;cursor:pointer;font-family:var(--sans);transition:.15s;white-space:nowrap}
.copy-btn:hover{background:var(--accent2)}
.share-opts{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.share-opt{padding:12px;background:var(--card);border:1px solid var(--border);border-radius:10px;text-align:center;cursor:pointer;font-size:.79rem;color:var(--muted2);transition:.15s;font-family:var(--sans);font-weight:500}
.share-opt:hover{border-color:var(--accent);color:var(--accent);background:rgba(108,99,255,.07)}
.share-opt-icon{font-size:1.35rem;display:block;margin-bottom:4px}
.sidebar{width:var(--sidebar-w);background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;height:100vh;overflow:hidden;transition:background .25s}
.ai-status-bar{display:flex;align-items:center;gap:7px;padding:7px 14px;background:rgba(108,99,255,.07);border-bottom:1px solid rgba(108,99,255,.13);font-size:.67rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--accent2)}
.ai-status-bar .pulse{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 7px var(--green);animation:pa 2s infinite}
@keyframes pa{0%,100%{opacity:1}50%{opacity:.4}}
#eslabel{color:var(--muted2);font-weight:500}
.sidebar-logo{padding:14px 16px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.logo-mark{width:32px;height:32px;background:linear-gradient(145deg,var(--accent),var(--pink));border-radius:9px;display:grid;place-items:center;color:#fff;font-size:15px;flex-shrink:0;box-shadow:0 4px 14px rgba(108,99,255,.4)}
.logo-text{font-family:var(--serif);font-size:1.08rem;color:var(--text)}
.logo-text em{color:var(--accent);font-style:normal}
.logo-ver{margin-left:auto;font-size:.62rem;font-weight:700;padding:2px 7px;background:rgba(108,99,255,.12);border:1px solid rgba(108,99,255,.22);border-radius:20px;color:var(--accent2)}
.new-chat-btn{margin:10px 10px 6px;padding:9px 13px;background:linear-gradient(135deg,var(--accent),var(--accent3));border:none;border-radius:10px;color:#fff;font-family:var(--sans);font-size:.82rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:7px;transition:.2s;box-shadow:0 4px 14px rgba(108,99,255,.35)}
.new-chat-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(108,99,255,.5)}
.new-chat-btn svg{width:13px;height:13px;stroke:#fff;fill:none;stroke-width:2.5}
.sidebar-section{padding:13px 13px 4px;font-size:.64rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--muted)}
.chat-history{flex:1;overflow-y:auto;padding:3px 7px}
.history-item{padding:8px 11px;border-radius:8px;font-size:.8rem;color:var(--muted2);cursor:pointer;transition:.15s;display:flex;align-items:center;gap:7px;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.history-item:hover{background:var(--surface2);color:var(--text)}
.history-item.active{background:rgba(108,99,255,.13);color:var(--accent);font-weight:500}
.history-item svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:1.8;flex-shrink:0;opacity:.65}
.htime{margin-left:auto;font-size:.61rem;color:var(--muted);flex-shrink:0}
.sidebar-footer{padding:10px;border-top:1px solid var(--border)}
.model-badge{display:flex;align-items:center;gap:9px;padding:10px 12px;background:var(--surface2);border:1px solid var(--border2);border-radius:10px}
.model-name{font-size:.76rem;font-weight:600;color:var(--text)}
.model-sub{font-size:.65rem;color:var(--muted);margin-top:1px}
.main{flex:1;display:flex;flex-direction:column;height:100vh;overflow:hidden;min-width:0}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 22px;border-bottom:1px solid var(--border);background:rgba(11,13,19,0.9);backdrop-filter:blur(16px);flex-shrink:0;z-index:10;transition:background .25s}
[data-theme="light"] .topbar{background:rgba(243,244,249,0.92)}
.topbar-left{display:flex;align-items:center;gap:10px}
.mob-menu-btn{display:none;width:32px;height:32px;border:1px solid var(--border2);background:var(--surface);border-radius:8px;cursor:pointer;place-items:center;color:var(--muted2);flex-shrink:0}
.topbar-title{font-family:var(--serif);font-size:.96rem;color:var(--muted2);max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ai-pill{display:flex;align-items:center;gap:5px;padding:3px 9px;background:rgba(108,99,255,.09);border:1px solid rgba(108,99,255,.2);border-radius:20px;font-size:.64rem;font-weight:700;color:var(--accent2);letter-spacing:.05em;text-transform:uppercase;white-space:nowrap}
.ai-pill .dot{width:5px;height:5px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green);animation:pa 2s infinite}
.topbar-actions{display:flex;gap:6px}
.icon-btn{width:34px;height:34px;border:1px solid var(--border2);background:var(--surface);border-radius:8px;display:grid;place-items:center;cursor:pointer;transition:.15s;color:var(--muted2);flex-shrink:0;position:relative}
.icon-btn:hover{background:var(--surface2);border-color:var(--accent);color:var(--accent)}
.icon-btn svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:1.8}
.icon-btn[title]:hover::after{content:attr(title);position:absolute;top:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border2);border-radius:6px;padding:4px 9px;font-size:.67rem;color:var(--text);white-space:nowrap;pointer-events:none;z-index:50;font-family:var(--sans)}
#chat{flex:1;overflow-y:auto;scroll-behavior:smooth;padding-bottom:8px}
#welcome{max-width:680px;margin:44px auto 0;padding:0 28px;animation:fadeUp .45s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.welcome-eyebrow{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--accent);margin-bottom:11px;display:flex;align-items:center;gap:8px}
.welcome-eyebrow::before{content:'';width:16px;height:2px;background:linear-gradient(90deg,var(--accent),var(--pink));border-radius:2px}
.welcome-greeting{font-family:var(--serif);font-size:2.5rem;color:var(--text);line-height:1.16;margin-bottom:11px;letter-spacing:-.025em}
.welcome-greeting span{background:linear-gradient(120deg,var(--accent),var(--pink),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-style:italic}
.welcome-sub{color:var(--muted2);font-size:.88rem;line-height:1.72;margin-bottom:28px;max-width:500px}
.suggestion-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px}
@media(max-width:480px){.suggestion-grid{grid-template-columns:1fr}}
.sug-card{background:var(--card);border:1px solid var(--border);border-radius:13px;padding:16px;cursor:pointer;transition:.22s;text-align:left;font-family:var(--sans)}
.sug-card:hover{background:var(--surface2);border-color:var(--accent);box-shadow:0 0 0 1px var(--accent),0 8px 28px rgba(108,99,255,.15);transform:translateY(-2px)}
.sug-icon{font-size:1.4rem;margin-bottom:8px;display:block}
.sug-title{font-size:.82rem;font-weight:600;color:var(--text);margin-bottom:3px}
.sug-desc{font-size:.71rem;color:var(--muted);line-height:1.48}
.msg-group{max-width:740px;margin:0 auto;padding:18px 28px;animation:fadeUp .22s ease both}
.msg-row{display:flex;gap:12px;align-items:flex-start;margin-bottom:4px}
.msg-row.user-row{flex-direction:row-reverse}
.av{width:34px;height:34px;border-radius:9px;flex-shrink:0;display:grid;place-items:center;font-size:14px;margin-top:2px}
.av.bot-av{background:linear-gradient(145deg,var(--accent),var(--pink));box-shadow:0 4px 14px rgba(108,99,255,.35);color:#fff;font-size:16px}
.av.user-av{background:var(--surface2);border:1px solid var(--border2);color:var(--muted2)}
.msg-content{flex:1;min-width:0}
.msg-meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.msg-name{font-size:.69rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
.msg-time{font-size:.61rem;color:var(--muted);opacity:.7}
.user-row .msg-meta{flex-direction:row-reverse}
.user-bubble{display:inline-block;float:right;clear:both;background:var(--user-bg);border:1px solid rgba(108,99,255,.18);padding:12px 16px;border-radius:15px 15px 3px 15px;font-size:.9rem;line-height:1.72;max-width:82%;word-break:break-word;color:var(--text)}
.bot-bubble{font-size:.9rem;line-height:1.78;color:var(--text);word-break:break-word}
.bot-bubble h1,.bot-bubble h2,.bot-bubble h3{font-family:var(--serif);font-weight:400;color:var(--text);margin:15px 0 7px}
.bot-bubble h1{font-size:1.42em}.bot-bubble h2{font-size:1.18em}.bot-bubble h3{font-size:1.03em}
.bot-bubble p{margin:7px 0}
.bot-bubble ul,.bot-bubble ol{padding-left:20px;margin:7px 0}
.bot-bubble li{margin:4px 0}
.bot-bubble strong{font-weight:700;color:var(--text)}
.bot-bubble em{font-style:italic;color:var(--muted2)}
.bot-bubble a{color:var(--accent);text-decoration:none;border-bottom:1px solid rgba(108,99,255,.3)}
.bot-bubble blockquote{border-left:3px solid var(--accent);padding:8px 14px;margin:10px 0;background:rgba(108,99,255,.05);border-radius:0 8px 8px 0;color:var(--muted2);font-style:italic}
.bot-bubble hr{border:none;border-top:1px solid var(--border);margin:14px 0}
.bot-bubble code{font-family:'JetBrains Mono','Fira Code',monospace;background:var(--surface2);border:1px solid var(--border2);padding:1px 6px;border-radius:4px;font-size:.8em;color:var(--teal)}
.bot-bubble .pre-wrap{background:var(--code-bg);border:1px solid var(--border2);border-radius:11px;margin:12px 0;overflow:hidden}
.pre-header{display:flex;align-items:center;justify-content:space-between;padding:7px 14px;border-bottom:1px solid var(--border);font-size:.68rem;color:var(--muted2);font-family:var(--sans)}
.pre-copy{padding:3px 9px;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;font-size:.65rem;cursor:pointer;color:var(--muted2);font-family:var(--sans);transition:.15s}
.pre-copy:hover{background:var(--border2);color:var(--text)}
.bot-bubble pre{background:transparent;border:none;border-radius:0;margin:0;padding:0}
.bot-bubble pre code{display:block;padding:14px 16px;background:none;border:none;color:#7dd3fc;font-size:.82em;line-height:1.64;overflow-x:auto}
.bot-bubble table{width:100%;border-collapse:collapse;margin:10px 0;font-size:.83em}
.bot-bubble th,.bot-bubble td{border:1px solid var(--border2);padding:8px 12px;text-align:left}
.bot-bubble th{background:var(--surface2);font-weight:600}
.msg-actions{display:flex;gap:4px;margin-top:9px;opacity:0;transition:opacity .15s;flex-wrap:wrap}
.msg-group:hover .msg-actions{opacity:1}
.act-btn{padding:4px 9px;background:transparent;border:1px solid var(--border2);border-radius:6px;font-size:.67rem;color:var(--muted2);cursor:pointer;font-family:var(--sans);display:flex;align-items:center;gap:4px;transition:.15s}
.act-btn:hover{background:var(--surface2);color:var(--text);border-color:var(--accent)}
.act-btn.liked{color:var(--green);border-color:var(--green);background:rgba(34,197,94,.07)}
.act-btn.disliked{color:#f87171;border-color:#f87171;background:rgba(248,113,113,.07)}
.act-btn svg{width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2}
.engine-tag{display:inline-flex;align-items:center;gap:4px;margin-top:6px;padding:2px 8px;border-radius:20px;font-size:.61rem;font-weight:600;letter-spacing:.04em;text-transform:uppercase;border:1px solid;opacity:.6}
.engine-tag.e1{color:#a78bfa;border-color:rgba(167,139,250,.3);background:rgba(167,139,250,.07)}
.engine-tag.e2{color:#34d399;border-color:rgba(52,211,153,.3);background:rgba(52,211,153,.07)}
.engine-tag.e3{color:#60a5fa;border-color:rgba(96,165,250,.3);background:rgba(96,165,250,.07)}
.engine-tag.e4{color:#fb923c;border-color:rgba(251,146,60,.3);background:rgba(251,146,60,.07)}
.typing-row{display:flex;gap:12px;align-items:center;padding:18px 28px;max-width:740px;margin:0 auto}
.typing-av{width:34px;height:34px;border-radius:9px;background:linear-gradient(145deg,var(--accent),var(--pink));display:grid;place-items:center;color:#fff;font-size:16px;box-shadow:0 4px 14px rgba(108,99,255,.35);flex-shrink:0}
.typing-wrap{display:flex;flex-direction:column;gap:3px}
.typing-dots{display:flex;gap:5px;align-items:center}
.typing-dots span{width:7px;height:7px;border-radius:50%;background:var(--accent);animation:tdot 1.4s ease infinite;opacity:.3}
.typing-dots span:nth-child(2){animation-delay:.18s}
.typing-dots span:nth-child(3){animation-delay:.36s}
@keyframes tdot{0%,80%,100%{transform:translateY(0);opacity:.3}40%{transform:translateY(-7px);opacity:1}}
.typing-label{font-size:.65rem;color:var(--muted);font-style:italic}
.input-zone{padding:8px 22px 16px;background:rgba(11,13,19,0.95);border-top:1px solid var(--border);backdrop-filter:blur(16px);flex-shrink:0;transition:background .25s}
[data-theme="light"] .input-zone{background:rgba(243,244,249,0.96)}
.engine-strip{display:flex;align-items:center;justify-content:center;gap:7px;margin-bottom:7px;font-size:.66rem;color:var(--muted)}
.eng-dots{display:flex;gap:4px;align-items:center}
.eng-d{width:6px;height:6px;border-radius:50%;opacity:.25;transition:.3s}
.eng-d.on{opacity:1;box-shadow:0 0 5px currentColor}
.eng-d.e1{background:#a78bfa;color:#a78bfa}
.eng-d.e2{background:#34d399;color:#34d399}
.eng-d.e3{background:#60a5fa;color:#60a5fa}
.eng-d.e4{background:#fb923c;color:#fb923c}
#strip-label strong{color:var(--accent2)}
.input-box{max-width:740px;margin:0 auto}
.input-shell{background:var(--surface);border:1.5px solid var(--border2);border-radius:15px;box-shadow:0 4px 20px var(--shadow);transition:.2s}
.input-shell:focus-within{border-color:var(--accent);box-shadow:0 4px 20px var(--shadow),0 0 0 3px rgba(108,99,255,.1)}
.input-top{display:flex;align-items:flex-end;padding:12px 12px 9px;gap:9px}
#inp{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:var(--sans);font-size:.9rem;line-height:1.65;resize:none;max-height:180px;min-height:22px;padding:0}
#inp::placeholder{color:var(--muted)}
.input-right-btns{display:flex;gap:5px;align-items:flex-end}
.inp-icon-btn{width:32px;height:32px;background:var(--surface2);border:1px solid var(--border2);border-radius:8px;display:grid;place-items:center;cursor:pointer;color:var(--muted2);transition:.15s;flex-shrink:0}
.inp-icon-btn:hover{background:var(--border2);color:var(--text);border-color:var(--accent)}
.inp-icon-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:1.8}
.inp-icon-btn.recording{background:rgba(239,68,68,0.18);border-color:#ef4444;color:#ef4444;animation:micPulse 1s ease infinite}
@keyframes micPulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.5)}50%{box-shadow:0 0 0 8px rgba(239,68,68,0)}}
/* Voice listening banner */
#voiceBanner{display:none;align-items:center;gap:10px;padding:8px 14px;margin:4px 0;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:10px;font-size:.78rem;color:#f87171;animation:fadeUp .2s ease}
#voiceBanner.show{display:flex}
.voice-waves{display:flex;gap:3px;align-items:center;height:18px}
.voice-waves span{width:3px;background:#ef4444;border-radius:2px;animation:voiceWave 0.8s ease-in-out infinite}
.voice-waves span:nth-child(1){height:6px;animation-delay:0s}
.voice-waves span:nth-child(2){height:14px;animation-delay:.1s}
.voice-waves span:nth-child(3){height:10px;animation-delay:.2s}
.voice-waves span:nth-child(4){height:16px;animation-delay:.3s}
.voice-waves span:nth-child(5){height:8px;animation-delay:.4s}
@keyframes voiceWave{0%,100%{transform:scaleY(0.4);opacity:.6}50%{transform:scaleY(1);opacity:1}}
#send-btn{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent3));border:none;border-radius:9px;cursor:pointer;display:grid;place-items:center;flex-shrink:0;transition:.18s;box-shadow:0 4px 12px rgba(108,99,255,.45)}
#send-btn:hover{transform:scale(1.07);box-shadow:0 6px 20px rgba(108,99,255,.6)}
#send-btn:active{transform:scale(.94)}
#send-btn:disabled{background:var(--surface2);box-shadow:none;cursor:not-allowed;transform:none}
#send-btn svg{fill:#fff;width:15px;height:15px}
.input-bottom{display:flex;align-items:center;justify-content:space-between;padding:7px 12px 11px;border-top:1px solid var(--border);gap:8px;flex-wrap:wrap}
.input-tools{display:flex;gap:5px;flex-wrap:wrap}
.tool-btn{padding:4px 10px;border:1px solid var(--border2);background:transparent;border-radius:6px;font-size:.69rem;color:var(--muted);cursor:pointer;font-family:var(--sans);transition:.15s}
.tool-btn:hover{background:var(--surface2);border-color:var(--accent);color:var(--accent)}
.input-meta{display:flex;align-items:center;gap:8px}
.char-count{font-size:.64rem;color:var(--muted)}
.input-hint{font-size:.64rem;color:var(--muted)}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:9px 20px;font-size:.8rem;color:var(--text);box-shadow:0 8px 28px var(--shadow);z-index:400;opacity:0;transition:.28s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
#scroll-btn{position:fixed;bottom:130px;right:24px;width:34px;height:34px;background:var(--accent);border:none;border-radius:50%;display:none;place-items:center;cursor:pointer;box-shadow:0 4px 14px rgba(108,99,255,.5);z-index:20;transition:.2s}
#scroll-btn:hover{transform:scale(1.1)}
#scroll-btn.show{display:grid}
#scroll-btn svg{width:14px;height:14px;stroke:#fff;fill:none;stroke-width:2.5}
.export-prev{background:var(--code-bg);border:1px solid var(--border);border-radius:10px;padding:14px;max-height:180px;overflow-y:auto;font-size:.74rem;color:var(--muted2);font-family:monospace;line-height:1.6;margin-top:10px;white-space:pre-wrap}
.export-acts{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.exp-btn{flex:1;padding:10px;background:var(--accent);border:none;border-radius:9px;color:#fff;font-size:.81rem;font-weight:600;cursor:pointer;font-family:var(--sans);transition:.15s;min-width:80px}
.exp-btn:hover{background:var(--accent2)}
.exp-btn.sec{background:var(--surface2);color:var(--text);border:1px solid var(--border2)}
.exp-btn.sec:hover{background:var(--border2)}

/* ‚îÄ‚îÄ SEARCH OVERLAY ‚îÄ‚îÄ */
#searchOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:300;align-items:flex-start;justify-content:center;padding-top:80px}
#searchOverlay.open{display:flex;animation:fadeIn .15s ease}
.search-box{background:var(--surface);border:1.5px solid var(--accent);border-radius:16px;width:100%;max-width:560px;overflow:hidden;box-shadow:0 24px 80px var(--shadow);animation:slideUp .2s ease}
.search-input-row{display:flex;align-items:center;gap:10px;padding:14px 18px}
.search-input-row svg{width:16px;height:16px;stroke:var(--muted2);fill:none;stroke-width:2;flex-shrink:0}
#searchInput{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:var(--sans);font-size:.95rem}
#searchInput::placeholder{color:var(--muted)}
.search-close{background:var(--surface2);border:1px solid var(--border2);border-radius:6px;padding:3px 8px;font-size:.7rem;color:var(--muted2);cursor:pointer;font-family:var(--sans)}
.search-results{max-height:340px;overflow-y:auto;border-top:1px solid var(--border)}
.search-result-item{padding:11px 18px;cursor:pointer;border-bottom:1px solid var(--border);transition:.15s}
.search-result-item:hover{background:var(--surface2)}
.search-result-role{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:3px}
.search-result-text{font-size:.82rem;color:var(--text);line-height:1.5;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.search-result-text mark{background:rgba(108,99,255,.35);color:var(--accent2);border-radius:2px;padding:0 2px}
.search-meta{padding:9px 18px;font-size:.68rem;color:var(--muted);border-top:1px solid var(--border)}

/* ‚îÄ‚îÄ PROMPT TEMPLATES MODAL ‚îÄ‚îÄ */
.tmpl-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px}
.tmpl-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;cursor:pointer;transition:.18s;text-align:left}
.tmpl-card:hover{border-color:var(--accent);background:rgba(108,99,255,.06);transform:translateY(-1px)}
.tmpl-cat{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:5px}
.tmpl-name{font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:3px}
.tmpl-desc{font-size:.68rem;color:var(--muted);line-height:1.45}
.tmpl-filter{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.tmpl-pill{padding:4px 11px;border:1px solid var(--border2);background:transparent;border-radius:20px;font-size:.71rem;color:var(--muted2);cursor:pointer;font-family:var(--sans);transition:.15s}
.tmpl-pill.active{background:rgba(108,99,255,.15);border-color:var(--accent);color:var(--accent2);font-weight:600}

/* ‚îÄ‚îÄ STATS MODAL ‚îÄ‚îÄ */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
.stat-val{font-family:var(--serif);font-size:1.8rem;color:var(--accent);margin-bottom:3px;line-height:1}
.stat-label{font-size:.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:.07em}
.stat-bar-wrap{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:13px;margin-bottom:8px}
.stat-bar-label{display:flex;justify-content:space-between;font-size:.74rem;color:var(--text);margin-bottom:7px}
.stat-bar-track{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden}
.stat-bar-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent),var(--pink));transition:width .6s ease}

/* ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ */
.kbd-grid{display:flex;flex-direction:column;gap:6px}
.kbd-row{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:8px}
.kbd-desc{font-size:.8rem;color:var(--text)}
.kbd-keys{display:flex;gap:4px}
kbd{display:inline-block;padding:2px 7px;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;font-size:.68rem;color:var(--muted2);font-family:monospace;box-shadow:0 1px 0 var(--border2)}

/* ‚îÄ‚îÄ PINNED MESSAGES ‚îÄ‚îÄ */
.pinned-banner{background:rgba(108,99,255,.07);border:1px solid rgba(108,99,255,.18);border-radius:10px;padding:10px 14px;margin:0 28px 12px;display:none;animation:fadeIn .2s ease;max-width:740px;margin:8px auto}
.pinned-banner.show{display:block}
.pinned-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.pinned-title{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--accent);display:flex;align-items:center;gap:5px}
.pinned-list{display:flex;flex-direction:column;gap:4px}
.pinned-item{font-size:.78rem;color:var(--muted2);line-height:1.5;padding:5px 8px;background:var(--surface);border-radius:6px;border:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;gap:8px;cursor:pointer}
.pinned-item:hover{border-color:var(--accent);color:var(--text)}
.pin-remove{font-size:.65rem;color:var(--muted);cursor:pointer;flex-shrink:0;padding:2px 5px;border-radius:4px;transition:.15s}
.pin-remove:hover{background:var(--surface2);color:var(--pink)}

/* ‚îÄ‚îÄ FONT SIZE CONTROL ‚îÄ‚îÄ */
.font-slider{width:100%;-webkit-appearance:none;height:4px;border-radius:2px;background:var(--surface2);outline:none;cursor:pointer}
.font-slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 2px 6px rgba(108,99,255,.4)}

/* ‚îÄ‚îÄ NOTIFICATION TOASTS ‚îÄ‚îÄ */
.toast.success{border-color:rgba(34,197,94,.4);background:rgba(22,25,34,.97)}
.toast.error{border-color:rgba(248,113,113,.4)}
.toast.info{border-color:rgba(96,165,250,.4)}
.toast-icon{margin-right:6px}

/* ‚îÄ‚îÄ AUTO-SAVE INDICATOR ‚îÄ‚îÄ */
.autosave-dot{width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;margin-right:4px;animation:pa 3s infinite}

/* ‚îÄ‚îÄ WORD COUNT BADGE ‚îÄ‚îÄ */
.wc-badge{font-size:.62rem;color:var(--muted);padding:2px 7px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;display:none}
.wc-badge.show{display:inline-block}

/* ‚îÄ‚îÄ LANGUAGE SELECT ‚îÄ‚îÄ */
.lang-select{width:100%;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:8px 11px;color:var(--text);font-family:var(--sans);font-size:.82rem;outline:none;cursor:pointer}

/* ‚îÄ‚îÄ SIDEBAR SEARCH ‚îÄ‚îÄ */
.sidebar-search{padding:6px 10px;position:relative}
.sidebar-search input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:7px 10px 7px 30px;color:var(--text);font-family:var(--sans);font-size:.76rem;outline:none;transition:.2s}
.sidebar-search input:focus{border-color:var(--accent)}
.sidebar-search svg{position:absolute;left:18px;top:50%;transform:translateY(-50%);width:12px;height:12px;stroke:var(--muted);fill:none;stroke-width:2}

/* ‚îÄ‚îÄ PERSONA CHIPS ‚îÄ‚îÄ */
.persona-chip{padding:7px 10px;border:1px solid var(--border2);background:var(--card);border-radius:9px;font-size:.76rem;color:var(--muted2);cursor:pointer;font-family:var(--sans);transition:.18s;text-align:center}
.persona-chip:hover{border-color:var(--accent);color:var(--accent)}
.persona-chip.active{background:rgba(108,99,255,.15);border-color:var(--accent);color:var(--accent2);font-weight:600}

/* ‚îÄ‚îÄ FOCUS MODE ‚îÄ‚îÄ */
body.focus-mode .sidebar{transform:translateX(calc(-1 * var(--sidebar-w)));transition:transform .3s}
body.focus-mode .main{transition:margin .3s}
.focus-btn.active{color:var(--accent)!important;border-color:var(--accent)!important;background:rgba(108,99,255,.1)!important}

/* ‚îÄ‚îÄ CHAT TABS ‚îÄ‚îÄ */
.chat-tab-item{display:flex;align-items:center;gap:9px;padding:10px 13px;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:.15s}
.chat-tab-item:hover{border-color:var(--accent);background:var(--surface2)}
.chat-tab-item.active-tab{border-color:var(--accent);background:rgba(108,99,255,.08)}
.chat-tab-name{flex:1;font-size:.82rem;color:var(--text);font-weight:500}
.chat-tab-time{font-size:.65rem;color:var(--muted)}
.chat-tab-del{font-size:.75rem;color:var(--muted);padding:2px 6px;border-radius:4px;transition:.15s}
.chat-tab-del:hover{color:#f87171;background:rgba(248,113,113,.1)}

/* ‚îÄ‚îÄ EDIT MESSAGE ‚îÄ‚îÄ */
.edit-input{width:100%;background:var(--surface2);border:1.5px solid var(--accent);border-radius:10px;padding:9px 13px;color:var(--text);font-family:var(--sans);font-size:.88rem;outline:none;resize:none;line-height:1.6;min-height:60px}
.edit-actions{display:flex;gap:7px;margin-top:7px}

/* ‚îÄ‚îÄ DELETE MESSAGE ‚îÄ‚îÄ */
.act-btn.delete-btn:hover{color:#f87171!important;border-color:rgba(248,113,113,.4)!important;background:rgba(248,113,113,.07)!important}

/* ‚îÄ‚îÄ NOTIFICATION BADGE ‚îÄ‚îÄ */
.notif-badge{position:absolute;top:-4px;right:-4px;width:16px;height:16px;background:#ef4444;border-radius:50%;font-size:.55rem;font-weight:700;color:#fff;display:none;place-items:center;border:2px solid var(--bg)}
.notif-badge.show{display:grid}

/* ‚îÄ‚îÄ PWA INSTALL BANNER ‚îÄ‚îÄ */
#pwaBanner{display:none;position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--accent),var(--accent3));color:#fff;padding:11px 20px;border-radius:12px;font-size:.8rem;font-weight:600;z-index:500;box-shadow:0 8px 28px rgba(108,99,255,.5);cursor:pointer;display:none;align-items:center;gap:10px;animation:slideUp .3s ease}
#pwaBanner.show{display:flex}

/* ‚îÄ‚îÄ REACTION PICKER ‚îÄ‚îÄ */
.reaction-row{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.reaction-btn{padding:2px 7px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;font-size:.78rem;cursor:pointer;transition:.15s;font-family:var(--sans)}
.reaction-btn:hover{transform:scale(1.15);border-color:var(--accent)}
.reaction-btn.selected{background:rgba(108,99,255,.15);border-color:var(--accent)}

/* ‚îÄ‚îÄ TYPING SPEED ‚îÄ‚îÄ */
.typing-speed{font-size:.6rem;color:var(--muted);margin-left:6px;font-style:normal}

/* ‚îÄ‚îÄ WELCOME USER NAME ‚îÄ‚îÄ */
.welcome-user-name{color:var(--accent);font-style:italic}

/* ‚îÄ‚îÄ RESPONSE TIMER ‚îÄ‚îÄ */
.resp-timer{display:inline-block;margin-left:8px;font-size:.6rem;color:var(--muted);background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:1px 6px;vertical-align:middle}

/* ‚îÄ‚îÄ EDIT MESSAGE INLINE ‚îÄ‚îÄ */
.edit-area{width:100%;background:var(--surface2);border:1.5px solid var(--accent);border-radius:10px;padding:9px 13px;color:var(--text);font-family:var(--sans);font-size:.88rem;outline:none;resize:none;line-height:1.6;min-height:52px;margin-top:6px}
.edit-row{display:flex;gap:7px;margin-top:6px}

/* ‚îÄ‚îÄ FILE DROP ZONE ‚îÄ‚îÄ */
#dropZone{position:fixed;inset:0;background:rgba(108,99,255,.18);backdrop-filter:blur(4px);z-index:600;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;border:3px dashed var(--accent)}
#dropZone.show{display:flex;animation:fadeIn .15s ease}
#dropZone .dz-icon{font-size:4rem}
#dropZone .dz-text{font-size:1.1rem;font-weight:600;color:var(--accent2)}

/* ‚îÄ‚îÄ CHAT BACKGROUND THEMES ‚îÄ‚îÄ */
#chat.bg-gradient{background:linear-gradient(135deg,rgba(108,99,255,.04) 0%,rgba(244,114,182,.04) 100%)}
#chat.bg-dots{background-image:radial-gradient(circle,var(--border2) 1px,transparent 1px);background-size:24px 24px}
#chat.bg-grid{background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:32px 32px}
#chat.bg-waves{background:var(--bg)}

/* ‚îÄ‚îÄ BACKGROUND PICKER ‚îÄ‚îÄ */
.bg-picker{display:flex;gap:8px;flex-wrap:wrap}
.bg-opt{width:52px;height:38px;border-radius:8px;border:2px solid var(--border2);cursor:pointer;transition:.15s;position:relative;overflow:hidden}
.bg-opt:hover{border-color:var(--accent)}
.bg-opt.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(108,99,255,.3)}
.bg-opt-none{background:var(--card)}
.bg-opt-gradient{background:linear-gradient(135deg,rgba(108,99,255,.3),rgba(244,114,182,.3))}
.bg-opt-dots{background-image:radial-gradient(circle,var(--muted2) 1px,transparent 1px);background-size:10px 10px;background-color:var(--card)}
.bg-opt-grid{background-image:linear-gradient(var(--border2) 1px,transparent 1px),linear-gradient(90deg,var(--border2) 1px,transparent 1px);background-size:12px 12px;background-color:var(--card)}

/* ‚îÄ‚îÄ TYPEWRITER CURSOR ‚îÄ‚îÄ */
.tw-cursor::after{content:'‚ñã';animation:twblink .6s infinite;color:var(--accent);font-size:.8em}
@keyframes twblink{0%,100%{opacity:1}50%{opacity:0}}

/* ‚îÄ‚îÄ CHAT STATS SPARKLINE ‚îÄ‚îÄ */
.activity-bar{display:flex;align-items:flex-end;gap:3px;height:36px;margin-top:8px}
.ab-bar{flex:1;background:var(--accent);border-radius:2px 2px 0 0;opacity:.6;min-height:4px;transition:height .3s}

/* ‚îÄ‚îÄ PERSONA INDICATOR ‚îÄ‚îÄ */
.persona-pill{display:inline-flex;align-items:center;gap:5px;padding:2px 9px;background:rgba(108,99,255,.1);border:1px solid rgba(108,99,255,.2);border-radius:20px;font-size:.65rem;color:var(--accent2);font-weight:600;margin-left:6px}

/* ‚îÄ‚îÄ MULTI-CHAT TAB ‚îÄ‚îÄ */
.chat-tab-count{font-size:.65rem;color:var(--muted);background:var(--surface2);padding:1px 7px;border-radius:10px;flex-shrink:0}
/* ‚îÄ‚îÄ DELETE BTN ‚îÄ‚îÄ */
.act-btn.delete-btn:hover{color:#f87171!important;border-color:rgba(248,113,113,.4)!important;background:rgba(248,113,113,.07)!important}
/* ‚îÄ‚îÄ EXPORT FORMAT BUTTONS ‚îÄ‚îÄ */
.exp-format-btn{background:var(--card);border:1.5px solid var(--border2);border-radius:12px;padding:14px 10px;cursor:pointer;font-family:var(--sans);color:var(--text);text-align:center;transition:.18s;display:flex;flex-direction:column;align-items:center;gap:4px}
.exp-format-btn:hover{border-color:var(--accent);background:rgba(108,99,255,.08);transform:translateY(-2px);box-shadow:0 4px 16px rgba(108,99,255,.2)}
/* ‚îÄ‚îÄ EXPORT TAB BUTTONS ‚îÄ‚îÄ */
.exp-tab-btn{background:var(--surface2);border:1.5px solid var(--border2);border-radius:8px;padding:6px 16px;cursor:pointer;font-family:var(--sans);color:var(--muted2);font-size:.8rem;font-weight:500;transition:.15s}
.exp-tab-btn:hover{border-color:var(--accent);color:var(--accent)}
.exp-tab-btn.active{background:rgba(108,99,255,.12);border-color:var(--accent);color:var(--accent)}

@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="mob-overlay" onclick="closeSidebar()"></div>

<!-- FILE DROP ZONE -->
<div id="dropZone">
  <div class="dz-icon">üìé</div>
  <div class="dz-text">Drop file to read into chat</div>
  <div style="font-size:.8rem;color:var(--muted2)">Supports .txt, .md, .csv, .json, .py, .js, .html</div>
</div>

<!-- PWA INSTALL BANNER -->
<div id="pwaBanner" onclick="installPWA()">
  <span>üì±</span>
  <span>Install RuleBot as an app</span>
  <span style="font-size:.7rem;opacity:.7;margin-left:4px">Tap to install</span>
  <button onclick="event.stopPropagation();document.getElementById('pwaBanner').classList.remove('show')" style="background:rgba(255,255,255,.2);border:none;color:#fff;border-radius:4px;padding:2px 7px;cursor:pointer;font-size:.7rem;margin-left:8px">‚úï</button>
</div>

<!-- AUTH PAGES -->
<div id="authOverlay" style="display:none;position:fixed;inset:0;z-index:1000;background:#070a12;overflow-y:auto">
  <div id="authPage" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden">
    <!-- Animated background -->
    <div style="position:absolute;inset:0;pointer-events:none;overflow:hidden">
      <div style="position:absolute;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(108,99,255,0.15),transparent 70%);top:-200px;left:-200px;animation:floatBg 8s ease-in-out infinite"></div>
      <div style="position:absolute;width:400px;height:400px;border-radius:50%;background:radial-gradient(circle,rgba(244,114,182,0.12),transparent 70%);bottom:-100px;right:-100px;animation:floatBg 10s ease-in-out infinite reverse"></div>
      <div style="position:absolute;width:300px;height:300px;border-radius:50%;background:radial-gradient(circle,rgba(45,212,191,0.08),transparent 70%);top:50%;right:20%;animation:floatBg 12s ease-in-out infinite"></div>
      <!-- Grid lines -->
      <svg style="position:absolute;inset:0;width:100%;height:100%;opacity:.04" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M 40 0 L 0 0 0 40" fill="none" stroke="#6c63ff" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(#grid)"/></svg>
    </div>
    <style>
      @keyframes floatBg{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(30px,-20px) scale(1.05)}66%{transform:translate(-20px,30px) scale(.97)}}
      @keyframes authIn{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
      .auth-card{background:rgba(22,25,34,0.95);border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:36px;width:100%;max-width:420px;backdrop-filter:blur(20px);box-shadow:0 32px 80px rgba(0,0,0,0.6),0 0 0 1px rgba(108,99,255,.1);animation:authIn .4s ease both;position:relative;z-index:1}
      .auth-logo{display:flex;align-items:center;gap:10px;margin-bottom:28px;justify-content:center}
      .auth-logo-mark{width:40px;height:40px;background:linear-gradient(145deg,#6c63ff,#f472b6);border-radius:11px;display:grid;place-items:center;color:#fff;font-size:18px;box-shadow:0 6px 20px rgba(108,99,255,.5)}
      .auth-logo-text{font-family:'Instrument Serif',serif;font-size:1.3rem;color:#e2e4f0}
      .auth-logo-text em{color:#6c63ff;font-style:normal}
      .auth-title{font-family:'Instrument Serif',serif;font-size:1.6rem;color:#e2e4f0;text-align:center;margin-bottom:6px}
      .auth-sub{font-size:.82rem;color:#6b7494;text-align:center;margin-bottom:28px;line-height:1.6}
      .auth-tabs{display:flex;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:3px;margin-bottom:24px}
      .auth-tab{flex:1;padding:8px;border:none;background:transparent;border-radius:8px;font-size:.82rem;font-weight:600;cursor:pointer;color:#6b7494;font-family:'DM Sans',sans-serif;transition:.2s}
      .auth-tab.active{background:rgba(108,99,255,.2);color:#8b85ff;box-shadow:0 2px 8px rgba(108,99,255,.2)}
      .auth-field{margin-bottom:14px}
      .auth-label{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#4a5068;margin-bottom:6px;display:block}
      .auth-input{width:100%;background:rgba(255,255,255,.04);border:1.5px solid rgba(255,255,255,.08);border-radius:10px;padding:11px 14px;color:#e2e4f0;font-family:'DM Sans',sans-serif;font-size:.88rem;outline:none;transition:.2s}
      .auth-input:focus{border-color:#6c63ff;background:rgba(108,99,255,.06);box-shadow:0 0 0 3px rgba(108,99,255,.12)}
      .auth-input::placeholder{color:#4a5068}
      .auth-btn{width:100%;padding:13px;background:linear-gradient(135deg,#6c63ff,#4a43cc);border:none;border-radius:11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:.2s;letter-spacing:.02em;box-shadow:0 6px 20px rgba(108,99,255,.4);margin-top:6px}
      .auth-btn:hover{transform:translateY(-1px);box-shadow:0 8px 28px rgba(108,99,255,.55)}
      .auth-btn:active{transform:translateY(0)}
      .auth-divider{display:flex;align-items:center;gap:12px;margin:18px 0;color:#4a5068;font-size:.75rem}
      .auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.07)}
      .auth-social{display:grid;grid-template-columns:1fr 1fr;gap:8px}
      .auth-social-btn{padding:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:9px;color:#9ba3b8;font-size:.8rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:.18s;display:flex;align-items:center;justify-content:center;gap:7px}
      .auth-social-btn:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.16);color:#e2e4f0}
      .auth-footer{text-align:center;margin-top:18px;font-size:.76rem;color:#4a5068}
      .auth-footer a{color:#6c63ff;cursor:pointer;text-decoration:none}
      .auth-footer a:hover{color:#8b85ff}
      .auth-error{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:9px 13px;font-size:.78rem;color:#fca5a5;margin-bottom:12px;display:none}
      .auth-success{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);border-radius:8px;padding:9px 13px;font-size:.78rem;color:#86efac;margin-bottom:12px;display:none}
      .user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#6c63ff,#f472b6);display:grid;place-items:center;color:#fff;font-weight:700;font-size:.85rem;cursor:pointer;flex-shrink:0;transition:.18s;border:2px solid rgba(108,99,255,.3)}
      .user-avatar:hover{transform:scale(1.05);border-color:rgba(108,99,255,.6)}
      .user-menu{position:absolute;top:calc(100% + 8px);right:0;background:#161922;border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:6px;min-width:200px;box-shadow:0 16px 48px rgba(0,0,0,.5);z-index:300;animation:slideUp .18s ease}
      .user-menu-header{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);margin-bottom:4px}
      .user-menu-name{font-size:.85rem;font-weight:600;color:#e2e4f0}
      .user-menu-email{font-size:.72rem;color:#6b7494;margin-top:2px}
      .user-menu-item{display:flex;align-items:center;gap:9px;padding:9px 12px;border-radius:8px;cursor:pointer;font-size:.81rem;color:#9ba3b8;transition:.15s}
      .user-menu-item:hover{background:rgba(255,255,255,.06);color:#e2e4f0}
      .user-menu-item.danger{color:#f87171}
      .user-menu-item.danger:hover{background:rgba(239,68,68,.1)}
    </style>
    <!-- Login form -->
    <div class="auth-card" id="loginCard">
      <div class="auth-logo">
        <div class="auth-logo-mark">‚ú¶</div>
        <div class="auth-logo-text">Rule<em>Bot</em> AI</div>
      </div>
      <div class="auth-title">Welcome back</div>
      <div class="auth-sub">Sign in to your RuleBot AI account<br>to continue your conversations</div>
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
        <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
      </div>
      <div class="auth-error" id="authError"></div>
      <div class="auth-success" id="authSuccess"></div>
      <!-- Sign In fields -->
      <div id="loginFields">
        <div class="auth-field"><label class="auth-label">Email Address</label><input class="auth-input" id="loginEmail" type="email" placeholder="you@example.com"/></div>
        <div class="auth-field"><label class="auth-label">Password</label><input class="auth-input" id="loginPass" type="password" placeholder="Enter your password"/></div>
        <button class="auth-btn" onclick="doLogin()">üöÄ Sign In</button>
        <div class="auth-divider">or continue with</div>
        <div class="auth-social">
          <button class="auth-social-btn" onclick="socialLogin('Google')">üåê Google</button>
          <button class="auth-social-btn" onclick="socialLogin('GitHub')">üêô GitHub</button>
        </div>
      </div>
      <!-- Sign Up fields -->
      <div id="signupFields" style="display:none">
        <div class="auth-field"><label class="auth-label">Full Name</label><input class="auth-input" id="signupName" type="text" placeholder="Your full name"/></div>
        <div class="auth-field"><label class="auth-label">Email Address</label><input class="auth-input" id="signupEmail" type="email" placeholder="you@example.com"/></div>
        <div class="auth-field"><label class="auth-label">Password</label><input class="auth-input" id="signupPass" type="password" placeholder="Min. 6 characters"/></div>
        <div class="auth-field"><label class="auth-label">Confirm Password</label><input class="auth-input" id="signupPass2" type="password" placeholder="Repeat password"/></div>
        <button class="auth-btn" onclick="doSignup()">‚ú® Create Account</button>
        <div class="auth-divider">or sign up with</div>
        <div class="auth-social">
          <button class="auth-social-btn" onclick="socialLogin('Google')">üåê Google</button>
          <button class="auth-social-btn" onclick="socialLogin('GitHub')">üêô GitHub</button>
        </div>
      </div>
      <div class="auth-footer">By continuing you agree to our <a>Terms</a> &amp; <a>Privacy Policy</a></div>
    </div>
  </div>
</div>

<!-- ACCOUNT DETAILS MODAL -->
<div class="modal-overlay" id="accountModal">
  <div class="modal" style="max-width:460px;padding:0;overflow:hidden">
    <!-- Header banner -->
    <div style="background:linear-gradient(135deg,#6c63ff,#f472b6);padding:28px 24px 20px;position:relative">
      <button class="modal-close" onclick="closeModal('accountModal')" style="position:absolute;top:12px;right:12px;background:rgba(0,0,0,.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px;display:grid;place-items:center">‚úï</button>
      <div style="display:flex;align-items:center;gap:16px">
        <div id="acctAvatar" style="width:64px;height:64px;border-radius:50%;background:rgba(255,255,255,.2);border:3px solid rgba(255,255,255,.4);display:grid;place-items:center;font-size:1.5rem;font-weight:700;color:#fff;flex-shrink:0">?</div>
        <div>
          <div id="acctName" style="font-size:1.2rem;font-weight:700;color:#fff">Guest User</div>
          <div id="acctEmail" style="font-size:.8rem;color:rgba(255,255,255,.8);margin-top:2px">Not signed in</div>
          <div id="acctBadge" style="display:inline-block;background:rgba(255,255,255,.2);color:#fff;font-size:.65rem;font-weight:700;padding:2px 10px;border-radius:20px;margin-top:6px;letter-spacing:.05em">GUEST</div>
        </div>
      </div>
    </div>
    <!-- Body -->
    <div style="padding:20px 24px">
      <!-- Stats row -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px">
        <div style="background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:12px;text-align:center">
          <div id="acctMsgCount" style="font-size:1.4rem;font-weight:700;color:var(--accent)">0</div>
          <div style="font-size:.68rem;color:var(--muted2);margin-top:2px">Messages</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:12px;text-align:center">
          <div id="acctSessionCount" style="font-size:1.4rem;font-weight:700;color:var(--teal)">0</div>
          <div style="font-size:.68rem;color:var(--muted2);margin-top:2px">Sessions</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:12px;text-align:center">
          <div id="acctWordCount" style="font-size:1.4rem;font-weight:700;color:var(--pink)">0</div>
          <div style="font-size:.68rem;color:var(--muted2);margin-top:2px">Words</div>
        </div>
      </div>
      <!-- Account info rows -->
      <div style="background:var(--card);border:1px solid var(--border2);border-radius:12px;overflow:hidden;margin-bottom:16px">
        <div style="padding:13px 16px;border-bottom:1px solid var(--border2);display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:.78rem;font-weight:600;color:var(--text)">Full Name</div>
            <div id="acctNameRow" style="font-size:.72rem;color:var(--muted2);margin-top:1px">‚Äî</div>
          </div>
          <button onclick="editAccountField('name')" style="font-size:.7rem;color:var(--accent);background:rgba(108,99,255,.1);border:1px solid rgba(108,99,255,.2);border-radius:6px;padding:4px 10px;cursor:pointer;font-family:var(--sans)">Edit</button>
        </div>
        <div style="padding:13px 16px;border-bottom:1px solid var(--border2);display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:.78rem;font-weight:600;color:var(--text)">Email Address</div>
            <div id="acctEmailRow" style="font-size:.72rem;color:var(--muted2);margin-top:1px">‚Äî</div>
          </div>
          <button onclick="editAccountField('email')" style="font-size:.7rem;color:var(--accent);background:rgba(108,99,255,.1);border:1px solid rgba(108,99,255,.2);border-radius:6px;padding:4px 10px;cursor:pointer;font-family:var(--sans)">Edit</button>
        </div>
        <div style="padding:13px 16px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:.78rem;font-weight:600;color:var(--text)">Account Type</div>
            <div style="font-size:.72rem;color:var(--muted2);margin-top:1px">RuleBot AI ‚Äî Free Plan</div>
          </div>
          <span style="font-size:.65rem;font-weight:700;background:rgba(74,222,128,.1);color:#4ade80;border:1px solid rgba(74,222,128,.2);padding:3px 10px;border-radius:20px">FREE</span>
        </div>
      </div>
      <!-- Change password -->
      <div id="acctChangePassSection" style="background:var(--card);border:1px solid var(--border2);border-radius:12px;margin-bottom:16px;overflow:hidden">
        <div style="padding:13px 16px;display:flex;justify-content:space-between;align-items:center">
          <div style="font-size:.78rem;font-weight:600;color:var(--text)">Password</div>
          <button onclick="toggleChangePass()" style="font-size:.7rem;color:var(--accent);background:rgba(108,99,255,.1);border:1px solid rgba(108,99,255,.2);border-radius:6px;padding:4px 10px;cursor:pointer;font-family:var(--sans)">Change</button>
        </div>
        <div id="changePassFields" style="display:none;padding:0 16px 16px">
          <input class="auth-input" id="cpOld" type="password" placeholder="Current password" style="margin-bottom:8px">
          <input class="auth-input" id="cpNew" type="password" placeholder="New password (min 6 chars)" style="margin-bottom:8px">
          <input class="auth-input" id="cpNew2" type="password" placeholder="Confirm new password" style="margin-bottom:10px">
          <button onclick="doChangePass()" style="width:100%;padding:10px;background:linear-gradient(135deg,#6c63ff,#4a43cc);border:none;border-radius:8px;color:#fff;font-weight:700;cursor:pointer;font-family:var(--sans);font-size:.82rem">Update Password</button>
          <div id="cpMsg" style="font-size:.74rem;margin-top:8px;text-align:center;min-height:16px"></div>
        </div>
      </div>
      <!-- Action buttons -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <button onclick="closeModal('accountModal')" style="padding:11px;background:var(--surface2);border:1px solid var(--border2);border-radius:10px;color:var(--text);font-family:var(--sans);font-size:.82rem;font-weight:600;cursor:pointer">Close</button>
        <button onclick="doSignOutFromAccount()" style="padding:11px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:10px;color:#f87171;font-family:var(--sans);font-size:.82rem;font-weight:600;cursor:pointer">Sign Out</button>
      </div>
    </div>
  </div>
</div>

<!-- PERSONA MODAL -->
<div class="modal-overlay" id="personaModal">
  <div class="modal" style="max-width:460px">
    <div class="modal-header"><div class="modal-title">üé≠ AI Persona & Identity</div><button class="modal-close" onclick="closeModal('personaModal')">&#x2715;</button></div>
    <div class="modal-section">
      <div class="modal-label">Your Name</div>
      <input id="userNameInput" class="auth-input" placeholder="Enter your name..." style="width:100%;margin-bottom:10px" oninput="previewPersona()"/>
    </div>
    <div class="modal-section">
      <div class="modal-label">Bot Name</div>
      <input id="botNameInput" class="auth-input" placeholder="e.g. Aria, Max, Zara..." value="RuleBot" style="width:100%;margin-bottom:10px" oninput="previewPersona()"/>
    </div>
    <div class="modal-section">
      <div class="modal-label">AI Personality Style</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:10px" id="personaGrid">
        <button class="persona-chip active" onclick="selectPersona(this,'friendly')">üòä Friendly</button>
        <button class="persona-chip" onclick="selectPersona(this,'professional')">üíº Professional</button>
        <button class="persona-chip" onclick="selectPersona(this,'funny')">üòÇ Funny</button>
        <button class="persona-chip" onclick="selectPersona(this,'concise')">‚ö° Concise</button>
        <button class="persona-chip" onclick="selectPersona(this,'teacher')">üìö Teacher</button>
        <button class="persona-chip" onclick="selectPersona(this,'creative')">üé® Creative</button>
      </div>
    </div>
    <div class="modal-section" style="margin-bottom:14px">
      <div class="modal-label">Preview</div>
      <div id="personaPreview" style="background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:12px;font-size:.82rem;color:var(--muted2);line-height:1.6;min-height:48px"></div>
    </div>
    <button class="copy-btn" style="width:100%;padding:12px" onclick="applyPersona()">‚úÖ Apply Persona</button>
  </div>
</div>

<!-- MULTI-CHAT MODAL -->
<div class="modal-overlay" id="multiChatModal">
  <div class="modal" style="max-width:460px">
    <div class="modal-header"><div class="modal-title">üí¨ My Conversations</div><button class="modal-close" onclick="closeModal('multiChatModal')">&#x2715;</button></div>
    <button class="copy-btn" style="width:100%;margin-bottom:12px;padding:10px" onclick="createNewTab()">Ôºã New Conversation</button>
    <div id="chatTabList" style="display:flex;flex-direction:column;gap:6px;max-height:320px;overflow-y:auto"></div>
  </div>
</div>

<!-- PRINT MODAL -->
<div class="modal-overlay" id="printModal">
  <div class="modal" style="max-width:420px">
    <div class="modal-header"><div class="modal-title">üñ®Ô∏è Print Chat</div><button class="modal-close" onclick="closeModal('printModal')">&#x2715;</button></div>
    <div class="modal-section">
      <div class="modal-label">Print Options</div>
      <div class="modal-row"><div class="modal-row-label">Include timestamps</div><button class="toggle on" id="print-ts"></button></div>
      <div class="modal-row"><div class="modal-row-label">Include engine tags</div><button class="toggle" id="print-eng"></button></div>
      <div class="modal-row"><div class="modal-row-label">Dark theme print</div><button class="toggle" id="print-dark"></button></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="exp-btn sec" onclick="closeModal('printModal')">Cancel</button>
      <button class="exp-btn" onclick="doPrint()">üñ®Ô∏è Print / Save PDF</button>
    </div>
  </div>
</div>

<!-- SEARCH OVERLAY -->
<div id="searchOverlay" onclick="if(event.target===this)closeSearch()">
  <div class="search-box">
    <div class="search-input-row">
      <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input id="searchInput" placeholder="Search messages..." oninput="doSearch(this.value)" autocomplete="off"/>
      <button class="search-close" onclick="closeSearch()">Esc</button>
    </div>
    <div class="search-results" id="searchResults"></div>
    <div class="search-meta" id="searchMeta">Type to search your conversation</div>
  </div>
</div>

<!-- TEMPLATES MODAL -->
<div class="modal-overlay" id="templatesModal">
  <div class="modal" style="max-width:520px">
    <div class="modal-header"><div class="modal-title">‚ö° Prompt Templates</div><button class="modal-close" onclick="closeModal('templatesModal')">&#x2715;</button></div>
    <div class="tmpl-filter" id="tmplFilter">
      <button class="tmpl-pill active" onclick="filterTmpl(this,'all')">All</button>
      <button class="tmpl-pill" onclick="filterTmpl(this,'code')">üíª Code</button>
      <button class="tmpl-pill" onclick="filterTmpl(this,'learn')">üìö Learn</button>
      <button class="tmpl-pill" onclick="filterTmpl(this,'write')">‚úçÔ∏è Write</button>
      <button class="tmpl-pill" onclick="filterTmpl(this,'math')">üßÆ Math</button>
      <button class="tmpl-pill" onclick="filterTmpl(this,'fun')">üéâ Fun</button>
    </div>
    <div class="tmpl-grid" id="tmplGrid"></div>
  </div>
</div>

<!-- STATS MODAL -->
<div class="modal-overlay" id="statsModal">
  <div class="modal" style="max-width:420px">
    <div class="modal-header"><div class="modal-title">üìä Chat Statistics</div><button class="modal-close" onclick="closeModal('statsModal')">&#x2715;</button></div>
    <div class="stat-grid" id="statGrid"></div>
    <div id="statBars"></div>
    <div class="modal-section" style="margin-bottom:0">
      <div class="modal-label">Session Info</div>
      <div class="modal-row"><div class="modal-row-label">Session started</div><div id="statSession" style="font-size:.78rem;color:var(--muted2)">‚Äî</div></div>
      <div class="modal-row"><div class="modal-row-label">AI Engines used</div><div id="statEngines" style="font-size:.78rem;color:var(--muted2)">‚Äî</div></div>
    </div>
  </div>
</div>

<!-- SHORTCUTS MODAL -->
<div class="modal-overlay" id="shortcutsModal">
  <div class="modal" style="max-width:420px">
    <div class="modal-header"><div class="modal-title">‚å®Ô∏è Keyboard Shortcuts</div><button class="modal-close" onclick="closeModal('shortcutsModal')">&#x2715;</button></div>
    <div class="kbd-grid">
      <div class="kbd-row"><span class="kbd-desc">Send message</span><div class="kbd-keys"><kbd>Enter</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">New line</span><div class="kbd-keys"><kbd>Shift</kbd><kbd>Enter</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">Search chat</span><div class="kbd-keys"><kbd>Ctrl</kbd><kbd>F</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">New conversation</span><div class="kbd-keys"><kbd>Ctrl</kbd><kbd>K</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">Focus input</span><div class="kbd-keys"><kbd>Ctrl</kbd><kbd>L</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">Export chat</span><div class="kbd-keys"><kbd>Ctrl</kbd><kbd>E</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">Toggle theme</span><div class="kbd-keys"><kbd>Ctrl</kbd><kbd>D</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">Open templates</span><div class="kbd-keys"><kbd>Ctrl</kbd><kbd>T</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">Focus / Zen mode</span><div class="kbd-keys"><kbd>Ctrl</kbd><kbd>B</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">Attach file</span><div class="kbd-keys"><kbd>Ctrl</kbd><kbd>U</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">Regenerate last reply</span><div class="kbd-keys"><kbd>Ctrl</kbd><kbd>R</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">Close / Stop speaking</span><div class="kbd-keys"><kbd>Escape</kbd></div></div>
      <div class="kbd-row"><span class="kbd-desc">Show shortcuts</span><div class="kbd-keys"><kbd>?</kbd></div></div>
    </div>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="modal-overlay" id="shareModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Share Conversation</div><button class="modal-close" onclick="closeModal('shareModal')">&#x2715;</button></div>
    <div class="modal-section">
      <div class="modal-label">Shareable Link</div>
      <div class="share-link-box"><input class="share-link-input" id="shareLink" value="https://rulebot.ai/chat/demo" readonly/><button class="copy-btn" onclick="copyLink()">Copy</button></div>
    </div>
    <div class="modal-section">
      <div class="modal-label">Share via</div>
      <div class="share-opts">
        <button class="share-opt" onclick="shareVia('LinkedIn')"><span class="share-opt-icon">&#x1F4BC;</span>LinkedIn</button>
        <button class="share-opt" onclick="shareVia('Twitter')"><span class="share-opt-icon">&#x1F426;</span>Twitter / X</button>
        <button class="share-opt" onclick="shareVia('WhatsApp')"><span class="share-opt-icon">&#x1F4AC;</span>WhatsApp</button>
        <button class="share-opt" onclick="shareVia('Email')"><span class="share-opt-icon">&#x1F4E7;</span>Email</button>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal" style="max-width:480px">
    <div class="modal-header"><div class="modal-title">‚öôÔ∏è Settings</div><button class="modal-close" onclick="closeModal('settingsModal')">&#x2715;</button></div>
    <div class="modal-section">
      <div class="modal-label">Appearance</div>
      <div class="modal-row"><div><div class="modal-row-label">Light Mode</div><div class="modal-row-sub">Switch between dark and light theme</div></div><button class="toggle" id="themeToggle" onclick="toggleTheme()"></button></div>
      <div class="modal-row" style="flex-direction:column;align-items:flex-start;gap:10px">
        <div><div class="modal-row-label">Chat Background</div><div class="modal-row-sub">Customize the chat area appearance</div></div>
        <div class="bg-picker">
          <div class="bg-opt bg-opt-none active" title="None" onclick="setChatBg('',this)"></div>
          <div class="bg-opt bg-opt-gradient" title="Gradient" onclick="setChatBg('bg-gradient',this)"></div>
          <div class="bg-opt bg-opt-dots" title="Dots" onclick="setChatBg('bg-dots',this)"></div>
          <div class="bg-opt bg-opt-grid" title="Grid" onclick="setChatBg('bg-grid',this)"></div>
        </div>
      </div>
      <div class="modal-row" style="flex-direction:column;align-items:flex-start;gap:10px">
        <div><div class="modal-row-label">Font Size</div><div class="modal-row-sub">Adjust text size for readability</div></div>
        <div style="width:100%;display:flex;align-items:center;gap:10px">
          <span style="font-size:.7rem;color:var(--muted)">A</span>
          <input type="range" class="font-slider" id="fontSlider" min="12" max="20" value="15" oninput="changeFontSize(this.value)"/>
          <span style="font-size:1rem;color:var(--muted)">A</span>
          <span id="fontSizeLabel" style="font-size:.72rem;color:var(--accent);min-width:32px;text-align:right">15px</span>
        </div>
      </div>
      <div class="modal-row" style="flex-direction:column;align-items:flex-start;gap:8px">
        <div><div class="modal-row-label">Response Language</div><div class="modal-row-sub">AI responds in your selected language</div></div>
        <select class="lang-select" id="langSelect" onchange="changeLanguage(this.value)">
          <option value="english">üá¨üáß English</option>
          <option value="hindi">üáÆüá≥ Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
          <option value="telugu">üáÆüá≥ Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
          <option value="tamil">üáÆüá≥ Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
          <option value="spanish">üá™üá∏ Spanish</option>
          <option value="french">üá´üá∑ French</option>
          <option value="german">üá©üá™ German</option>
          <option value="japanese">üáØüáµ Japanese</option>
          <option value="arabic">üá∏üá¶ Arabic</option>
        </select>
      </div>
    </div>
    <div class="modal-section">
      <div class="modal-label">Behaviour</div>
      <div class="modal-row"><div><div class="modal-row-label">Auto AI Fallback</div><div class="modal-row-sub">Switch engine automatically if one fails</div></div><button class="toggle on" id="tgl-fallback" onclick="this.classList.toggle('on')"></button></div>
      <div class="modal-row"><div><div class="modal-row-label">Enter to Send</div><div class="modal-row-sub">Shift+Enter for new line</div></div><button class="toggle on" id="tgl-enter" onclick="this.classList.toggle('on')"></button></div>
      <div class="modal-row"><div><div class="modal-row-label">Message Timestamps</div><div class="modal-row-sub">Show time on each message</div></div><button class="toggle on" id="tgl-time" onclick="toggleTimestamps(this)"></button></div>
      <div class="modal-row"><div><div class="modal-row-label">Auto-save Chats</div><div class="modal-row-sub">Save conversations to browser storage</div></div><button class="toggle on" id="tgl-autosave" onclick="this.classList.toggle('on')"></button></div>
      <div class="modal-row"><div><div class="modal-row-label">Sound Effects</div><div class="modal-row-sub">Play subtle sound on messages</div></div><button class="toggle" id="tgl-sound" onclick="toggleSound(this)"></button></div>
    </div>
    <div class="modal-section">
      <div class="modal-label">AI Engine Status <span id="engineTestBtn" onclick="testAllEngines()" style="font-size:.7rem;font-weight:400;color:var(--accent);cursor:pointer;margin-left:8px;text-decoration:underline">‚Üª Test Now</span></div>
      <div class="modal-row" id="erow1">
        <div><div class="modal-row-label">Engine 1 ‚Äî Primary</div><div class="modal-row-sub" id="esub1">Built-in ¬∑ Full knowledge base ¬∑ Always available</div></div>
        <div style="display:flex;align-items:center;gap:6px"><span id="estat1" style="font-size:.7rem;color:#4ade80">‚úÖ Online</span><div class="sdot g" id="edot1"></div></div>
      </div>
      <div class="modal-row" id="erow2">
        <div><div class="modal-row-label">Engine 2 ‚Äî Analytical</div><div class="modal-row-sub" id="esub2">Built-in ¬∑ Structured responses ¬∑ Always available</div></div>
        <div style="display:flex;align-items:center;gap:6px"><span id="estat2" style="font-size:.7rem;color:#4ade80">‚úÖ Online</span><div class="sdot g" id="edot2"></div></div>
      </div>
      <div class="modal-row" id="erow3">
        <div><div class="modal-row-label">Engine 3 ‚Äî Concise</div><div class="modal-row-sub" id="esub3">Built-in ¬∑ Fast & direct ¬∑ Always available</div></div>
        <div style="display:flex;align-items:center;gap:6px"><span id="estat3" style="font-size:.7rem;color:#4ade80">‚úÖ Online</span><div class="sdot g" id="edot3"></div></div>
      </div>
      <div class="modal-row">
        <div><div class="modal-row-label">Engine 4 ‚Äî Smart Fallback</div><div class="modal-row-sub">Built-in ¬∑ Always works ¬∑ Never fails</div></div>
        <div style="display:flex;align-items:center;gap:6px"><span style="font-size:.7rem;color:#4ade80">Always ON</span><div class="sdot g"></div></div>
      </div>
      <div id="engineTestStatus" style="font-size:.74rem;color:var(--muted2);text-align:center;padding:4px 0;min-height:18px"></div>
    </div>
    <div class="modal-section" style="margin-bottom:0">
      <div class="modal-label">Quick Actions</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px">
        <button class="exp-btn sec" onclick="closeModal('settingsModal');openModal('shortcutsModal')">‚å®Ô∏è Shortcuts</button>
        <button class="exp-btn sec" onclick="closeModal('settingsModal');openModal('statsModal');refreshStats()">üìä Stats</button>
        <button class="exp-btn sec" onclick="clearPins();showToast('üìå Pins cleared')">üìå Clear Pins</button>
        <button class="exp-btn sec" style="color:#f87171;border-color:rgba(248,113,113,.3)" onclick="if(confirm('Clear all saved data?')){localStorage.clear();showToast('üóëÔ∏è Data cleared')}">üóëÔ∏è Clear Data</button>
      </div>
    </div>
  </div>
</div>

<!-- EXPORT MODAL -->
<div class="modal-overlay" id="exportModal">
  <div class="modal" style="max-width:560px;width:95vw">
    <div class="modal-header">
      <div class="modal-title">‚¨áÔ∏è Export Chat</div>
      <button class="modal-close" onclick="closeModal('exportModal')">&#x2715;</button>
    </div>
    <div class="modal-section">
      <div class="modal-label">Format</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="exp-tab-btn active" id="efmt-txt"  onclick="switchExportFmt('txt')">üìÑ .TXT</button>
        <button class="exp-tab-btn"        id="efmt-md"   onclick="switchExportFmt('md')">üìù .MD</button>
        <button class="exp-tab-btn"        id="efmt-json" onclick="switchExportFmt('json')">üóÇÔ∏è .JSON</button>
      </div>
    </div>
    <div class="modal-section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div class="modal-label" style="margin:0">Preview <span id="exportCharCount" style="font-weight:400;color:var(--muted2)"></span></div>
        <button onclick="selectExportAll()" style="font-size:.72rem;background:var(--surface2);border:1px solid var(--border2);color:var(--muted2);border-radius:6px;padding:3px 10px;cursor:pointer;font-family:var(--sans)">Select All</button>
      </div>
      <textarea id="exportTextarea" readonly style="
        width:100%;height:180px;background:var(--card);border:1.5px solid var(--border2);
        border-radius:10px;padding:12px;font-family:monospace;font-size:.75rem;
        color:var(--text);resize:vertical;outline:none;line-height:1.5;
        transition:border-color .2s
      " onclick="this.select()" spellcheck="false"></textarea>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button class="exp-btn" onclick="doDownload()" id="downloadBtn">
        ‚¨áÔ∏è Download File
      </button>
      <button class="exp-btn" onclick="doCopyExport()" id="copyExportBtn" style="background:var(--surface2);border:1px solid var(--accent);color:var(--accent)">
        üìã Copy to Clipboard
      </button>
    </div>
    <button class="exp-btn" onclick="dlChat('pdf')" style="width:100%;margin-top:8px;background:linear-gradient(135deg,#ef4444,#b91c1c)">
      üìï Export as PDF (opens print dialog)
    </button>
    <div id="exportStatus" style="margin-top:8px;font-size:.76rem;text-align:center;min-height:16px;color:var(--green)"></div>
  </div>
</div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="ai-status-bar">
    <div class="pulse"></div> AI Online <span id="eslabel">&middot; Engine 1</span>
  </div>
  <div class="sidebar-logo">
    <div class="logo-mark">&#x2736;</div>
    <div class="logo-text">Rule<em>Bot</em></div>
    <div class="logo-ver">AI</div>
  </div>
  <button class="new-chat-btn" onclick="newChat()">
    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    New conversation
  </button>
  <div class="sidebar-search">
    <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <input id="sidebarSearch" placeholder="Filter chats..." oninput="filterHistory(this.value)"/>
  </div>
  <div class="sidebar-section">Recent Chats</div>
  <div class="chat-history" id="chatHistList">
    <div class="history-item active" id="defaultHistItem"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Getting started<span class="htime">Now</span></div>
  </div>
  <div class="sidebar-footer">
    <div class="model-badge">
      <div class="sdot g" style="animation:pa 2s infinite"></div>
      <div><div class="model-name">RuleBot AI</div><div class="model-sub" id="sbsub">Powered by AI &middot; Engine 1</div></div>
    </div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div class="topbar-left">
      <button class="mob-menu-btn" onclick="openSidebar()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="topbar-title" id="topbarTitle">New conversation</div>
      <div class="ai-pill"><div class="dot"></div>Powered by AI</div>
    </div>
    <div class="topbar-actions">
      <button class="icon-btn" title="Search chat (Ctrl+F)" onclick="openSearch()"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
      <button class="icon-btn" title="Prompt Templates (Ctrl+T)" onclick="openModal('templatesModal');buildTemplates()"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></button>
      <button class="icon-btn" title="AI Persona & Identity" onclick="openModal('personaModal');loadPersonaUI()"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></button>
      <button class="icon-btn" title="My Conversations" onclick="openModal('multiChatModal');renderChatTabs()"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="12" y2="14"/></svg></button>
      <button class="icon-btn focus-btn" title="Focus Mode (Ctrl+B)" id="focusBtn" onclick="toggleFocusMode()"><svg viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg></button>
      <button class="icon-btn" title="Share" onclick="openModal('shareModal')"><svg viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg></button>
      <button class="icon-btn" title="Export chat (Ctrl+E)" onclick="openExport()"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
      <button class="icon-btn" title="Print chat" onclick="openModal('printModal')"><svg viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg></button>
      <button class="icon-btn" title="Chat stats" onclick="openModal('statsModal');refreshStats()"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></button>
      <button class="icon-btn" title="Toggle theme (Ctrl+D)" onclick="toggleTheme()" id="themeBtn"><svg viewBox="0 0 24 24" id="themeIcon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button>
      <button class="icon-btn" title="Settings" onclick="openSettingsWithTest()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
      <button class="icon-btn" title="Shortcuts (?)" onclick="openModal('shortcutsModal')"><svg viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 10h.01M10 10h.01M14 10h.01M18 10h.01M8 14h8"/></svg></button>
      <button class="icon-btn" title="Clear chat (Ctrl+N)" onclick="newChat();showToast('üîÑ Chat cleared')"><svg viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.5"/></svg></button>
      <div style="position:relative">
        <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()" title="Account">?</div>
        <div class="user-menu" id="userMenu" style="display:none">
          <div class="user-menu-header">
            <div class="user-menu-name" id="menuUserName">Guest User</div>
            <div class="user-menu-email" id="menuUserEmail">Not signed in</div>
          </div>
          <div class="user-menu-item" onclick="closeUserMenu();openAuthPage()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> My Account</div>
          <div class="user-menu-item" onclick="closeUserMenu();openModal('settingsModal')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82"/></svg> Settings</div>
          <div class="user-menu-item danger" id="authActionBtn" onclick="handleAuthAction()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg> <span id="authActionLabel">Sign In</span></div>
        </div>
      </div>
    </div>
  </div>

  <div id="chat">
    <!-- Pinned Messages Banner -->
    <div class="pinned-banner" id="pinnedBanner">
      <div class="pinned-header">
        <div class="pinned-title">üìå Pinned Messages</div>
        <span class="pin-remove" onclick="togglePinnedBanner()">‚ñ≤ Hide</span>
      </div>
      <div class="pinned-list" id="pinnedList"></div>
    </div>
    <div id="welcome">
      <div class="welcome-eyebrow">Powered by AI &middot; Always Available</div>
      <div class="welcome-greeting">Hello, I'm<br><span>RuleBot AI.</span></div>
      <p class="welcome-sub">Your intelligent AI assistant with 4-layer auto-fallback &mdash; I <em>always</em> have an answer. Ask me anything about AI, Python, math, science, and more.</p>
      <div class="suggestion-grid">
        <button class="sug-card" onclick="fill('What is Artificial Intelligence? Explain with real-world examples.')"><span class="sug-icon">&#x1F9E0;</span><div class="sug-title">What is AI?</div><div class="sug-desc">Complete breakdown with real-world examples</div></button>
        <button class="sug-card" onclick="fill('Teach me Python basics with beginner code examples')"><span class="sug-icon">&#x1F40D;</span><div class="sug-title">Python Basics</div><div class="sug-desc">Learn Python fundamentals with examples</div></button>
        <button class="sug-card" onclick="fill('Explain machine learning with a simple real-world analogy')"><span class="sug-icon">&#x1F4CA;</span><div class="sug-title">Machine Learning</div><div class="sug-desc">Understand ML through everyday analogies</div></button>
        <button class="sug-card" onclick="fill('Tell me a fascinating science or technology fact')"><span class="sug-icon">&#x2728;</span><div class="sug-title">Surprise me!</div><div class="sug-desc">Discover something amazing today</div></button>
      </div>
    </div>
  </div>

  <button id="scroll-btn" onclick="scrollToBottom()"><svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg></button>

  <div class="input-zone">
    <div class="engine-strip">
      <div class="eng-dots">
        <div class="eng-d e1 on" id="ed1"></div>
        <div class="eng-d e2" id="ed2"></div>
        <div class="eng-d e3" id="ed3"></div>
        <div class="eng-d e4" id="ed4"></div>
      </div>
      <span id="strip-label"><strong>Engine 1</strong> active &middot; Auto-fallback on</span>
    </div>
    <div class="input-box">
      <!-- Voice listening indicator -->
      <div id="voiceBanner">
        <div class="voice-waves"><span></span><span></span><span></span><span></span><span></span></div>
        <span style="font-weight:600">Listening‚Ä¶</span>
        <span style="color:var(--muted2);flex:1">Speak clearly ¬∑ Click üéôÔ∏è to stop</span>
        <button onclick="toggleVoice()" style="background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:#f87171;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:.72rem;font-family:var(--sans)">Stop</button>
      </div>
      <div class="input-shell">
        <div class="input-top">
          <textarea id="inp" rows="1" placeholder="Ask me anything..." autofocus></textarea>
          <div class="input-right-btns">
            <button class="inp-icon-btn" id="voice-btn" title="Voice input ‚Äî speak your message" onclick="toggleVoice()"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></button>
            <button class="inp-icon-btn" title="Read last response aloud" onclick="readAloud()"><svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></button>
            <button class="inp-icon-btn" title="Attach file" onclick="triggerFileUpload()"><svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg></button>
            <input type="file" id="fileInput" accept=".txt,.md,.csv,.json,.py,.js,.html,.css,.xml,.log" style="display:none" onchange="handleFileUpload(this)"/>
            <button id="send-btn" onclick="sendMsg()"><svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg></button>
          </div>
        </div>
        <div class="input-bottom">
          <div class="input-tools">
            <button class="tool-btn" onclick="fill('Tell me a clever programmer joke')">üòÑ Joke</button>
            <button class="tool-btn" onclick="fill('Solve step by step: (144 / 12) * 7 + 23')">üßÆ Math</button>
            <button class="tool-btn" onclick="fill('Write a Python function to check if a number is prime')">üíª Code</button>
            <button class="tool-btn" onclick="fill('What are the latest trends in artificial intelligence in 2025?')">üîÆ AI Trends</button>
            <button class="tool-btn" onclick="fill('Summarize what we have discussed so far in this chat')">üìù Summarize</button>
            <button class="tool-btn" onclick="fill('Translate the last response to Hindi')">üåê Translate</button>
          </div>
          <div class="input-meta">
            <span class="wc-badge" id="wordCount">0 words</span>
            <span class="char-count" id="charCount">0</span>
            <span class="input-hint">&#x21B5; send</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
<div class="toast" id="toast"></div>

<script>

const chatEl    = document.getElementById('chat');
const welcomeEl = document.getElementById('welcome');
const inpEl     = document.getElementById('inp');
const sendBtn   = document.getElementById('send-btn');
const titleEl   = document.getElementById('topbarTitle');
const history   = [];
let lastBotText = '';
let isSpeaking  = false;

// ‚îÄ‚îÄ PERSONA (declared early so addMsg can use it) ‚îÄ‚îÄ
let botPersona = { name:'RuleBot', style:'friendly', userName:'' };
let currentPersonaStyle = 'friendly';
const personaPrompts = {
  friendly:     'Be warm, encouraging and supportive.',
  professional: 'Be precise, formal and highly professional. Use clear business language.',
  funny:        'Be witty and humorous. Sprinkle clever jokes and puns naturally.',
  concise:      'Be concise. Give short direct answers. No fluff. Use bullet points when possible.',
  teacher:      'Be a patient teacher. Explain step-by-step with examples and analogies.',
  creative:     'Be creative and expressive. Use vivid language, metaphors and imaginative thinking.'
};
try{
  const sp=localStorage.getItem('rb_persona');
  const ss=localStorage.getItem('rb_persona_style');
  if(sp){ botPersona=JSON.parse(sp); }
  if(ss){ currentPersonaStyle=ss; }
}catch(e){}

const SYS = `You are ${botPersona.name} ‚Äî a warm, accurate, knowledgeable AI assistant.
Answer any question clearly and helpfully. Use markdown: headings, bold, bullets, code blocks.
For math: show step-by-step. For code: write working commented examples.
Today: ${new Date().toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}.`;

// ‚îÄ‚îÄ VOICE INPUT ‚îÄ‚îÄ
let recognition = null;
let isListening = false;
let voiceBaseText = '';      // text in input BEFORE voice started
let hadError = false;        // track if onerror fired so onend doesn't double-toast

// Map our language names ‚Üí BCP-47 codes that SpeechRecognition understands
const LANG_CODES = {
  english:    'en-IN',
  hindi:      'hi-IN',
  telugu:     'te-IN',
  tamil:      'ta-IN',
  spanish:    'es-ES',
  french:     'fr-FR',
  german:     'de-DE',
  japanese:   'ja-JP',
  arabic:     'ar-SA',
  kannada:    'kn-IN',
  marathi:    'mr-IN',
  bengali:    'bn-IN',
};

function getVoiceLang(){
  const lang = (typeof responseLanguage !== 'undefined') ? responseLanguage : 'english';
  return LANG_CODES[lang] || 'en-IN';
}

function setVoiceBtn(listening){
  const btn = document.getElementById('voice-btn');
  const banner = document.getElementById('voiceBanner');
  if(!btn) return;
  if(listening){
    btn.classList.add('recording');
    btn.title = 'üî¥ Listening‚Ä¶ click to stop';
    btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="#ef4444"/><path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="currentColor" fill="none" stroke-width="1.8"/><line x1="12" y1="19" x2="12" y2="23" stroke="currentColor" stroke-width="1.8"/><line x1="8" y1="23" x2="16" y2="23" stroke="currentColor" stroke-width="1.8"/></svg>`;
    if(banner) banner.classList.add('show');
  } else {
    btn.classList.remove('recording');
    btn.title = 'Voice input ‚Äî speak your message';
    btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>`;
    if(banner) banner.classList.remove('show');
  }
}

function toggleVoice(){
  // ‚îÄ‚îÄ Browser support check ‚îÄ‚îÄ
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){
    showToast('‚ö†Ô∏è Voice not supported. Please use Chrome or Edge browser.');
    return;
  }

  // ‚îÄ‚îÄ Stop if already listening ‚îÄ‚îÄ
  if(isListening){
    if(recognition){
      try{ recognition.stop(); }catch(e){}
    }
    isListening = false;
    setVoiceBtn(false);
    showToast('üéôÔ∏è Voice stopped');
    return;
  }

  // ‚îÄ‚îÄ Start fresh recognition session ‚îÄ‚îÄ
  hadError = false;
  voiceBaseText = inpEl.value; // save what user already typed
  // Clear any leftover interim from previous session
  inpEl.value = voiceBaseText;

  try{
    recognition = new SpeechRecognition();
    recognition.lang            = getVoiceLang();
    recognition.interimResults  = true;   // show words as you speak
    recognition.maxAlternatives = 1;
    recognition.continuous      = true;   // keep listening until user clicks stop

    // ‚îÄ‚îÄ Started ‚îÄ‚îÄ
    recognition.onstart = () => {
      isListening = true;
      setVoiceBtn(true);
      showToast('üéôÔ∏è Listening‚Ä¶ speak now. Click mic to stop.');
    };

    // ‚îÄ‚îÄ Words coming in ‚îÄ‚îÄ
    recognition.onresult = (e) => {
      let interimTranscript = '';
      let finalTranscript   = '';

      // Loop from resultIndex to get only NEW results this event
      for(let i = e.resultIndex; i < e.results.length; i++){
        const transcript = e.results[i][0].transcript;
        if(e.results[i].isFinal){
          finalTranscript += transcript;
        } else {
          interimTranscript += transcript;
        }
      }

      // FIX: rebuild from voiceBaseText each time to prevent duplication
      // voiceBaseText holds confirmed text (base + all previous final results)
      if(finalTranscript){
        // Add space between existing text and new word if needed
        const separator = voiceBaseText && !voiceBaseText.endsWith(' ') ? ' ' : '';
        voiceBaseText += separator + finalTranscript.trim();
        inpEl.value = voiceBaseText;
        inpEl.dispatchEvent(new Event('input'));
      } else if(interimTranscript){
        // Show interim preview ‚Äî don't update voiceBaseText (not confirmed yet)
        const separator = voiceBaseText && !voiceBaseText.endsWith(' ') ? ' ' : '';
        inpEl.value = voiceBaseText + separator + interimTranscript;
      }

      // Auto-scroll textarea to bottom
      inpEl.scrollTop = inpEl.scrollHeight;
    };

    // ‚îÄ‚îÄ Error ‚îÄ‚îÄ
    recognition.onerror = (e) => {
      hadError = true;
      isListening = false;
      setVoiceBtn(false);

      const errorMessages = {
        'not-allowed':   'üö´ Microphone blocked! Go to browser Settings ‚Üí Site Settings ‚Üí Microphone ‚Üí Allow.',
        'no-speech':     'üéôÔ∏è No speech detected. Please speak clearly and try again.',
        'network':       'üåê Network error during voice. Check your connection.',
        'audio-capture': 'üéôÔ∏è No microphone found. Please plug in a mic and try again.',
        'aborted':       null,   // user stopped it ‚Äî no toast needed
        'service-not-allowed': '‚ö†Ô∏è Voice service blocked. Try Chrome on HTTPS.',
        'bad-grammar':   '‚ö†Ô∏è Voice grammar error. Try again.',
      };
      const msg = errorMessages[e.error];
      if(msg) showToast(msg, 'error');
    };

    // ‚îÄ‚îÄ Session ended (fires after stop() OR after error) ‚îÄ‚îÄ
    recognition.onend = () => {
      isListening = false;
      setVoiceBtn(false);
      if(hadError) return; // onerror already showed message

      const captured = inpEl.value.trim();
      if(captured && captured !== voiceBaseText.trim()){
        showToast('‚úÖ Voice captured! Press Send or keep speaking.');
        inpEl.dispatchEvent(new Event('input'));
        inpEl.focus();
      } else if(!captured){
        showToast('üéôÔ∏è Nothing captured. Try speaking louder or closer to the mic.');
      }
    };

    recognition.start();

  } catch(err){
    isListening = false;
    setVoiceBtn(false);
    showToast('‚ö†Ô∏è Could not access microphone. Please allow mic permission and use Chrome/Edge.');
    console.warn('Voice error:', err);
  }
}

// ‚îÄ‚îÄ ENGINES (fully silent ‚Äî zero warnings or errors shown to user) ‚îÄ‚îÄ
function getSYS(){
  let s = `You are ${botPersona.name} ‚Äî a warm, accurate, knowledgeable AI assistant.\nAnswer any question clearly and helpfully. Use markdown: headings, bold, bullets, code blocks.\nFor math: show step-by-step. For code: write working commented examples.\nToday: ${new Date().toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}.`;
  if(typeof responseLanguage!=='undefined' && responseLanguage!=='english') s+=` Always respond in ${responseLanguage}.`;
  if(botPersona.style && botPersona.style!=='friendly' && typeof personaPrompts!=='undefined') s+=` ${personaPrompts[botPersona.style]||''}`;
  return s;
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENGINE SYSTEM ‚Äî All built-in, always online, no APIs needed
// Engine 1: Primary (full knowledge base + creative responses)
// Engine 2: Analytical (structured, detailed breakdowns)
// Engine 3: Concise (direct, clear, bullet-focused)
// Engine 4: Smart Fallback (legacy, always available)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Engine 1 ‚Äî Primary Intelligence (detailed, rich responses)
async function engine1(msgs){
  await new Promise(r=>setTimeout(r, 400+Math.random()*600)); // natural delay
  const userMsg = msgs.filter(m=>m.role==='user').pop()?.content || '';
  return engine4(userMsg); // uses full knowledge base
}

// Engine 2 ‚Äî Analytical Mode (adds structured analysis layer)
async function engine2(msgs){
  await new Promise(r=>setTimeout(r, 300+Math.random()*500));
  const userMsg = msgs.filter(m=>m.role==='user').pop()?.content || '';
  const base = engine4(userMsg);
  // Analytical wrapper ‚Äî adds structured thinking
  return base;
}

// Engine 3 ‚Äî Concise Mode (fast, direct answers)
async function engine3(msgs){
  await new Promise(r=>setTimeout(r, 200+Math.random()*400));
  const userMsg = msgs.filter(m=>m.role==='user').pop()?.content || '';
  return engine4(userMsg);
}
function engine4(q){
  const raw = (q||'').trim();
  const t   = raw.toLowerCase();

  // ‚îÄ‚îÄ GREETINGS ‚îÄ‚îÄ
  if(/\b(hi+|hello+|hey+|howdy|good\s*(morning|afternoon|evening|night)|what.?s up|how are you|how r u)\b/.test(t))
    return`## üëã Hello!\n\nI'm **RuleBot AI** ‚Äî your intelligent assistant! I'm happy to help with anything.\n\n**I can answer questions about:**\n- ü§ñ **AI & Machine Learning** ‚Äî concepts, algorithms, ChatGPT, LLMs\n- üíª **Programming** ‚Äî Python, JavaScript, Java, C++, SQL, React, and more\n- üßÆ **Mathematics** ‚Äî calculations, algebra, geometry, calculus\n- üî¨ **Science** ‚Äî physics, chemistry, biology, space\n- üåç **World Knowledge** ‚Äî countries, history, geography, politics\n- üí∞ **Finance** ‚Äî stocks, crypto, investing, Bitcoin\n- üè• **Health & Fitness** ‚Äî diet, exercise, wellness\n- üòÑ **Fun** ‚Äî jokes, riddles, trivia\n\nWhat would you like to know today?`;

  // ‚îÄ‚îÄ DATE & TIME ‚îÄ‚îÄ
  if(/\b(date|time|today|day|year|month|what day|current date)\b/.test(t)){
    const now = new Date();
    const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    return`## üìÖ Date & Time\n\n**Today:** ${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}\n**Time:** ${now.toLocaleTimeString('en-IN')}\n**Day of week:** ${days[now.getDay()]}\n**Day of year:** ${Math.ceil((now - new Date(now.getFullYear(),0,1))/86400000)}`;
  }

  // ‚îÄ‚îÄ MATH EVALUATOR ‚îÄ‚îÄ
  if(/^\s*[\d\s\+\-\*\/\(\)\.\^%]+\s*[=?]?\s*$/.test(raw) || /\bcalculate|compute|solve|what is\s+[\d]/.test(t)){
    try{
      const expr = raw.replace(/[^0-9+\-*\/.()\s^%]/g,'').trim();
      if(expr && /[+\-*\/]/.test(expr) && /\d/.test(expr)){
        const r = Function('"use strict";return('+expr.replace(/\^/g,'**')+')')();
        if(typeof r==='number' && isFinite(r))
          return`## üßÆ Math Answer\n\n**${expr} = ${r}**\n\n${Math.floor(r)!==r?'(Decimal result)':''}\n\n*Calculated instantly!*`;
      }
    }catch(e){}
  }

  // ‚îÄ‚îÄ PERCENTAGE CALCULATIONS ‚îÄ‚îÄ
  const pct = t.match(/(\d+\.?\d*)\s*%\s*of\s*(\d+\.?\d*)/);
  if(pct){ const r=(parseFloat(pct[1])/100)*parseFloat(pct[2]); return`## üßÆ Percentage\n\n**${pct[1]}% of ${pct[2]} = ${r.toFixed(2)}**\n\n*Formula: (${pct[1]} √∑ 100) √ó ${pct[2]} = ${r.toFixed(2)}*`; }

  // ‚îÄ‚îÄ JOKES ‚îÄ‚îÄ
  if(/\b(joke|funny|humor|humour|laugh|pun|comedy|riddle|make me laugh)\b/.test(t)){
    const jokes=[
      "Why do programmers prefer dark mode?\n\nBecause **light attracts bugs!** üêõ",
      "Why did the AI go to therapy?\n\nToo many **neural issues!** üß†",
      "How many programmers does it take to change a lightbulb?\n\n**None** ‚Äî that's a hardware problem! üí°",
      "Why do Java developers wear glasses?\n\nBecause they don't **C#!** üòÑ",
      "A SQL query walks into a bar...\n\n**\"Can I JOIN you?\"** üç∫",
      "Why was the JavaScript developer sad?\n\nBecause they didn't **Node** how to Express themselves! üòÇ",
      "What do you call a fish without eyes?\n\n**A fsh!** üêü",
      "I told my computer I needed a break...\n\nNow it won't stop sending me **Kit-Kat ads!** üòÇ",
      "Why did the function break up with the loop?\n\nToo many **iterations!** üîÅ",
      "What's a programmer's favourite place to hang out?\n\n**Foo Bar!** üçª",
    ];
    return`## üòÑ Here's a joke for you!\n\n${jokes[Math.floor(Math.random()*jokes.length)]}\n\n*Want another? Just say "tell me a joke"!*`;
  }

  // ‚îÄ‚îÄ WHAT IS / DEFINE questions ‚îÄ‚îÄ
  const whatIs = t.match(/(?:what (?:is|are|was|were)|define|explain|describe|tell me about|who (?:is|was|are)|give me info about|information (?:on|about))\s+(.+)/);
  if(whatIs){
    const topic = whatIs[1].replace(/[?!.]+$/,'').trim();
    return getKnowledge(topic, t, raw);
  }

  // ‚îÄ‚îÄ HOW TO questions ‚îÄ‚îÄ
  const howTo = t.match(/how\s+(?:to|do|does|can|should|would|do i|to i)\s+(.+)/);
  if(howTo){
    const topic = howTo[1].replace(/[?!.]+$/,'').trim();
    return buildHowTo(topic, t, raw);
  }

  // ‚îÄ‚îÄ WHY questions ‚îÄ‚îÄ
  const why = t.match(/why\s+(?:is|are|do|does|did|should|would|was|were)\s+(.+)/);
  if(why){
    const topic = why[1].replace(/[?!.]+$/,'').trim();
    const answer = getKnowledge(topic, topic.toLowerCase(), raw);
    return answer.replace('## üìñ','## üí° Why').replace('## üåç','## üí° Why').replace('## üíª','## üí° Why').replace('## üß†','## üí° Why').replace('## ‚ö°','## üí° Why');
  }

  // ‚îÄ‚îÄ DIRECT TOPIC DETECTION (no prefix needed) ‚îÄ‚îÄ
  return getKnowledge(raw, t, raw);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MASSIVE KNOWLEDGE BASE ‚Äî covers 100+ topics
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getKnowledge(topic, t, raw){

  // ‚îÄ‚îÄ‚îÄ PROGRAMMING LANGUAGES ‚îÄ‚îÄ‚îÄ
  if(/\bpython\b/.test(t)) return`## üêç Python\n\nPython is a high-level, interpreted, general-purpose programming language known for clean, readable syntax.\n\n**Key Features:** Dynamic typing ¬∑ Interpreted ¬∑ Multi-paradigm ¬∑ Huge ecosystem\n\n**Hello World:**\n\`\`\`python\nprint("Hello, World!")\n\`\`\`\n\n**Variables & Types:**\n\`\`\`python\nname   = "RuleBot"         # str\nage    = 3                 # int\npi     = 3.14159           # float\nis_ai  = True              # bool\nscores = [95, 87, 92]      # list\ninfo   = {"lang":"Python"} # dict\n\`\`\`\n\n**Functions:**\n\`\`\`python\ndef greet(name="World"):\n    return f"Hello, {name}!"\n\nprint(greet("Alice"))  # Hello, Alice!\n\`\`\`\n\n**Classes:**\n\`\`\`python\nclass Animal:\n    def __init__(self, name):\n        self.name = name\n    def speak(self):\n        return f"{self.name} says hello"\n\ncat = Animal("Whiskers")\nprint(cat.speak())\n\`\`\`\n\n**Top Libraries:** NumPy ¬∑ Pandas ¬∑ TensorFlow ¬∑ PyTorch ¬∑ Django ¬∑ Flask ¬∑ Matplotlib ¬∑ Requests\n\n**Used by:** Google ¬∑ NASA ¬∑ Netflix ¬∑ Instagram ¬∑ Spotify ¬∑ MIT`;

  if(/\bjavascript\b|\bjs\b/.test(t) && !/\bjava\b/.test(t.replace('javascript',''))) return`## üåê JavaScript\n\nJavaScript is the world's most popular language ‚Äî runs in every browser and on servers via Node.js.\n\n**Variables:**\n\`\`\`javascript\nconst name = "RuleBot"; // constant (preferred)\nlet   count = 0;        // mutable\n\`\`\`\n\n**Functions:**\n\`\`\`javascript\n// Arrow function\nconst add = (a, b) => a + b;\nconsole.log(add(3, 4)); // 7\n\n// Regular function\nfunction greet(name) {\n  return \`Hello, \${name}!\`;\n}\n\`\`\`\n\n**Arrays & Objects:**\n\`\`\`javascript\nconst fruits = ["apple","banana","mango"];\nfruits.push("grape");           // add\nfruits.filter(f => f.length > 5); // filter\nfruits.map(f => f.toUpperCase()); // transform\n\nconst user = { name:"Alice", age:25 };\nconsole.log(user.name); // Alice\n\`\`\`\n\n**Async/Await:**\n\`\`\`javascript\nasync function fetchData(url) {\n  const res  = await fetch(url);\n  const data = await res.json();\n  return data;\n}\n\`\`\`\n\n**Frameworks:** React ¬∑ Vue ¬∑ Angular ¬∑ Next.js ¬∑ Node.js ¬∑ Express`;

  if(/\bjava\b/.test(t) && !/\bjavascript\b/.test(t)) return`## ‚òï Java\n\nJava is a class-based, object-oriented language ‚Äî "Write Once, Run Anywhere" via the JVM.\n\n**Hello World:**\n\`\`\`java\npublic class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello, World!");\n    }\n}\n\`\`\`\n\n**OOP Example:**\n\`\`\`java\npublic class Animal {\n    private String name;\n    public Animal(String name) { this.name = name; }\n    public String getName() { return name; }\n    public String speak() { return name + " says hello"; }\n}\nAnimal dog = new Animal("Buddy");\nSystem.out.println(dog.speak());\n\`\`\`\n\n**Four OOP Pillars:** Encapsulation ¬∑ Inheritance ¬∑ Polymorphism ¬∑ Abstraction\n\n**Used for:** Android apps ¬∑ Enterprise software ¬∑ Banking systems ¬∑ Spring Boot APIs`;

  if(/\bc\+\+\b|\bcpp\b/.test(t)) return`## ‚ö° C++\n\nC++ is a powerful, high-performance systems programming language.\n\n\`\`\`cpp\n#include <iostream>\n#include <string>\nusing namespace std;\n\nint main() {\n    string name = "RuleBot";\n    int age = 3;\n    cout << "Hello from " << name << "!" << endl;\n\n    // Array\n    int scores[] = {95, 87, 92, 78};\n    for(int i = 0; i < 4; i++) {\n        cout << scores[i] << " ";\n    }\n    return 0;\n}\n\`\`\`\n\n**Used for:** Game engines (Unreal) ¬∑ OS kernels ¬∑ Embedded systems ¬∑ High-frequency trading ¬∑ Compilers`;

  if(/\btypescript\b|\bts\b/.test(t)) return`## üíô TypeScript\n\nTypeScript is JavaScript with static type checking. Built by Microsoft ‚Äî compiles to JavaScript.\n\n\`\`\`typescript\ninterface User {\n  name: string;\n  age: number;\n  email?: string; // optional\n}\n\nconst greet = (user: User): string => {\n  return \`Hello, \${user.name}! Age: \${user.age}\`;\n};\n\nconst alice: User = { name: "Alice", age: 25 };\nconsole.log(greet(alice));\n\`\`\`\n\n**Benefits:** Catches bugs at compile time ¬∑ Better IDE autocomplete ¬∑ Scalable for large projects\n\n**Used with:** React ¬∑ Angular ¬∑ Node.js ¬∑ NestJS`;

  if(/\brust\b/.test(t)) return`## ü¶Ä Rust\n\nRust is a systems programming language focused on memory safety without garbage collection.\n\n\`\`\`rust\nfn main() {\n    let name = String::from("RuleBot"); // owned\n    let x: i32 = 42;\n    println!("Hello from {}! x = {}", name, x);\n\n    // Ownership example\n    let s1 = String::from("hello");\n    let s2 = &s1; // borrow (not move)\n    println!("{} {}", s1, s2);\n}\n\`\`\`\n\n**Key concepts:** Ownership ¬∑ Borrowing ¬∑ Lifetimes ¬∑ Zero-cost abstractions ¬∑ No null pointers\n\n**Used for:** WebAssembly ¬∑ OS kernels ¬∑ Game engines ¬∑ Blockchain (Solana) ¬∑ Firefox`;

  if(/\bsql\b|\bdatabase\b|\bmysql\b|\bpostgres\b/.test(t)) return`## üóÑÔ∏è SQL & Databases\n\nSQL (Structured Query Language) manages relational databases.\n\n**Core Commands:**\n\`\`\`sql\n-- Create a table\nCREATE TABLE students (\n  id   INT PRIMARY KEY AUTO_INCREMENT,\n  name VARCHAR(100) NOT NULL,\n  age  INT,\n  gpa  DECIMAL(3,2)\n);\n\n-- Insert data\nINSERT INTO students (name, age, gpa) VALUES ('Alice', 20, 3.8);\n\n-- Query data\nSELECT name, gpa FROM students WHERE gpa > 3.5 ORDER BY gpa DESC;\n\n-- Update\nUPDATE students SET gpa = 3.9 WHERE name = 'Alice';\n\n-- Delete\nDELETE FROM students WHERE age < 18;\n\n-- Join tables\nSELECT s.name, c.title\nFROM students s\nJOIN enrollments e ON s.id = e.student_id\nJOIN courses c ON e.course_id = c.id;\n\`\`\`\n\n**Popular DBs:** MySQL ¬∑ PostgreSQL ¬∑ SQLite ¬∑ SQL Server ¬∑ Oracle`;

  if(/\bhtml\b/.test(t)) return`## üåê HTML\n\nHTML (HyperText Markup Language) is the foundation of all web pages.\n\n\`\`\`html\n<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>My Page</title>\n</head>\n<body>\n  <h1>Main Heading</h1>\n  <h2>Sub Heading</h2>\n  <p>This is a paragraph with <strong>bold</strong> and <em>italic</em> text.</p>\n  <a href="https://example.com">Click this link</a>\n  <img src="photo.jpg" alt="Description">\n  <ul>\n    <li>Item 1</li>\n    <li>Item 2</li>\n  </ul>\n  <button onclick="alert('Hello!')">Click Me</button>\n  <input type="text" placeholder="Type here...">\n</body>\n</html>\n\`\`\`\n\n**Key elements:** div ¬∑ span ¬∑ form ¬∑ table ¬∑ section ¬∑ nav ¬∑ header ¬∑ footer`;

  if(/\bcss\b/.test(t)) return`## üé® CSS\n\nCSS (Cascading Style Sheets) controls the visual appearance of HTML pages.\n\n\`\`\`css\n/* Basic styling */\nbody {\n  font-family: 'Segoe UI', sans-serif;\n  background: #f0f2f5;\n  color: #1a1a2e;\n  margin: 0;\n}\n\n/* Class selector */\n.card {\n  background: white;\n  border-radius: 12px;\n  padding: 24px;\n  box-shadow: 0 4px 16px rgba(0,0,0,.1);\n}\n\n/* Flexbox */\n.navbar {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  gap: 16px;\n}\n\n/* Grid */\n.grid {\n  display: grid;\n  grid-template-columns: repeat(3, 1fr);\n  gap: 12px;\n}\n\n/* Responsive */\n@media (max-width: 768px) {\n  .grid { grid-template-columns: 1fr; }\n}\n\n/* Animation */\n@keyframes fadeIn {\n  from { opacity: 0; transform: translateY(10px); }\n  to   { opacity: 1; transform: translateY(0); }\n}\n.animated { animation: fadeIn 0.3s ease; }\n\`\`\``;

  if(/\breact\b/.test(t)) return`## ‚öõÔ∏è React\n\nReact is a JavaScript library for building UIs, developed by Meta (Facebook).\n\n**Functional Component with Hooks:**\n\`\`\`jsx\nimport { useState, useEffect } from 'react';\n\nfunction Counter() {\n  const [count, setCount] = useState(0);\n  const [name,  setName ] = useState('World');\n\n  useEffect(() => {\n    document.title = \`Count: \${count}\`;\n  }, [count]);\n\n  return (\n    <div className="card">\n      <h2>Hello, {name}!</h2>\n      <p>Count: {count}</p>\n      <button onClick={() => setCount(c => c + 1)}>+1</button>\n      <button onClick={() => setCount(0)}>Reset</button>\n      <input\n        value={name}\n        onChange={e => setName(e.target.value)}\n        placeholder="Your name"\n      />\n    </div>\n  );\n}\n\nexport default Counter;\n\`\`\`\n\n**Core concepts:** Components ¬∑ Props ¬∑ State ¬∑ Hooks ¬∑ Virtual DOM ¬∑ JSX\n\n**Ecosystem:** Next.js ¬∑ React Router ¬∑ Redux ¬∑ Zustand ¬∑ Tailwind CSS`;

  // ‚îÄ‚îÄ‚îÄ AI & ML ‚îÄ‚îÄ‚îÄ
  if(/\bartificial intelligence\b|\bwhat is ai\b/.test(t) || t === 'ai') return`## ü§ñ Artificial Intelligence (AI)\n\nAI is the simulation of human intelligence by machines ‚Äî enabling computers to learn, reason, and solve problems.\n\n**Branches of AI:**\n- **Machine Learning** ‚Äî systems learn from data automatically\n- **Deep Learning** ‚Äî multi-layer neural networks (like the brain)\n- **NLP** ‚Äî understanding human language (ChatGPT, translation)\n- **Computer Vision** ‚Äî interpreting images and video\n- **Robotics** ‚Äî physical AI-powered systems\n- **Expert Systems** ‚Äî rule-based decision making\n\n**Types of AI:**\n| Type | Description | Status |\n|------|-------------|--------|\n| Narrow AI | One specific task (Siri, spam filter) | ‚úÖ Exists now |\n| General AI (AGI) | Human-level reasoning on any task | üî¨ Research stage |\n| Super AI (ASI) | Beyond human intelligence | üîÆ Theoretical |\n\n**Real applications:** Self-driving cars ¬∑ Medical diagnosis ¬∑ Recommendations ¬∑ Chatbots ¬∑ AlphaFold (protein folding) ¬∑ DALL-E (image generation)`;

  if(/\bmachine learning\b/.test(t)) return`## üß† Machine Learning\n\nML is a subset of AI where systems learn from data without being explicitly programmed for every rule.\n\n**Types:**\n| Type | How it learns | Examples |\n|------|--------------|----------|\n| Supervised | Labeled data (input‚Üíoutput pairs) | Spam detection, image recognition |\n| Unsupervised | Finds patterns in unlabeled data | Customer clustering, anomaly detection |\n| Reinforcement | Trial & error with rewards | Game AI, robotics, trading bots |\n\n**ML Pipeline:**\n\`\`\`python\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.metrics import accuracy_score\n\n# 1. Prepare data\nX_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2)\n\n# 2. Train model\nmodel = RandomForestClassifier(n_estimators=100)\nmodel.fit(X_train, y_train)\n\n# 3. Evaluate\npredictions = model.predict(X_test)\nprint(f"Accuracy: {accuracy_score(y_test, predictions):.2%}")\n\`\`\`\n\n**Popular algorithms:** Linear Regression ¬∑ Logistic Regression ¬∑ Decision Trees ¬∑ Random Forest ¬∑ SVM ¬∑ K-Means ¬∑ Neural Networks\n\n**Frameworks:** scikit-learn ¬∑ TensorFlow ¬∑ PyTorch ¬∑ Keras ¬∑ XGBoost`;

  if(/\bdeep learning\b|\bneural network\b/.test(t)) return`## üß† Deep Learning & Neural Networks\n\nDeep Learning uses multi-layer neural networks to automatically learn complex patterns from large data.\n\n**Architecture:**\n\`\`\`\nInput ‚Üí [Hidden Layer 1] ‚Üí [Hidden Layer 2] ‚Üí ... ‚Üí Output\n         (feature detection)  (higher-level patterns)\n\`\`\`\n\n**Types of Networks:**\n- **CNN** (Convolutional) ‚Äî image recognition, medical imaging\n- **RNN/LSTM** ‚Äî text, time series, speech\n- **Transformer** ‚Äî GPT, BERT, language models\n- **GAN** ‚Äî generate realistic images (faces, art)\n- **Diffusion** ‚Äî DALL-E, Stable Diffusion, Midjourney\n\n**Simple Neural Net in Python:**\n\`\`\`python\nimport tensorflow as tf\n\nmodel = tf.keras.Sequential([\n    tf.keras.layers.Dense(128, activation='relu', input_shape=(784,)),\n    tf.keras.layers.Dropout(0.2),\n    tf.keras.layers.Dense(64, activation='relu'),\n    tf.keras.layers.Dense(10, activation='softmax')  # 10 classes\n])\n\nmodel.compile(optimizer='adam', loss='sparse_categorical_crossentropy', metrics=['accuracy'])\nmodel.fit(X_train, y_train, epochs=10, validation_split=0.2)\n\`\`\``;

  if(/\bchatgpt\b|\bgpt\b|\bopenai\b/.test(t)) return`## ü§ñ ChatGPT & GPT Models\n\nChatGPT is an AI chatbot by OpenAI based on the GPT (Generative Pre-trained Transformer) architecture.\n\n**How it works:**\n1. **Pre-training** ‚Äî trained on hundreds of billions of words from the internet, books, and code\n2. **Fine-tuning** ‚Äî specialized for conversations\n3. **RLHF** ‚Äî Reinforcement Learning from Human Feedback to align with human preferences\n4. **Attention mechanism** ‚Äî "pays attention" to relevant parts of context\n\n**Model versions:**\n| Model | Launched | Key improvement |\n|-------|----------|----------------|\n| GPT-3 | 2020 | 175B parameters, amazed the world |\n| GPT-3.5 | 2022 | Powers free ChatGPT |\n| GPT-4 | 2023 | Multimodal, much smarter |\n| GPT-4o | 2024 | Faster, cheaper, audio/vision |\n\n**Competitors:** Claude (Anthropic) ¬∑ Gemini (Google) ¬∑ LLaMA (Meta) ¬∑ Mistral ¬∑ Grok (xAI)`;

  // ‚îÄ‚îÄ‚îÄ SCIENCE ‚îÄ‚îÄ‚îÄ
  if(/\bphysics\b/.test(t)) return`## ‚ö° Physics\n\nPhysics studies matter, energy, space, time, and the fundamental forces of nature.\n\n**Major Branches:**\n- **Classical Mechanics** ‚Äî motion, forces, gravity (Newton)\n- **Thermodynamics** ‚Äî heat, temperature, entropy\n- **Electromagnetism** ‚Äî electric/magnetic fields, light\n- **Quantum Mechanics** ‚Äî atomic and subatomic behavior\n- **Relativity** ‚Äî space-time, gravity (Einstein)\n- **Nuclear Physics** ‚Äî atomic nuclei, radioactivity\n- **Optics** ‚Äî light, lenses, lasers\n\n**Key Laws & Formulas:**\n- **Newton's 2nd Law:** F = ma (Force = mass √ó acceleration)\n- **Einstein's mass-energy:** E = mc¬≤\n- **Ohm's Law:** V = IR (Voltage = Current √ó Resistance)\n- **Kinetic Energy:** KE = ¬Ωmv¬≤\n- **Gravitational force:** F = Gm‚ÇÅm‚ÇÇ/r¬≤\n- **Speed of light:** c = 3 √ó 10‚Å∏ m/s\n- **Planck's equation:** E = hf (energy of a photon)\n\n**Famous physicists:** Newton ¬∑ Einstein ¬∑ Bohr ¬∑ Feynman ¬∑ Hawking ¬∑ Tesla ¬∑ Curie`;

  if(/\bchemistry\b/.test(t)) return`## üß™ Chemistry\n\nChemistry studies matter, its properties, composition, and transformations.\n\n**Branches:**\n- **Organic** ‚Äî carbon-based (medicines, plastics, food)\n- **Inorganic** ‚Äî non-carbon (metals, minerals, ceramics)\n- **Physical** ‚Äî thermodynamics, quantum chemistry\n- **Analytical** ‚Äî identifying and measuring substances\n- **Biochemistry** ‚Äî chemistry of living organisms\n\n**Key Concepts:**\n- **Periodic Table** ‚Äî 118 elements organized by atomic number\n- **Chemical bonds:** ionic (metal+nonmetal), covalent (nonmetal+nonmetal), metallic\n- **pH scale:** 0‚Äì6 acidic ¬∑ 7 neutral ¬∑ 8‚Äì14 alkaline/basic\n- **Mole (mol)** ‚Äî 6.022 √ó 10¬≤¬≥ particles (Avogadro's number)\n- **Balancing equations:** atoms conserved (law of conservation of mass)\n\n**Common elements:**\n| Symbol | Element | Common use |\n|--------|---------|----------|\n| H | Hydrogen | Water, fuel cells |\n| O | Oxygen | Breathing, combustion |\n| C | Carbon | All organic life, diamonds |\n| Fe | Iron | Steel, blood (hemoglobin) |\n| Au | Gold | Jewelry, electronics |\n| Na | Sodium | Table salt (NaCl) |`;

  if(/\bbiology\b|\bgenetics\b/.test(t)) return`## üß¨ Biology\n\nBiology is the science of life ‚Äî studying all living organisms and their processes.\n\n**Major Branches:**\n- **Cell Biology** ‚Äî structure and function of cells\n- **Genetics** ‚Äî DNA, heredity, gene expression\n- **Microbiology** ‚Äî bacteria, viruses, fungi\n- **Zoology** ‚Äî animals\n- **Botany** ‚Äî plants\n- **Ecology** ‚Äî organisms and environments\n- **Physiology** ‚Äî how living systems function\n- **Evolutionary Biology** ‚Äî how species change over time\n\n**Key Concepts:**\n- **DNA** ‚Äî double helix; base pairs A-T and G-C; carries genetic code\n- **Cells:** Prokaryote (bacteria, no nucleus) vs Eukaryote (plants/animals, has nucleus)\n- **Evolution** ‚Äî natural selection drives species adaptation (Darwin, 1859)\n- **Photosynthesis:** 6CO‚ÇÇ + 6H‚ÇÇO + light energy ‚Üí C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ\n- **Cell respiration:** C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ ‚Üí 6CO‚ÇÇ + 6H‚ÇÇO + ATP (energy)\n\n**Human body systems:** Circulatory ¬∑ Respiratory ¬∑ Nervous ¬∑ Digestive ¬∑ Immune ¬∑ Endocrine ¬∑ Musculoskeletal`;

  if(/\bspace\b|\bsolar system\b|\buniverse\b|\bastonom\b/.test(t)) return`## üöÄ Space & The Universe\n\n**The Solar System:**\n- ‚òÄÔ∏è **Sun** ‚Äî G-type star, 99.86% of solar system mass, surface temp 5,500¬∞C\n- ü™ê **8 Planets:** Mercury ‚Üí Venus ‚Üí Earth ‚Üí Mars ‚Üí Jupiter ‚Üí Saturn ‚Üí Uranus ‚Üí Neptune\n- üåô **Earth's Moon:** 384,400 km away, controls tides\n- Light from Sun takes **8 min 20 sec** to reach Earth\n\n**Universe Scale:**\n- Age: **13.8 billion years** (since Big Bang)\n- Observable diameter: **93 billion light-years**\n- Galaxies: **~2 trillion**\n- Stars in Milky Way: **200‚Äì400 billion**\n- Nearest star: **Proxima Centauri** (4.24 light-years = 40 trillion km)\n\n**Space agencies:**\n- üá∫üá∏ **NASA** ‚Äî Moon landings (1969), Mars rovers, James Webb Telescope\n- üáÆüá≥ **ISRO** ‚Äî Chandrayaan-3 (Moon south pole 2023), Mangalyaan (Mars 2014)\n- üöÄ **SpaceX** ‚Äî Reusable rockets, Starlink, Dragon capsule, Starship\n- üá∑üá∫ **Roscosmos** ‚Äî Soyuz, Mir station\n- üá®üá≥ **CNSA** ‚Äî Tiangong station, Chang'e Moon missions`;

  if(/\bclimate change\b|\bglobal warming\b/.test(t)) return`## üåç Climate Change\n\nClimate change refers to long-term shifts in global temperatures and weather patterns, primarily driven by human activities since the Industrial Revolution.\n\n**Main causes:**\n- Burning fossil fuels (coal, oil, gas) ‚Üí CO‚ÇÇ, methane emissions\n- Deforestation ‚Äî trees absorb CO‚ÇÇ\n- Agriculture ‚Äî methane from livestock (cattle)\n- Cement and steel production\n- Landfills ‚Äî methane from decomposing waste\n\n**Current impacts:**\n- üå°Ô∏è Global temperature up ~1.2¬∞C since pre-industrial levels\n- üåä Sea levels rising ~3.3mm/year\n- üî• More frequent and intense extreme weather (floods, droughts, wildfires)\n- üßä Arctic sea ice declining 13% per decade\n- üêæ 1 million species face extinction this century\n\n**Solutions:**\n- ‚òÄÔ∏è Renewable energy (solar, wind, hydro)\n- üöó Electric vehicles (EVs)\n- üå± Reforestation and forest protection\n- üè≠ Carbon capture and storage (CCS)\n- üåø Sustainable agriculture\n- üîã Energy efficiency in buildings\n\n**Paris Agreement (2015):** 196 countries agreed to limit warming to 1.5¬∞C`;

  // ‚îÄ‚îÄ‚îÄ WORLD KNOWLEDGE ‚îÄ‚îÄ‚îÄ
  if(/\bindia\b/.test(t) && !/\bindiana\b/.test(t)) return`## üáÆüá≥ India\n\n**Official name:** Republic of India\n**Capital:** New Delhi\n**Largest city:** Mumbai\n**Population:** ~1.44 billion (world's most populous nation)\n**Area:** 3.29 million km¬≤ (7th largest country)\n\n**Government:** Federal parliamentary democratic republic\n- **Prime Minister:** Narendra Modi (since May 2014, 3rd term)\n- **President:** Droupadi Murmu (since July 2022)\n- **Constitution:** Adopted January 26, 1950 (Republic Day)\n\n**Economy:**\n- GDP: ~$3.7 trillion (5th largest economy globally)\n- Growing tech hub: Bangalore ("Silicon Valley of India")\n- Top exports: IT services, pharmaceuticals, textiles, gems\n- Currency: Indian Rupee (‚Çπ)\n\n**Key facts:**\n- Independence: August 15, 1947 (from British rule)\n- 28 states + 8 Union Territories\n- Official languages: Hindi and English (+ 21 scheduled languages)\n- Famous for: Yoga, Cricket, Bollywood, Taj Mahal, ISRO, spices\n- ISRO: Chandrayaan-3 (2023) ‚Äî first nation to land near Moon's south pole`;

  if(/\busa\b|\bamerica\b|\bunited states\b/.test(t)) return`## üá∫üá∏ United States of America\n\n**Capital:** Washington D.C.\n**Largest city:** New York City\n**Population:** ~335 million\n**Area:** 9.83 million km¬≤ (3rd or 4th largest)\n\n**Government:** Federal constitutional republic\n- **President:** Donald Trump (47th President, since January 20, 2025)\n- **Vice President:** JD Vance\n- **Congress:** Senate (100 seats) + House of Representatives (435 seats)\n\n**Economy:**\n- GDP: ~$27 trillion (world's largest economy)\n- Currency: US Dollar ($) ‚Äî world's primary reserve currency\n- Major sectors: Technology, Finance, Healthcare, Defence, Agriculture\n\n**Key facts:**\n- 50 states + Washington D.C.\n- Founded: July 4, 1776 (Declaration of Independence)\n- Famous for: Hollywood, Silicon Valley, NASA, Wall Street, Statue of Liberty, Grand Canyon`;

  if(/\bchina\b/.test(t)) return`## üá®üá≥ China\n\n**Official name:** People's Republic of China\n**Capital:** Beijing\n**Largest city:** Shanghai\n**Population:** ~1.41 billion\n**Area:** 9.6 million km¬≤ (4th largest)\n\n**Government:** One-party socialist republic\n- **President:** Xi Jinping (in power since 2013)\n- **Ruling party:** Communist Party of China (CPC)\n\n**Economy:**\n- GDP: ~$18 trillion (2nd largest economy)\n- Currency: Chinese Yuan/Renminbi (¬•)\n- World's largest manufacturer and exporter\n- Major tech companies: Alibaba ¬∑ Tencent ¬∑ Huawei ¬∑ ByteDance (TikTok) ¬∑ Xiaomi\n\n**Key facts:**\n- Oldest continuous civilization (5,000+ years)\n- Great Wall, Forbidden City, Terracotta Army\n- Official language: Mandarin Chinese\n- Home to pandas, giant pandas are national symbol\n- 2nd largest military budget`;

  if(/\buk\b|\bbritain\b|\bengland\b|\bunited kingdom\b/.test(t)) return`## üá¨üáß United Kingdom\n\n**Capital:** London\n**Population:** ~68 million\n**Government:** Constitutional monarchy + parliamentary democracy\n- **King:** Charles III (since September 2022)\n- **Prime Minister:** Rishi Sunak (Conservative) ‚Äî elections in 2024\n\n**Economy:** GDP ~$3.1 trillion (6th largest)\n**Currency:** British Pound Sterling (¬£)\n\n**4 nations:** England ¬∑ Scotland ¬∑ Wales ¬∑ Northern Ireland\n\n**Famous for:** Big Ben ¬∑ Buckingham Palace ¬∑ Oxford ¬∑ Cambridge ¬∑ Shakespeare ¬∑ Beatles ¬∑ Premier League football ¬∑ Harry Potter ¬∑ BBC`;

  // ‚îÄ‚îÄ‚îÄ TECH COMPANIES ‚îÄ‚îÄ‚îÄ
  if(/\bgoogle\b|\balphabet\b/.test(t)) return`## üîç Google (Alphabet Inc.)\n\n**Founded:** 1998 by Larry Page and Sergey Brin (Stanford PhD students)\n**CEO:** Sundar Pichai (Google) / Alphabet CEO also Sundar Pichai\n**HQ:** Mountain View, California\n**Employees:** ~180,000\n**Market cap:** ~$2 trillion\n\n**Products & services:**\n- üîç **Google Search** ‚Äî 8.5 billion searches/day (90%+ market share)\n- üìß **Gmail** ‚Äî 1.8 billion users\n- üó∫Ô∏è **Google Maps** ‚Äî 1 billion+ users\n- üì∫ **YouTube** ‚Äî 2.7 billion monthly users, 500 hrs video uploaded/minute\n- üì± **Android** ‚Äî 72% of global smartphones\n- ‚òÅÔ∏è **Google Cloud** ‚Äî 3rd largest cloud platform\n- ü§ñ **Gemini AI** ‚Äî GPT-4 competitor\n- üåê **Chrome** ‚Äî 65% browser market share\n\n**Revenue:** ~$307 billion/year (mainly digital advertising)`;

  if(/\bmicrosoft\b/.test(t)) return`## üíª Microsoft\n\n**Founded:** 1975 by Bill Gates and Paul Allen\n**CEO:** Satya Nadella (since 2014)\n**HQ:** Redmond, Washington\n**Market cap:** ~$3 trillion (one of world's most valuable companies)\n\n**Products:**\n- ü™ü **Windows** ‚Äî 72% desktop OS market share\n- üìä **Microsoft 365** ‚Äî Word, Excel, PowerPoint, Teams\n- ‚òÅÔ∏è **Azure** ‚Äî 2nd largest cloud platform (23% market share)\n- üíº **LinkedIn** ‚Äî 950+ million professionals\n- üêô **GitHub** ‚Äî 100+ million developers\n- üéÆ **Xbox** ‚Äî gaming console and Game Pass\n- ü§ñ **Copilot** ‚Äî AI assistant powered by OpenAI\n\n**Key investment:** ~$13 billion in OpenAI (ChatGPT creator)\n\n**Revenue:** ~$245 billion/year`;

  if(/\bapple\b/.test(t) && !/\bapple.com\b/.test(t)) return`## üçé Apple Inc.\n\n**Founded:** 1976 by Steve Jobs, Steve Wozniak, and Ronald Wayne\n**CEO:** Tim Cook (since 2011)\n**HQ:** Apple Park, Cupertino, California\n**Market cap:** ~$3+ trillion (world's most valuable company)\n\n**Products:**\n- üì± **iPhone** ‚Äî ~52% US smartphone market\n- üíª **Mac** ‚Äî MacBook Air/Pro, Mac Mini, Mac Pro\n- üì∫ **iPad** ‚Äî tablet market leader\n- ‚åö **Apple Watch** ‚Äî #1 smartwatch worldwide\n- üéß **AirPods** ‚Äî #1 TWS earbuds\n- üé¨ **Apple TV+** ‚Äî streaming service\n- üíæ **iCloud** ‚Äî cloud storage\n- ü§ñ **Apple Intelligence** ‚Äî on-device AI (2024)\n\n**Revenue:** ~$385 billion/year\n**Facts:** First $1T, $2T, $3T company ¬∑ App Store generates $1.1T in developer billings annually`;

  if(/\bamazon\b/.test(t)) return`## üì¶ Amazon\n\n**Founded:** 1994 by Jeff Bezos (started as online bookstore)\n**CEO:** Andy Jassy (since 2021)\n**HQ:** Seattle, Washington\n**Market cap:** ~$1.9 trillion\n\n**Business divisions:**\n- üõí **Amazon.com** ‚Äî world's largest e-commerce platform\n- ‚òÅÔ∏è **AWS** ‚Äî #1 cloud platform (33% market share), most profitable division\n- üé¨ **Prime Video** ‚Äî 200M+ subscribers worldwide\n- üéôÔ∏è **Alexa** ‚Äî AI voice assistant\n- üìö **Kindle** ‚Äî e-reader leader\n- üéÆ **Twitch** ‚Äî game streaming\n- üåø **Whole Foods** ‚Äî grocery chain\n\n**Revenue:** ~$575 billion/year\n**AWS revenue:** ~$90 billion (powers Netflix, Airbnb, NASA, CIA)`;

  if(/\belon musk\b/.test(t)) return`## üöÄ Elon Musk\n\n**Born:** June 28, 1971, Pretoria, South Africa\n**Nationality:** South African-American\n**Net worth:** ~$300+ billion (frequently world's richest person)\n\n**Companies:**\n| Company | Role | What it does |\n|---------|------|-------------|\n| **Tesla** | CEO | Electric vehicles, energy storage, Autopilot AI |\n| **SpaceX** | CEO & CTO | Rockets, Starlink internet, Dragon capsule |\n| **X (Twitter)** | Owner | Social media platform (acquired $44B, 2022) |\n| **xAI** | Founder | AI company, Grok chatbot |\n| **Neuralink** | Co-founder | Brain-computer interface implants |\n| **The Boring Company** | Founder | Underground tunnels (Las Vegas Loop) |\n\n**Key achievements:**\n- SpaceX: first private company to launch/return astronauts to ISS\n- Tesla: world's most valuable auto company by market cap\n- Starlink: 6,000+ satellites, provides internet to 70+ countries`;

  if(/\bnarendra modi\b|\bmodi\b/.test(t)) return`## üáÆüá≥ Narendra Modi\n\n**Full name:** Narendra Damodardas Modi\n**Born:** September 17, 1950, Vadnagar, Gujarat\n**Position:** 14th Prime Minister of India (since May 26, 2014)\n\n**Political career:**\n- Member of BJP (Bharatiya Janata Party)\n- Chief Minister of Gujarat (2001‚Äì2014) ‚Äî 3 consecutive terms\n- Won 2014 general elections with BJP's historic majority\n- Re-elected 2019 with even larger majority\n- Won 2024 elections for a historic 3rd consecutive term\n\n**Key initiatives:**\n- üè¶ Jan Dhan Yojana ‚Äî financial inclusion for poor\n- üì± Digital India ‚Äî digital infrastructure push\n- üèóÔ∏è Make in India ‚Äî manufacturing hub\n- üõ∞Ô∏è Chandrayaan-3 ‚Äî Moon south pole landing (2023)\n- üõ£Ô∏è Infrastructure mega-projects (roads, railways, airports)\n- üåø International Yoga Day (June 21) ‚Äî UN recognized`;

  if(/\bvirat kohli\b|\bkohli\b/.test(t)) return`## üèè Virat Kohli\n\n**Full name:** Virat Kohli\n**Born:** November 5, 1988, Delhi, India\n**Role:** Right-hand batsman ¬∑ Former captain of Team India\n\n**Records & achievements:**\n- ODIs: 50+ centuries (most by any player in ODI cricket history)\n- Tests: 8,000+ runs, 29 centuries\n- T20Is: Highest run scorer in T20 International history\n- ICC Rankings: Reached #1 in all three formats\n- 2023 ODI World Cup: Player of the Tournament\n- 2024 T20 World Cup: Won with India; retired from T20Is after the tournament\n\n**Awards:** Arjuna Award ¬∑ Padma Shri ¬∑ Wisden Leading Cricketer (multiple times)\n\n**Personal:** Married to actress Anushka Sharma (2017)`;

  if(/\bms dhoni\b|\bdhoni\b/.test(t)) return`## üèè MS Dhoni\n\n**Full name:** Mahendra Singh Dhoni\n**Born:** July 7, 1981, Ranchi, Jharkhand\n**Role:** Wicket-keeper batsman ¬∑ Former captain of Team India\n\n**Major achievements as captain:**\n- üèÜ ICC T20 World Cup 2007 ‚Äî won India's first T20 WC\n- üèÜ ICC ODI World Cup 2011 ‚Äî won on home soil, hit iconic six\n- üèÜ ICC Champions Trophy 2013 ‚Äî completed all three ICC trophies\n- IPL: Won 5 titles with Chennai Super Kings (CSK)\n- Only captain to win all three major ICC trophies\n\n**Known for:** Calm leadership ¬∑ Helicopter shot ¬∑ Lightning-quick stumpings\n\n**Retired:** From international cricket in August 2020\n**IPL:** Continues to play for CSK as captain`;

  if(/\bsachin tendulkar\b|\bsachin\b/.test(t)) return`## üèè Sachin Tendulkar\n\n**Full name:** Sachin Ramesh Tendulkar\n**Born:** April 24, 1973, Mumbai, Maharashtra\n**Nickname:** "The God of Cricket" / "Master Blaster"\n\n**World records:**\n- üìä **Most international runs:** 34,357 runs (Tests + ODIs + T20Is)\n- üíØ **Most centuries:** 100 international centuries (51 Tests + 49 ODIs)\n- üèè **Tests:** 15,921 runs in 200 matches\n- üèè **ODIs:** 18,426 runs in 463 matches\n- Played international cricket from age 16 (1989) to 40 (2013)\n\n**Awards:** Bharat Ratna (India's highest civilian honor) ¬∑ Padma Vibhushan ¬∑ Padma Shri ¬∑ Arjuna Award\n\n**World Cup:** Won 2011 ODI World Cup (his 6th and final World Cup)`;

  if(/\bcricket\b/.test(t)) return`## üèè Cricket\n\nCricket is a bat-and-ball sport played between two teams of 11 players on an oval field.\n\n**Formats:**\n| Format | Overs | Duration | Notes |\n|--------|-------|----------|-------|\n| Test | Unlimited | Up to 5 days | Highest form of the game |\n| ODI | 50/side | ~8 hours | One Day International |\n| T20 | 20/side | ~3 hours | Most popular, fastest format |\n| T10 | 10/side | ~90 min | Newest format |\n\n**Key terms:** Wicket ¬∑ Over (6 balls) ¬∑ Century (100 runs) ¬∑ Maiden over ¬∑ Duck (0 runs) ¬∑ No-ball ¬∑ Wide ¬∑ LBW\n\n**Top nations:** India üáÆüá≥ ¬∑ Australia üá¶üá∫ ¬∑ England üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø ¬∑ Pakistan üáµüá∞ ¬∑ South Africa üáøüá¶ ¬∑ New Zealand üá≥üáø\n\n**India's ICC titles:**\n- üèÜ 1983 ODI World Cup (first-ever)\n- üèÜ 2007 T20 World Cup (first T20 WC)\n- üèÜ 2011 ODI World Cup (home soil)\n- üèÜ 2013 Champions Trophy\n- üèÜ 2024 T20 World Cup\n\n**IPL:** Indian Premier League ‚Äî world's richest cricket league (10 franchises)`;

  if(/\bfootball\b|\bsoccer\b|\bfifa\b/.test(t)) return`## ‚öΩ Football (Soccer)\n\nFootball is the world's most popular sport with ~4 billion fans globally.\n\n**How it's played:** Two teams of 11 players ¬∑ 90 min (two 45-min halves) ¬∑ Score by getting ball into opponent's goal\n\n**Major competitions:**\n- üèÜ **FIFA World Cup** ‚Äî every 4 years, 32+ nations\n- üåü **UEFA Champions League** ‚Äî best European clubs\n- üåç **Premier League** ‚Äî England's top league (most watched)\n- üèÜ **La Liga** ‚Äî Spain (Real Madrid, Barcelona)\n- üáÆüáπ **Serie A** ‚Äî Italy\n- üá©üá™ **Bundesliga** ‚Äî Germany\n\n**Legends:**\n- **Lionel Messi** üá¶üá∑ ‚Äî 8 Ballon d'Or ¬∑ 2022 World Cup winner\n- **Cristiano Ronaldo** üáµüáπ ‚Äî 5 Ballon d'Or ¬∑ All-time top international scorer\n- **Pel√©** üáßüá∑ ‚Äî 3 World Cups ¬∑ 1,000+ career goals\n- **Ronaldinho** üáßüá∑ ‚Äî 2005 Ballon d'Or\n\n**2022 FIFA World Cup Winner:** Argentina üá¶üá∑ (beat France on penalties in epic final)`;

  if(/\bbitcoin\b/.test(t)) return`## ‚Çø Bitcoin\n\n**Created:** January 3, 2009 by the pseudonymous **Satoshi Nakamoto**\n**Type:** First decentralized digital cryptocurrency\n**Symbol:** BTC\n**Max supply:** 21 million coins (hard cap ‚Äî deflationary by design)\n\n**How it works:**\n- Runs on **blockchain** ‚Äî distributed ledger of all transactions\n- **Mining** ‚Äî computers (ASICs) solve cryptographic puzzles to validate transactions and earn new BTC\n- **Halving** ‚Äî mining reward halves every ~210,000 blocks (~4 years)\n  - 2009: 50 BTC reward ‚Üí 2012: 25 ‚Üí 2016: 12.5 ‚Üí 2020: 6.25 ‚Üí 2024: 3.125\n\n**Key facts:**\n- First ever cryptocurrency\n- Transactions visible on blockchain (pseudonymous, not anonymous)\n- Lightning Network enables faster, cheaper micro-transactions\n- Legal tender in El Salvador and Central African Republic\n\n**Pros:** Decentralized ¬∑ Inflation-resistant ¬∑ Global ¬∑ Permissionless ¬∑ 24/7\n**Cons:** Volatile price ¬∑ Energy intensive ¬∑ Slow base-layer transactions ¬∑ No chargebacks`;

  if(/\bblockchain\b/.test(t)) return`## ‚õìÔ∏è Blockchain\n\nA blockchain is a distributed, immutable ledger that records transactions across a network of computers.\n\n**How it works:**\n\`\`\`\nBlock 1              Block 2              Block 3\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Data: TX list‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Data: TX list‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Data: TX list‚îÇ\n‚îÇ Hash: A1B2C3 ‚îÇ     ‚îÇ Hash: D4E5F6 ‚îÇ     ‚îÇ Hash: G7H8I9 ‚îÇ\n‚îÇ Prev: 000000 ‚îÇ     ‚îÇ Prev: A1B2C3 ‚îÇ     ‚îÇ Prev: D4E5F6 ‚îÇ\n‚îÇ Nonce: 48291 ‚îÇ     ‚îÇ Nonce: 72301 ‚îÇ     ‚îÇ Nonce: 19283 ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\`\`\`\n\n**Key properties:** Decentralized ¬∑ Immutable (can't alter past blocks) ¬∑ Transparent ¬∑ Secure via cryptography\n\n**Applications:**\n- üí∞ **Cryptocurrencies** ‚Äî Bitcoin, Ethereum, Solana\n- üìú **Smart contracts** ‚Äî self-executing agreements (Ethereum)\n- üñºÔ∏è **NFTs** ‚Äî digital ownership certificates\n- üè≠ **Supply chain** ‚Äî track goods from factory to shelf\n- üó≥Ô∏è **Voting** ‚Äî transparent, tamper-proof elections\n- üè• **Healthcare records** ‚Äî secure patient data`;

  if(/\bhealth\b|\bfitness\b|\bexercise\b/.test(t)) return`## üí™ Health & Fitness\n\n**WHO Exercise Recommendations:**\n- 150‚Äì300 min of moderate cardio/week (brisk walking, cycling, swimming)\n- 75‚Äì150 min of vigorous activity/week (running, HIIT, sports)\n- Muscle-strengthening 2+ days/week (weights, resistance bands, yoga)\n\n**Nutrition basics:**\n| Macronutrient | Calories/g | Function | Best sources |\n|---------------|-----------|----------|--------------|\n| Protein | 4 | Build/repair muscles, enzymes | Chicken, fish, eggs, lentils, tofu |\n| Carbs | 4 | Primary energy, brain fuel | Rice, oats, bread, fruits, veggies |\n| Fats | 9 | Hormones, brain, fat-soluble vitamins | Nuts, avocado, olive oil, fish |\n\n**Daily targets (approx):**\n- üíß Water: 2‚Äì3 litres\n- üåø Fibre: 25‚Äì38g\n- üò¥ Sleep: 7‚Äì9 hours\n- üèÉ Steps: 7,000‚Äì10,000/day\n\n**BMI:** Weight(kg) √∑ Height(m)¬≤ | Under 18.5=Underweight ¬∑ 18.5‚Äì24.9=Normal ¬∑ 25‚Äì29.9=Overweight ¬∑ 30+=Obese`;

  if(/\bhistory\b|\bworld war\b/.test(t)) return`## üìú World History Highlights\n\n**Ancient World:**\n- 3000 BCE: Egyptian civilization, Pyramids built\n- 2500 BCE: Indus Valley civilization (Harappa, Mohenjo-daro)\n- 500 BCE: Greek Golden Age ‚Äî Plato, Aristotle, democracy\n- 322 BCE: Maurya Empire in India (Chandragupta, Ashoka)\n- 27 BCE: Roman Empire begins\n\n**Medieval Period:**\n- 622 CE: Islam founded by Prophet Muhammad\n- 1066: Battle of Hastings ‚Äî Norman conquest of England\n- 1215: Magna Carta ‚Äî limits on English king's power\n- 1492: Columbus reaches the Americas\n\n**Modern Era:**\n- 1776: American Declaration of Independence\n- 1789: French Revolution\n- 1857: India's First War of Independence\n- 1914‚Äì1918: World War I (~20 million deaths)\n- 1939‚Äì1945: World War II (~85 million deaths)\n- 1947: India and Pakistan independence\n- 1969: Neil Armstrong walks on the Moon\n- 1991: World Wide Web invented (Tim Berners-Lee)\n- 2001: 9/11 attacks, War on Terror begins\n- 2008: Global financial crisis\n- 2020: COVID-19 pandemic`;

  // ‚îÄ‚îÄ‚îÄ FINAL INTELLIGENT FALLBACK ‚îÄ‚îÄ‚îÄ
  // Instead of "try again", give best possible answer based on topic category
  const tl = topic.toLowerCase();
  let category = 'general';
  let answer = '';

  if(/\bwho\b/.test(raw.toLowerCase())){
    // Person question
    answer = `I don't have specific data about **"${topic}"** in my built-in knowledge base.\n\n**What I do know about similar topics:**\n- Ask about world leaders, tech CEOs, scientists, sports stars, or historical figures\n- Try: "Who is Elon Musk?", "Who is Narendra Modi?", "Who is Virat Kohli?"\n\nI have detailed profiles for: Modi ¬∑ Elon Musk ¬∑ Virat Kohli ¬∑ MS Dhoni ¬∑ Sachin Tendulkar ¬∑ Einstein ¬∑ Newton and 50+ more personalities.`;
  } else if(/\bwhere\b/.test(raw.toLowerCase())){
    answer = `**${topic}** ‚Äî location/geography query.\n\nI have information on: India, USA, China, UK, Australia, Japan, and 50+ countries.\nTry: "Capital of France" ¬∑ "Where is Brazil?" ¬∑ "Tell me about Germany"`;
  } else if(/code|program|script|function|algorithm|implement/.test(tl)){
    answer = `Here's a general approach to **"${topic}"** in code:\n\n\`\`\`python\n# Python template for: ${topic}\ndef solve_${topic.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z_]/g,'')}(input_data):\n    """\n    Solution for: ${topic}\n    Args: input_data - your input\n    Returns: result\n    """\n    result = None  # implement your logic here\n    \n    # Step 1: Process input\n    processed = input_data\n    \n    # Step 2: Apply logic\n    # TODO: Add your specific logic\n    \n    # Step 3: Return result\n    return result\n\n# Test it\nresult = solve_${topic.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z_]/g,'')}("test input")\nprint(result)\n\`\`\`\n\nBe more specific about what you want to implement and I can give you the exact code!`;
  } else if(/recipe|cook|bake|food|dish/.test(tl)){
    answer = `## üç≥ ${topic}\n\nFor cooking "${topic}", here are general guidelines:\n\n**Basic cooking approach:**\n1. Gather fresh, quality ingredients\n2. Prep everything before you start (mise en place)\n3. Follow temperature guidelines carefully\n4. Taste and adjust seasoning as you cook\n5. Presentation matters ‚Äî garnish before serving\n\nFor a specific recipe, try asking: "Recipe for [specific dish name]"`;
  } else {
    // Smart general response
    answer = `## üí° ${topic.charAt(0).toUpperCase()+topic.slice(1)}\n\nHere's what I can share on **"${topic}"**:\n\nThis appears to be related to ${detectCat(tl)}. While my built-in knowledge base covers 100+ major topics in depth, I have limited specific data on this particular query.\n\n**You might find these related topics helpful:**\n${getRelated(tl)}\n\n**Try rephrasing as:**\n- "What is ${topic}?"\n- "Explain ${topic} with examples"\n- "How does ${topic} work?"\n- "Give me facts about ${topic}"\n\nüí° **Pro tip:** The cloud AI engines (Engine 1, 2, 3) give full answers to anything ‚Äî they auto-reconnect every 30 seconds. Or test them in **Settings ‚Üí AI Engine Status ‚Üí ‚Üª Test Now**`;
  }

  return answer;
}

function detectCat(t){
  if(/python|javascript|java|code|program|software|web|app|api|database/.test(t)) return 'software development and technology';
  if(/physics|chemistry|biology|math|science|formula/.test(t)) return 'science and mathematics';
  if(/history|war|ancient|civilization|independence|revolution/.test(t)) return 'history and culture';
  if(/health|medicine|disease|body|brain|fitness|diet|nutrition/.test(t)) return 'health and wellness';
  if(/business|economy|finance|market|money|stock|invest/.test(t)) return 'business and finance';
  if(/music|art|film|movie|sport|cricket|football|game/.test(t)) return 'arts, entertainment, and sports';
  if(/country|city|geography|travel|capital|continent/.test(t)) return 'geography and world knowledge';
  if(/ai|machine learning|deep learning|neural|robot/.test(t)) return 'artificial intelligence and technology';
  return 'general knowledge';
}

function getRelated(t){
  if(/code|program|software/.test(t)) return '- Python ¬∑ JavaScript ¬∑ Java ¬∑ SQL\n- Web development ¬∑ React ¬∑ APIs\n- AI and Machine Learning';
  if(/science|physics|chem|bio/.test(t)) return '- Physics laws ¬∑ Chemistry elements\n- Biology and genetics ¬∑ Space and astronomy';
  if(/history/.test(t)) return '- World Wars ¬∑ Indian Independence\n- Ancient civilizations ¬∑ Modern history';
  if(/business|finance|invest/.test(t)) return '- Bitcoin and cryptocurrency\n- Stock market basics ¬∑ Major tech companies';
  if(/sport|cricket|football/.test(t)) return '- Cricket (Kohli, Dhoni, Sachin)\n- Football (Messi, Ronaldo, FIFA World Cup)';
  return '- AI and technology ¬∑ World geography\n- Science and mathematics ¬∑ History';
}

function buildHowTo(topic, t, raw){
  // Programming-specific how-tos
  if(/print|hello world/.test(t)) return`## üíª How to Print / Hello World\n\n**Python:**\n\`\`\`python\nprint("Hello, World!")\nprint(f"Name: Alice, Age: {25}")  # f-string\n\`\`\`\n\n**JavaScript:**\n\`\`\`javascript\nconsole.log("Hello, World!");\nconsole.log(\`Name: Alice, Age: \${25}\`); // template literal\n\`\`\`\n\n**Java:**\n\`\`\`java\nSystem.out.println("Hello, World!");\nSystem.out.printf("Name: %s, Age: %d%n", "Alice", 25);\n\`\`\`\n\n**C++:**\n\`\`\`cpp\n#include <iostream>\nstd::cout << "Hello, World!" << std::endl;\n\`\`\``;

  if(/sort/.test(t)) return`## üîÉ How to Sort\n\n**Python:**\n\`\`\`python\nnums = [3, 1, 4, 1, 5, 9, 2]\nnums.sort()                    # sort in place, ascending\nnums.sort(reverse=True)        # descending\nsorted_copy = sorted(nums)     # returns new sorted list\n\n# Sort list of objects\npeople = [{"name":"Charlie","age":30},{"name":"Alice","age":25}]\npeople.sort(key=lambda p: p["age"])  # sort by age\n\`\`\`\n\n**JavaScript:**\n\`\`\`javascript\nconst nums = [3, 1, 4, 1, 5, 9];\nnums.sort((a, b) => a - b);  // ascending\nnums.sort((a, b) => b - a);  // descending\n\nconst people = [{name:"Charlie",age:30},{name:"Alice",age:25}];\npeople.sort((a, b) => a.age - b.age);  // by age\n\`\`\``;

  if(/read.*file|open.*file|write.*file/.test(t)) return`## üìÅ How to Read/Write Files\n\n**Python:**\n\`\`\`python\n# Read entire file\nwith open('data.txt', 'r', encoding='utf-8') as f:\n    content = f.read()\n    print(content)\n\n# Read line by line\nwith open('data.txt', 'r') as f:\n    for line in f:\n        print(line.strip())\n\n# Read all lines into list\nwith open('data.txt', 'r') as f:\n    lines = f.readlines()\n\n# Write to file\nwith open('output.txt', 'w') as f:\n    f.write("Hello World\\n")\n    f.writelines(["Line 1\\n", "Line 2\\n"])\n\n# Append\nwith open('log.txt', 'a') as f:\n    f.write("New entry\\n")\n\`\`\``;

  if(/loop|iterate/.test(t)) return`## üîÅ How to Use Loops\n\n**Python:**\n\`\`\`python\n# For loop ‚Äî iterate over range\nfor i in range(5):          # 0, 1, 2, 3, 4\n    print(i)\n\nfor i in range(1, 11, 2):  # 1, 3, 5, 7, 9 (start, stop, step)\n    print(i)\n\n# Iterate over list\nfruits = ["apple", "banana", "mango"]\nfor fruit in fruits:\n    print(fruit)\n\n# Enumerate (index + value)\nfor i, fruit in enumerate(fruits):\n    print(f"{i}: {fruit}")\n\n# While loop\ncount = 0\nwhile count < 5:\n    print(count)\n    count += 1\n\n# List comprehension (compact loop)\nsquares = [x**2 for x in range(10)]\n\`\`\``;

  if(/function/.test(t)) return`## ‚öôÔ∏è How to Write Functions\n\n**Python:**\n\`\`\`python\n# Basic function\ndef greet(name):\n    return f"Hello, {name}!"\n\n# Default parameters\ndef power(base, exp=2):\n    return base ** exp\n\nprint(power(3))    # 9 (uses default exp=2)\nprint(power(3, 3)) # 27\n\n# Multiple return values\ndef min_max(numbers):\n    return min(numbers), max(numbers)\n\nlo, hi = min_max([3, 1, 4, 1, 5])\nprint(lo, hi)  # 1 5\n\n# Lambda (anonymous function)\ndouble = lambda x: x * 2\nprint(double(5))  # 10\n\n# *args and **kwargs\ndef total(*args):\n    return sum(args)\nprint(total(1, 2, 3, 4))  # 10\n\`\`\``;

  if(/learn.*cod|learn.*program|start.*cod|start.*program|begin.*cod/.test(t)) return`## üìö How to Learn Programming\n\n**Beginner Roadmap:**\n\n**Step 1: Pick your first language** (1 week)\n- üêç **Python** ‚Äî easiest syntax, great for AI/data science\n- üåê **JavaScript** ‚Äî essential for web development\n- ‚òï **Java** ‚Äî good for mobile (Android) and enterprise\n\n**Step 2: Learn fundamentals** (4‚Äì8 weeks)\n- Variables and data types\n- Control flow (if/else, loops)\n- Functions\n- Data structures (arrays, lists, dictionaries)\n\n**Step 3: Build mini projects** (ongoing)\n- Calculator ¬∑ To-do list ¬∑ Quiz app ¬∑ Weather app\n\n**Step 4: Learn OOP** (2 weeks)\n- Classes, Objects, Inheritance, Polymorphism\n\n**Step 5: Pick a path:**\n| Path | Learn |\n|------|-------|\n| Web Frontend | HTML/CSS ‚Üí JavaScript ‚Üí React |\n| Web Backend | Python/Node ‚Üí Databases ‚Üí APIs |\n| Data Science | Python ‚Üí Pandas/NumPy ‚Üí ML |\n| Mobile | Swift (iOS) or Kotlin (Android) |\n\n**Free resources:** freeCodeCamp.org ¬∑ The Odin Project ¬∑ CS50 (Harvard) ¬∑ Python.org tutorial ¬∑ MDN Web Docs`;

  if(/invest|stock|trading/.test(t)) return`## üí∞ How to Invest\n\n**Step-by-step for beginners:**\n\n1. **Emergency fund first** ‚Äî save 3‚Äì6 months of expenses in a savings account\n2. **Pay off high-interest debt** ‚Äî credit cards (20%+ APR) must go first\n3. **Understand basics:**\n   - Stocks = ownership in a company\n   - Bonds = lending money to company/government\n   - Index funds = basket of many stocks (diversified)\n4. **Start with index funds** ‚Äî track S&P 500 (USA) or Nifty 50 (India)\n   - Historically return ~10‚Äì12%/year long-term\n   - Low fees, automatically diversified\n5. **Use tax-advantaged accounts:**\n   - üáÆüá≥ India: PPF, ELSS, NPS\n   - üá∫üá∏ USA: 401(k), Roth IRA\n6. **Invest regularly (SIP/DCA)** ‚Äî fixed amount every month regardless of market\n7. **Time horizon matters** ‚Äî longer = more risk you can take\n8. **Don't panic-sell** during market crashes\n\n‚ö†Ô∏è *This is general education ‚Äî consult a SEBI-registered advisor for personal advice*`;

  if(/lose weight|weight loss/.test(t)) return`## üèÉ How to Lose Weight Safely\n\n**The science:** Weight loss = calories out > calories in\n\n**Step 1: Calculate your TDEE**\n- TDEE = Total Daily Energy Expenditure (your maintenance calories)\n- Create a 300‚Äì500 calorie daily deficit ‚Üí lose 0.3‚Äì0.5 kg/week\n\n**Step 2: Diet (80% of the battle)**\n- High protein (keeps you full): eggs, chicken, fish, paneer, lentils\n- Fill half your plate with vegetables\n- Reduce ultra-processed foods and sugary drinks\n- Drink water before meals\n- Track food on MyFitnessPal app\n\n**Step 3: Exercise (adds to deficit + health benefits)**\n- Cardio: walking, running, cycling, swimming\n- Strength training: preserves muscle while losing fat\n- Aim for 10,000 steps/day\n\n**Step 4: Sleep & Stress**\n- 7‚Äì9 hours sleep (poor sleep raises ghrelin ‚Äî hunger hormone)\n- Manage stress (cortisol promotes fat storage)\n\n**Expected rate:** 0.5‚Äì1 kg per week is healthy and sustainable\n\n‚ö†Ô∏è *Consult a doctor before major dietary changes*`;

  if(/meditat/.test(t)) return`## üßò How to Meditate\n\n**Basic mindfulness meditation (5‚Äì10 min to start):**\n\n1. Find a quiet, comfortable spot\n2. Sit upright (chair, floor cushion, or bed)\n3. Set a timer (5 min for beginners)\n4. Close your eyes and relax your body from head to toes\n5. Breathe naturally ‚Äî focus on the sensation of breathing\n6. When your mind wanders (it will!), gently return attention to breath\n7. Don't judge yourself ‚Äî wandering is normal\n8. When timer ends, open eyes slowly and take a moment before moving\n\n**Build the habit:**\n- Same time daily (morning works best for most people)\n- Start with 5 min ‚Üí increase to 20 min over weeks\n- Use apps: Headspace ¬∑ Calm ¬∑ Insight Timer (free)\n\n**Benefits (research-backed):**\n- Reduces anxiety and depression\n- Improves focus and memory\n- Better sleep quality\n- Lower blood pressure\n- Increased emotional regulation`;

  // Generic how-to ‚Äî give real structured answer for anything
  return`## üõ†Ô∏è How to ${topic.charAt(0).toUpperCase()+topic.slice(1)}\n\nHere's a structured approach:\n\n**Step 1: Understand the goal**\nClearly define what success looks like for "${topic}". What is the desired outcome?\n\n**Step 2: Gather what you need**\nIdentify the tools, resources, skills, or materials required to get started.\n\n**Step 3: Break it into smaller tasks**\nDon't try to tackle everything at once. Small, consistent actions compound over time.\n\n**Step 4: Start with the basics**\nBuild a strong foundation before attempting advanced techniques.\n\n**Step 5: Practice consistently**\n10‚Äì30 minutes daily beats a weekend marathon session for most skills.\n\n**Step 6: Track progress & adjust**\nMeasure results, identify what's working, and iterate.\n\n**Step 7: Seek feedback**\nFind a mentor, community, or resource to accelerate your learning.\n\nüí° **Ask me more specifically:** "How to [specific aspect of ${topic}]?" for detailed step-by-step instructions!\n\n*Cloud AI (Engine 1/2/3) gives comprehensive answers to any how-to question ‚Äî they auto-reconnect every 30 seconds.*`;
}


async function askAI(msgs, userText){
  const engines=[
    {fn:engine1,name:'Primary Engine',cls:'e1',n:1},
    {fn:engine2,name:'Analytical Engine',cls:'e2',n:2},
    {fn:engine3,name:'Concise Engine',cls:'e3',n:3}
  ];
  for(let i=0;i<engines.length;i++){
    const e=engines[i];
    setEngineUI(e.n,e.name);
    updateTypingLabel(`Connecting to ${e.name}...`);
    try{
      const r=await e.fn(msgs);
      if(r&&r.trim()){
        updateTypingLabel('Generating response...');
        return{text:r,cls:e.cls,name:e.name};
      }
    }catch(err){
      // Silently try next engine
      if(i<engines.length-1){
        updateTypingLabel(`Switching to ${engines[i+1].name}...`);
        await new Promise(r=>setTimeout(r,500));
      }
    }
  }
  // All cloud engines failed ‚Äî Smart Fallback always works
  setEngineUI(4,'Smart Fallback');
  updateTypingLabel('Answering from knowledge base...');
  await new Promise(r=>setTimeout(r,600)); // small delay so it feels natural
  return{text:engine4(userText),cls:'e4',name:'Smart Fallback'};
}

function setEngineUI(n,name){
  document.getElementById('eslabel').textContent='¬∑ '+name;
  document.getElementById('sbsub').textContent='Powered by AI ¬∑ '+name;
  document.getElementById('strip-label').innerHTML='<strong>'+name+'</strong> active ¬∑ Auto-fallback on';
  ['ed1','ed2','ed3','ed4'].forEach((id,i)=>{const el=document.getElementById(id);if(el)el.classList.toggle('on',i+1<=n);});
}

// ‚îÄ‚îÄ MARKDOWN ‚îÄ‚îÄ
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function md(raw){
  let s=raw;
  s=s.replace(/```(\w*)\n?([\s\S]*?)```/g,(_,lang,code)=>{
    const id='c'+Math.random().toString(36).slice(2,7);
    return`<div class="pre-wrap"><div class="pre-header"><span>${lang||'code'}</span><button class="pre-copy" onclick="copyCode('${id}')">Copy</button></div><pre><code id="${id}">${esc(code.trim())}</code></pre></div>`;
  });
  s=s.replace(/`([^`\n]+)`/g,(_,c)=>`<code>${esc(c)}</code>`);
  s=s.replace(/^### (.+)$/gm,'<h3>$1</h3>').replace(/^## (.+)$/gm,'<h2>$1</h2>').replace(/^# (.+)$/gm,'<h1>$1</h1>');
  s=s.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>');
  s=s.replace(/^---$/gm,'<hr>').replace(/^> (.+)$/gm,'<blockquote>$1</blockquote>');
  s=s.replace(/^[ \t]*[-*] (.+)$/gm,'<li>$1</li>').replace(/(<li>.*<\/li>\n?)+/g,m=>`<ul>${m}</ul>`);
  s=s.replace(/^\d+\. (.+)$/gm,'<li>$1</li>');
  s=s.split(/\n{2,}/).map(p=>/^<(h[1-3]|ul|ol|li|pre|div|blockquote|hr)/.test(p.trim())?p:`<p>${p.replace(/\n/g,'<br>')}</p>`).join('\n');
  return s;
}

// ‚îÄ‚îÄ ADD MESSAGE ‚îÄ‚îÄ
function addMsg(role,text,meta={}){
  welcomeEl.style.display='none';
  const now=new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
  const group=document.createElement('div');group.className='msg-group';
  const msgId='msg_'+Date.now()+'_'+Math.random().toString(36).slice(2,6);
  group.dataset.id=msgId;
  const row=document.createElement('div');row.className=`msg-row ${role==='user'?'user-row':''}`;
  const av=document.createElement('div');av.className=`av ${role==='user'?'user-av':'bot-av'}`;
  av.textContent=role==='user'?(currentUser?currentUser.name.slice(0,1).toUpperCase():'üë§'):(botPersona.name.slice(0,1)||'‚ú¶');
  const content=document.createElement('div');content.className='msg-content';
  const mmeta=document.createElement('div');mmeta.className='msg-meta';
  const nameEl=document.createElement('div');nameEl.className='msg-name';
  const timeEl=document.createElement('div');timeEl.className='msg-time';
  nameEl.textContent=role==='user'?(currentUser?currentUser.name:'You'):botPersona.name;
  timeEl.textContent=now;
  mmeta.appendChild(nameEl);mmeta.appendChild(timeEl);
  const bubble=document.createElement('div');
  bubble.className=role==='user'?'bubble user-bubble':'bot-bubble';
  bubble.innerHTML=role==='user'?`<p>${esc(text)}</p>`:md(text);
  if(role==='bot'){
    if(meta.cls){const tag=document.createElement('div');tag.className=`engine-tag ${meta.cls}`;tag.textContent=`‚ö° ${meta.name}`;bubble.appendChild(tag);}
    if(meta.ms){const timer=document.createElement('span');timer.className='resp-timer';timer.textContent=`${(meta.ms/1000).toFixed(1)}s`;bubble.appendChild(timer);}
    const acts=document.createElement('div');acts.className='msg-actions';
    acts.innerHTML=`
      <button class="act-btn" onclick="copyMsg(this)"><svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Copy</button>
      <button class="act-btn" onclick="speakMsg(this)"><svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>Read</button>
      <button class="act-btn" onclick="regenMsg()"><svg viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.5"/></svg>Redo</button>
      <button class="act-btn" onclick="pinMsg(this)"><svg viewBox="0 0 24 24"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/></svg>Pin</button>
      <button class="act-btn" onclick="feedback(this,'like')"><svg viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3z"/><path d="M7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>Good</button>
      <button class="act-btn" onclick="feedback(this,'dislike')"><svg viewBox="0 0 24 24"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3z"/><path d="M17 2h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>Bad</button>
      <button class="act-btn delete-btn" onclick="deleteMsg(this)"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>Del</button>`;
    bubble.appendChild(acts);
    lastBotText=text;
  } else {
    // User message actions
    const acts=document.createElement('div');acts.className='msg-actions';
    acts.innerHTML=`
      <button class="act-btn" onclick="editMsg(this)"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Edit</button>
      <button class="act-btn delete-btn" onclick="deleteMsg(this)"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>Del</button>`;
    bubble.appendChild(acts);
  }
  content.appendChild(mmeta);content.appendChild(bubble);
  row.appendChild(av);row.appendChild(content);
  group.appendChild(row);chatEl.appendChild(group);
  chatEl.scrollTop=chatEl.scrollHeight;
  if(role==='user'&&history.length<=1){titleEl.textContent=text.length>44?text.slice(0,44)+'‚Ä¶':text;addToHistory(titleEl.textContent);}
  // Tab notification
  if(document.hidden && role==='bot') notifyTab();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ RECENT CHATS ‚Äî FULL SAVE & RESTORE SYSTEM ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Each session: { id, title, messages:[{role,content}], time }
const chatSessions = [];
let activeSessionId = null;

// Called when first user message is sent ‚Äî creates a sidebar entry
function addToHistory(title){
  const list = document.getElementById('chatHistList');
  if(!list) return;

  // If current session already has a sidebar entry, just update its title
  if(activeSessionId){
    const existing = chatSessions.find(s => s.id === activeSessionId);
    if(existing){
      existing.title = title;
      const el = list.querySelector(`[data-sid="${activeSessionId}"] .hist-title`);
      if(el) el.textContent = title;
      return;
    }
  }

  // Create new session
  const sessionId = 'sid_' + Date.now();
  activeSessionId = sessionId;
  chatSessions.unshift({ id: sessionId, title, messages: [], time: Date.now() });

  // Build sidebar item
  const item = document.createElement('div');
  item.className = 'history-item active';
  item.dataset.sid = sessionId;
  item.innerHTML = `
    <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    <span class="hist-title" style="flex:1;overflow:hidden;text-overflow:ellipsis">${title}</span>
    <span class="htime">Now</span>
  `;
  item.onclick = () => restoreChat(sessionId);

  // Remove all active classes
  list.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
  // Remove the default placeholder if present
  const placeholder = document.getElementById('defaultHistItem');
  if(placeholder) placeholder.remove();

  list.insertBefore(item, list.firstChild);
}

// Called after EVERY bot reply ‚Äî saves the full conversation
function saveCurrentSession(){
  if(!activeSessionId) return;
  const sess = chatSessions.find(s => s.id === activeSessionId);
  if(sess){
    sess.messages = history.map(m => ({ role: m.role, content: m.content }));
    sess.time = Date.now();
  }
  // Also persist to localStorage
  try{ localStorage.setItem('rb_sessions', JSON.stringify(chatSessions.slice(0,20))); }catch(e){}
}

// Restore a past conversation when sidebar item is clicked
function restoreChat(sessionId){
  const sess = chatSessions.find(s => s.id === sessionId);
  if(!sess){ showToast('‚ö†Ô∏è Could not find that conversation'); return; }
  if(sess.id === activeSessionId){ showToast('üí¨ Already viewing this chat'); return; }
  if(!sess.messages || sess.messages.length === 0){
    showToast('üí¨ That conversation is empty');
    // Still switch to it
    activeSessionId = sessionId;
    document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
    const el = document.querySelector(`[data-sid="${sessionId}"]`);
    if(el) el.classList.add('active');
    return;
  }

  // Save current session before switching
  saveCurrentSession();

  // Switch
  activeSessionId = sessionId;
  history.length = 0;
  sess.messages.forEach(m => history.push({ role: m.role, content: m.content }));

  // Clear chat area
  document.querySelectorAll('.msg-group, .typing-row').forEach(el => el.remove());
  welcomeEl.style.display = 'none';
  if(titleEl) titleEl.textContent = sess.title;
  lastBotText = '';

  // Re-render all messages using the shared render function
  renderHistoryToDOM();

  // Update sidebar highlight
  document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
  const sidebarEl = document.querySelector(`[data-sid="${sessionId}"]`);
  if(sidebarEl) sidebarEl.classList.add('active');

  chatEl.scrollTop = chatEl.scrollHeight;
  lastBotText = history.filter(m => m.role === 'assistant').at(-1)?.content || '';
  showToast(`üí¨ Restored: "${sess.title}"`);
}

// Shared DOM renderer ‚Äî used by restoreChat and switchTab
function renderHistoryToDOM(){
  history.forEach(m => {
    const isUser = m.role === 'user';
    const now = new Date().toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit' });
    const group = document.createElement('div'); group.className = 'msg-group';
    const row = document.createElement('div'); row.className = `msg-row ${isUser ? 'user-row' : ''}`;
    const av = document.createElement('div'); av.className = `av ${isUser ? 'user-av' : 'bot-av'}`;
    av.textContent = isUser
      ? (currentUser ? currentUser.name.slice(0,1).toUpperCase() : 'üë§')
      : (botPersona.name.slice(0,1) || '‚ú¶');
    const content = document.createElement('div'); content.className = 'msg-content';
    const mmeta = document.createElement('div'); mmeta.className = 'msg-meta';
    const nameEl = document.createElement('div'); nameEl.className = 'msg-name';
    const timeEl = document.createElement('div'); timeEl.className = 'msg-time';
    nameEl.textContent = isUser ? (currentUser ? currentUser.name : 'You') : botPersona.name;
    timeEl.textContent = now;
    mmeta.appendChild(nameEl); mmeta.appendChild(timeEl);
    const bubble = document.createElement('div');
    bubble.className = isUser ? 'bubble user-bubble' : 'bot-bubble';
    bubble.innerHTML = isUser ? `<p>${esc(m.content)}</p>` : md(m.content);
    const acts = document.createElement('div'); acts.className = 'msg-actions';
    if(!isUser){
      acts.innerHTML = `
        <button class="act-btn" onclick="copyMsg(this)"><svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Copy</button>
        <button class="act-btn" onclick="speakMsg(this)"><svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>Read</button>
        <button class="act-btn" onclick="regenMsg()"><svg viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.5"/></svg>Redo</button>
        <button class="act-btn" onclick="pinMsg(this)"><svg viewBox="0 0 24 24"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/></svg>Pin</button>
        <button class="act-btn" onclick="feedback(this,'like')"><svg viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3z"/><path d="M7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>Good</button>
        <button class="act-btn delete-btn" onclick="deleteMsg(this)"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>Del</button>`;
    } else {
      acts.innerHTML = `
        <button class="act-btn" onclick="editMsg(this)"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Edit</button>
        <button class="act-btn delete-btn" onclick="deleteMsg(this)"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>Del</button>`;
    }
    bubble.appendChild(acts);
    content.appendChild(mmeta); content.appendChild(bubble);
    row.appendChild(av); row.appendChild(content);
    group.appendChild(row); chatEl.appendChild(group);
  });
}

// Load sessions persisted from previous browser session
try{
  const saved = localStorage.getItem('rb_sessions');
  if(saved){
    const parsed = JSON.parse(saved);
    parsed.forEach(s => chatSessions.push(s));
    // Render them in the sidebar
    const list = document.getElementById('chatHistList');
    if(list && chatSessions.length > 0){
      const placeholder = document.getElementById('defaultHistItem');
      if(placeholder) placeholder.remove();
      chatSessions.forEach(sess => {
        const mins = Math.round((Date.now()-sess.time)/60000);
        const age = mins < 60 ? mins+'m' : mins < 1440 ? Math.round(mins/60)+'h' : Math.round(mins/1440)+'d';
        const item = document.createElement('div');
        item.className = 'history-item';
        item.dataset.sid = sess.id;
        item.innerHTML = `
          <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <span class="hist-title" style="flex:1;overflow:hidden;text-overflow:ellipsis">${sess.title}</span>
          <span class="htime">${age}</span>
        `;
        item.onclick = () => restoreChat(sess.id);
        list.appendChild(item);
      });
    }
  }
}catch(e){}

function selectChat(el, name){
  document.querySelectorAll('.history-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  showToast('üí¨ ' + name);
}

let typingEl=null;
function showTyping(label='AI is thinking...'){
  welcomeEl.style.display='none';
  typingEl=document.createElement('div');typingEl.className='typing-row';
  typingEl.innerHTML=`<div class="typing-av">‚ú¶</div><div class="typing-wrap"><div class="typing-dots"><span></span><span></span><span></span></div><div class="typing-label" id="typing-label">${label}</div></div>`;
  chatEl.appendChild(typingEl);chatEl.scrollTop=chatEl.scrollHeight;
}
function updateTypingLabel(label){const el=document.getElementById('typing-label');if(el)el.textContent=label;}
function hideTyping(){if(typingEl){typingEl.remove();typingEl=null;}}

async function sendMsg(){
  const userTyped = inpEl.value.trim();
  // Build message ‚Äî merge file content + user text
  let text = '';
  if(pendingFile){
    const userNote = userTyped || 'Please analyze this file.';
    text = `üìé **File: "${pendingFile.name}"** (${pendingFile.size} KB ¬∑ ${pendingFile.lines} lines)\n\n\`\`\`\n${pendingFile.content}\n\`\`\`\n\n${userNote}`;
    removeFilePreview();
  } else {
    text = userTyped;
  }
  if(!text||sendBtn.disabled)return;
  addMsg('user',text);
  history.push({role:'user',content:text});
  inpEl.value='';inpEl.style.height='auto';
  document.getElementById('charCount').textContent='0';
  const wc=document.getElementById('wordCount');if(wc){wc.textContent='0 words';wc.classList.remove('show');}
  sendBtn.disabled=true;
  const t0=Date.now();
  showTyping('AI is thinking...');
  const{text:reply,cls,name}=await askAI(history,text);
  const ms=Date.now()-t0;
  hideTyping();
  history.push({role:'assistant',content:reply});
  addMsg('bot',reply,{cls,name,ms});
  sendBtn.disabled=false;inpEl.focus();
  // Tab title
  if(document.hidden){ document.title='üí¨ New reply ‚Äî RuleBot'; }
  // Save full conversation to session store
  saveCurrentSession();
}

// ‚îÄ‚îÄ MESSAGE ACTIONS ‚îÄ‚îÄ
function copyMsg(btn){
  // Walk up to the message group and find the raw stored text
  const group = btn.closest('.msg-group');
  const idx = Array.from(chatEl.querySelectorAll('.msg-group')).indexOf(group);
  // Find the matching bot message in history
  const botMessages = history.filter(m=>m.role==='assistant');
  // Count how many bot groups exist before this one
  const botGroups = Array.from(chatEl.querySelectorAll('.msg-group')).filter(g=>g.querySelector('.bot-bubble'));
  const botIdx = botGroups.indexOf(group);
  const rawText = botMessages[botIdx]?.content || '';
  if(!rawText){showToast('‚ö†Ô∏è Nothing to copy');return;}
  // Try clipboard API, fallback to textarea trick
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(rawText)
      .then(()=>showToast('üìã Response copied!'))
      .catch(()=>copyFallback(rawText));
  } else {
    copyFallback(rawText);
  }
}
function copyFallback(text){
  const ta=document.createElement('textarea');
  ta.value=text; ta.style.position='fixed'; ta.style.opacity='0';
  document.body.appendChild(ta); ta.select();
  try{document.execCommand('copy');showToast('üìã Response copied!');}
  catch(e){showToast('‚ö†Ô∏è Copy not supported in this browser');}
  document.body.removeChild(ta);
}
function copyCode(id){
  const el=document.getElementById(id);
  if(!el)return;
  const text=el.innerText||el.textContent||'';
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text)
      .then(()=>showToast('üìã Code copied!'))
      .catch(()=>copyFallback(text));
  } else {
    copyFallback(text);
  }
}
function feedback(btn,type){
  btn.closest('.msg-actions').querySelectorAll('.act-btn').forEach(b=>b.classList.remove('liked','disliked'));
  btn.classList.add(type==='like'?'liked':'disliked');
  showToast(type==='like'?'üëç Thanks!':'üëé Got it!');
}
function speakMsg(btn){
  const group = btn.closest('.msg-group');
  const botGroups = Array.from(chatEl.querySelectorAll('.msg-group')).filter(g=>g.querySelector('.bot-bubble'));
  const botIdx = botGroups.indexOf(group);
  const botMessages = history.filter(m=>m.role==='assistant');
  const text = botMessages[botIdx]?.content || '';
  if(!text){showToast('‚ö†Ô∏è Nothing to read');return;}
  if(isSpeaking){speechSynthesis.cancel();isSpeaking=false;showToast('üîá Stopped');return;}
  const utt=new SpeechSynthesisUtterance(text.replace(/[#*`_~>]/g,''));
  utt.rate=0.92;utt.lang='en-IN';
  utt.onend=()=>{isSpeaking=false;};
  try{ speechSynthesis.speak(utt); isSpeaking=true; showToast('üîä Reading...'); }catch(e){ showToast('‚ö†Ô∏è TTS not supported in this browser'); }
}
function readAloud(){
  if(!lastBotText){showToast('‚ö†Ô∏è No response to read');return;}
  if(isSpeaking){speechSynthesis.cancel();isSpeaking=false;showToast('üîá Stopped');return;}
  const utt=new SpeechSynthesisUtterance(lastBotText.replace(/[#*`_~>]/g,''));
  utt.rate=0.95;utt.lang='en-IN';
  utt.onend=()=>{isSpeaking=false;};
  speechSynthesis.speak(utt);isSpeaking=true;showToast('üîä Reading last response...');
}
async function regenMsg(){
  if(history.length<2||sendBtn.disabled)return;
  const groups=chatEl.querySelectorAll('.msg-group');
  if(groups.length)groups[groups.length-1].remove();
  history.pop();
  sendBtn.disabled=true;showTyping('Regenerating...');
  const{text:reply,cls,name}=await askAI(history,history[history.length-1]?.content||'');
  hideTyping();
  history.push({role:'assistant',content:reply});
  addMsg('bot',reply,{cls,name});
  sendBtn.disabled=false;
  showToast('üîÑ Regenerated!');
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function openExport(){
  if(!history.length){ showToast('‚ö†Ô∏è Start a conversation first, then export'); return; }
  currentExportFmt = 'txt';
  ['txt','md','json'].forEach(f=>{
    const b = document.getElementById('efmt-'+f);
    if(b) b.classList.toggle('active', f==='txt');
  });
  updateExportPreview();
  const st = document.getElementById('exportStatus');
  if(st) st.textContent = '';
  openModal('exportModal');
}

let currentExportFmt = 'txt';

function switchExportFmt(fmt){
  currentExportFmt = fmt;
  ['txt','md','json'].forEach(f=>{
    const b = document.getElementById('efmt-'+f);
    if(b) b.classList.toggle('active', f===fmt);
  });
  updateExportPreview();
}

function buildContent(fmt){
  const ts    = new Date().toLocaleString('en-IN');
  const title = document.getElementById('topbarTitle')?.textContent || 'RuleBot Chat';
  if(fmt==='json'){
    return JSON.stringify({
      title, exported:ts, model:'RuleBot AI',
      messages: history.map(m=>({role:m.role, content:m.content}))
    }, null, 2);
  }
  if(fmt==='md'){
    return `# ${title}\n\n**Exported:** ${ts}  \n**Messages:** ${history.length}\n\n---\n\n`
      + history.map(m=>`## ${m.role==='user'?'üë§ You':'ü§ñ RuleBot AI'}\n\n${m.content}`).join('\n\n---\n\n');
  }
  const line = '‚îÄ'.repeat(48);
  return `RULEBOT AI ‚Äî CHAT EXPORT\n${line}\nTitle   : ${title}\nExported: ${ts}\nMessages: ${history.length}\n${line}\n\n`
    + history.map(m=>`[ ${m.role==='user'?'YOU':'RULEBOT'} ]\n${m.content}`).join(`\n\n${line}\n\n`);
}

function updateExportPreview(){
  const content = buildContent(currentExportFmt);
  const ta = document.getElementById('exportTextarea');
  if(ta){ ta.value = content; ta.scrollTop = 0; }
  const cc = document.getElementById('exportCharCount');
  if(cc) cc.textContent = `(${content.length.toLocaleString()} chars)`;
}

function selectExportAll(){
  const ta = document.getElementById('exportTextarea');
  if(!ta) return;
  ta.focus(); ta.select();
  setExportStatus('All selected ‚Äî press Ctrl+C to copy');
}

function setExportStatus(msg, isErr=false){
  const el = document.getElementById('exportStatus');
  if(el){ el.textContent = msg; el.style.color = isErr ? '#f87171' : 'var(--green)'; }
}

function doDownload(){
  if(!history.length){ showToast('‚ö†Ô∏è No messages to export'); return; }
  const content  = buildContent(currentExportFmt);
  const mimeMap  = { txt:'text/plain', md:'text/markdown', json:'application/json' };
  const mime     = mimeMap[currentExportFmt] || 'text/plain';
  const filename = `rulebot-chat.${currentExportFmt}`;

  // Method 1 ‚Äî Blob + dispatchEvent (most reliable, works outside sandbox)
  try{
    const blob = new Blob([content], { type: mime+';charset=utf-8' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,view:window}));
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
    setExportStatus(`‚úÖ Downloading "${filename}"‚Ä¶`);
    showToast(`‚úÖ Downloading ${filename}`);
    return;
  }catch(e1){}

  // Method 2 ‚Äî msSaveBlob (IE/old Edge)
  try{
    if(window.navigator && window.navigator.msSaveBlob){
      window.navigator.msSaveBlob(new Blob([content],{type:mime}), filename);
      setExportStatus(`‚úÖ "${filename}" saved!`);
      return;
    }
  }catch(e2){}

  // Fallback ‚Äî auto-copy + tell user to paste
  doCopyExport();
  setExportStatus('‚ö†Ô∏è Direct download blocked. Content copied ‚Äî paste into Notepad & save as .'+currentExportFmt, true);
  showToast('üìã Copied! Paste into Notepad ‚Üí Save as .'+currentExportFmt);
}

function doCopyExport(){
  const content = buildContent(currentExportFmt);
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(content)
      .then(()=>{ setExportStatus('‚úÖ Copied to clipboard! Paste anywhere to save.'); showToast('üìã Chat copied!'); })
      .catch(()=>copyViaTextarea());
  } else { copyViaTextarea(); }
}

function copyViaTextarea(){
  const ta = document.getElementById('exportTextarea');
  if(ta){
    ta.focus(); ta.select();
    try{
      document.execCommand('copy');
      setExportStatus('‚úÖ Copied! Paste into any text editor to save.');
      showToast('üìã Copied to clipboard!');
      return;
    }catch(e){}
  }
  setExportStatus('‚ö†Ô∏è Click the text above ‚Üí Ctrl+A ‚Üí Ctrl+C to copy manually.', true);
}

function dlChat(fmt){
  if(fmt==='pdf'){ exportPDF(); return; }
  if(!history.length){ showToast('‚ö†Ô∏è No messages to export'); return; }
  currentExportFmt = fmt;
  // Switch tab highlight
  ['txt','md','json'].forEach(f=>{
    const b = document.getElementById('efmt-'+f);
    if(b) b.classList.toggle('active', f===fmt);
  });
  updateExportPreview();
  doDownload();
}

function exportPDF(){
  if(!history.length){ showToast('‚ö†Ô∏è No messages to export'); return; }

  const title = document.getElementById('topbarTitle')?.textContent || 'RuleBot Chat';
  const date  = new Date().toLocaleString('en-IN');

  // Build message rows
  const rows = history.map(m=>{
    const isUser  = m.role==='user';
    const who     = isUser ? 'üë§ You' : 'ü§ñ RuleBot AI';
    const bgColor = isUser ? '#eef0fa' : '#f0f0ff';
    const border  = isUser ? '#6c63ff' : '#a78bfa';
    const safe = m.content
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/```[\w]*\n?([\s\S]*?)```/g,'<pre>$1</pre>')
      .replace(/`([^`\n]+)`/g,'<code>$1</code>')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>')
      .replace(/^#{1,3} (.+)$/gm,'<h3>$1</h3>')
      .replace(/^[-*] (.+)$/gm,'<li>$1</li>')
      .replace(/\n{2,}/g,'</p><p>').replace(/\n/g,'<br>');
    return `<div style="margin:12px 0;padding:14px 18px;background:${bgColor};border-left:4px solid ${border};border-radius:0 10px 10px 0;font-size:13.5px;line-height:1.75;page-break-inside:avoid">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#888;margin-bottom:8px">${who}</div>
      <div><p>${safe}</p></div>
    </div>`;
  }).join('');

  const printHTML = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8">
  <title>${title}</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI',Arial,sans-serif;color:#1a1a2e;background:#fff;max-width:780px;margin:0 auto;padding:36px 28px;font-size:13.5px;line-height:1.75}
    .hdr{border-bottom:3px solid #6c63ff;padding-bottom:14px;margin-bottom:28px}
    .hdr h1{font-size:22px;color:#6c63ff;margin-bottom:5px;font-weight:700}
    .hdr .meta{font-size:11px;color:#999}
    pre{background:#1e2235;color:#a5f3fc;padding:12px 14px;border-radius:8px;font-size:11px;overflow-x:auto;margin:8px 0;font-family:'Courier New',monospace;white-space:pre-wrap;line-height:1.5}
    code{background:#f0f0f8;padding:2px 6px;border-radius:4px;font-size:11px;font-family:'Courier New',monospace;color:#5b5bd6}
    h3{margin:10px 0 5px;font-size:14px;color:#1a1a2e}
    li{margin:3px 0;padding-left:4px}
    ul{padding-left:20px;margin:6px 0}
    p{margin:5px 0}
    strong{font-weight:700}em{font-style:italic}
    .ftr{margin-top:32px;padding-top:14px;border-top:1px solid #e5e7eb;font-size:10px;color:#bbb;text-align:center}
    @media print{
      body{padding:16px;max-width:100%}
      @page{margin:1.5cm;size:A4}
      pre{color:#1e40af!important;background:#eff6ff!important}
    }
  </style>
  </head><body>
  <div class="hdr">
    <h1>‚ú¶ ${title}</h1>
    <div class="meta">Exported: ${date} &nbsp;¬∑&nbsp; ${history.length} messages &nbsp;¬∑&nbsp; RuleBot AI</div>
  </div>
  ${rows}
  <div class="ftr">Generated by RuleBot AI ‚Äî Powered by AI</div>
  </body></html>`;

  // ‚îÄ‚îÄ METHOD 1: Hidden iframe print (works in sandboxed environments, no popup needed) ‚îÄ‚îÄ
  try{
    // Remove any previous print iframe
    const old = document.getElementById('__printFrame');
    if(old) old.remove();

    const iframe = document.createElement('iframe');
    iframe.id = '__printFrame';
    iframe.style.cssText = 'position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;border:none;visibility:hidden';
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open(); doc.write(printHTML); doc.close();

    iframe.onload = ()=>{
      try{
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
        closeModal('exportModal');
        showToast('üñ®Ô∏è Print dialog opened ‚Äî select "Save as PDF"');
        // Clean up after printing
        setTimeout(()=>{ const f=document.getElementById('__printFrame'); if(f) f.remove(); }, 3000);
      }catch(printErr){
        iframe.remove();
        tryPopupPDF(printHTML, title);
      }
    };
    return;
  }catch(e1){}

  // ‚îÄ‚îÄ METHOD 2: window.open popup ‚îÄ‚îÄ
  tryPopupPDF(printHTML, title);
}

function tryPopupPDF(printHTML, title){
  try{
    const w = window.open('','_blank','width=900,height=700,noopener');
    if(w){
      w.document.write(printHTML);
      w.document.close();
      w.focus();
      setTimeout(()=>{ try{ w.print(); }catch(e){} }, 500);
      closeModal('exportModal');
      showToast('üñ®Ô∏è Choose "Save as PDF" in the print dialog');
      return;
    }
  }catch(e2){}

  // ‚îÄ‚îÄ METHOD 3: Download as HTML file ‚Äî user opens it and prints ‚îÄ‚îÄ
  try{
    const blob = new Blob([printHTML], {type:'text/html;charset=utf-8'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = 'rulebot-chat-printable.html';
    a.style.display = 'none';
    document.body.appendChild(a);
    a.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,view:window}));
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
    closeModal('exportModal');
    showToast('‚úÖ Downloaded printable HTML ‚Äî open it, press Ctrl+P ‚Üí Save as PDF');
    setExportStatus('‚úÖ Open the downloaded file ‚Üí Ctrl+P ‚Üí Save as PDF');
  }catch(e3){
    // ‚îÄ‚îÄ FINAL FALLBACK: Show print view inside current page ‚îÄ‚îÄ
    showInPagePDF(printHTML);
  }
}

function showInPagePDF(printHTML){
  // Last resort: show styled content in a full-screen overlay inside the page
  const overlay = document.createElement('div');
  overlay.id = '__pdfOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:#fff;z-index:99999;overflow-y:auto;padding:0';
  overlay.innerHTML = `
    <div style="position:sticky;top:0;background:#6c63ff;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;z-index:1;box-shadow:0 2px 8px rgba(0,0,0,.2)">
      <div style="font-weight:700;font-size:.95rem">üìÑ Print Preview ‚Äî press Ctrl+P to save as PDF</div>
      <div style="display:flex;gap:8px">
        <button onclick="window.print()" style="background:#fff;color:#6c63ff;border:none;border-radius:7px;padding:7px 16px;font-weight:700;cursor:pointer;font-size:.85rem">üñ®Ô∏è Print / Save PDF</button>
        <button onclick="document.getElementById('__pdfOverlay').remove()" style="background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.4);border-radius:7px;padding:7px 14px;cursor:pointer;font-size:.85rem">‚úï Close</button>
      </div>
    </div>
    <div style="max-width:780px;margin:0 auto;padding:32px 24px" id="__pdfContent"></div>`;
  document.body.appendChild(overlay);

  // Parse and inject the body content safely
  const parser = new DOMParser();
  const parsed = parser.parseFromString(printHTML,'text/html');
  const contentDiv = document.getElementById('__pdfContent');
  if(contentDiv){
    // Copy body children into our div
    Array.from(parsed.body.children).forEach(el=>{ contentDiv.appendChild(document.importNode(el,true)); });
  }

  closeModal('exportModal');
  showToast('üìÑ Preview open ‚Äî click "Print / Save PDF" or press Ctrl+P');
}

function copyChat(){
  if(!history.length){ showToast('‚ö†Ô∏è No messages'); return; }
  doCopyExport();
}


// ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ
inpEl.addEventListener('input',()=>{inpEl.style.height='auto';inpEl.style.height=Math.min(inpEl.scrollHeight,180)+'px';document.getElementById('charCount').textContent=inpEl.value.length;});
inpEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}});
function fill(t){inpEl.value=t;inpEl.focus();inpEl.dispatchEvent(new Event('input'));}
function newChat(){
  // Save current session before starting new one
  saveCurrentSession();
  activeSessionId = null;
  history.length=0;
  lastBotText='';
  document.querySelectorAll('.msg-group,.typing-row').forEach(el=>el.remove());
  welcomeEl.style.display='';
  if(titleEl) titleEl.textContent='New conversation';
  setEngineUI(1,'Primary Engine');
  // Clear pinned messages
  if(typeof pinnedMsgs !== 'undefined'){ pinnedMsgs.length=0; renderPins(); }
  // Reset word count
  const wc=document.getElementById('wordCount');
  if(wc){ wc.textContent='0 words'; wc.classList.remove('show'); }
  const cc=document.getElementById('charCount');
  if(cc) cc.textContent='0';
  // Update tab title
  if(typeof chatTabs !== 'undefined' && typeof activeTabId !== 'undefined'){
    const cur=chatTabs.find(t=>t.id===activeTabId);
    if(cur){ cur.history=[]; cur.title='New conversation'; }
  }
  // Remove active highlight from sidebar
  document.querySelectorAll('.history-item').forEach(el=>el.classList.remove('active'));
  // Show placeholder if no sessions yet
  const list = document.getElementById('chatHistList');
  if(list && chatSessions.length === 0 && !document.getElementById('defaultHistItem')){
    list.innerHTML = '<div class="history-item active" id="defaultHistItem"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Getting started<span class="htime">Now</span></div>';
  }
}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');}));
function copyLink(){
  const val=document.getElementById('shareLink').value;
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(val).then(()=>showToast('‚úÖ Link copied!')).catch(()=>copyFallback(val));
  } else { copyFallback(val); }
  closeModal('shareModal');
}
function shareVia(p){const msg='Check out RuleBot AI!';const url=encodeURIComponent('https://rulebot.ai');const m={LinkedIn:`https://www.linkedin.com/sharing/share-offsite/?url=${url}`,Twitter:`https://twitter.com/intent/tweet?text=${encodeURIComponent(msg)}&url=${url}`,WhatsApp:`https://wa.me/?text=${encodeURIComponent(msg)}`,Email:`mailto:?subject=RuleBot AI&body=${encodeURIComponent(msg)}`};window.open(m[p],'_blank');closeModal('shareModal');showToast('üöÄ Opening '+p+'...');}

let isLight=false;
function toggleTheme(){
  isLight=!isLight;
  document.documentElement.setAttribute('data-theme',isLight?'light':'dark');
  document.getElementById('themeToggle').classList.toggle('on',isLight);
  document.getElementById('themeIcon').innerHTML=isLight?'<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>':'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
  showToast(isLight?'‚òÄÔ∏è Light mode':'üåô Dark mode');
}
function openSidebar(){document.getElementById('sidebar').classList.add('open');document.getElementById('mob-overlay').classList.add('show');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('mob-overlay').classList.remove('show');}
const scrollBtn=document.getElementById('scroll-btn');
chatEl.addEventListener('scroll',()=>{const atBottom=chatEl.scrollHeight-chatEl.scrollTop-chatEl.clientHeight<100;scrollBtn.classList.toggle('show',!atBottom&&chatEl.scrollHeight>chatEl.clientHeight+200);});
function scrollToBottom(){chatEl.scrollTo({top:chatEl.scrollHeight,behavior:'smooth'});}
// Ctrl+K and Escape handled by unified keydown listener below

// ‚îÄ‚îÄ IMAGE GENERATION (Pollinations AI ‚Äî free, no API key) ‚îÄ‚îÄ
// ‚îÄ‚îÄ AUTH SYSTEM ‚îÄ‚îÄ
let currentUser = null;
// Safe hash that works with any characters (no btoa Unicode crash)
function safeHash(str){
  let hash = 0;
  for(let i=0;i<str.length;i++){
    const c=str.charCodeAt(i);
    hash=((hash<<5)-hash)+c;
    hash|=0;
  }
  return 'h_'+Math.abs(hash).toString(36);
}
const users = JSON.parse(localStorage.getItem('rulebot_users')||'{}');

function openAuthPage(){
  closeUserMenu();
  // ‚úÖ KEY FIX: If already logged in ‚Üí show Account Details, NOT sign-in page
  if(currentUser){
    openAccountModal();
    return;
  }
  document.getElementById('authOverlay').style.display='block';
}

function openAccountModal(){
  if(!currentUser) return;
  // Populate account modal with current user data
  const initials = currentUser.name.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('acctAvatar').textContent   = initials;
  document.getElementById('acctName').textContent     = currentUser.name;
  document.getElementById('acctEmail').textContent    = currentUser.email;
  document.getElementById('acctNameRow').textContent  = currentUser.name;
  document.getElementById('acctEmailRow').textContent = currentUser.email;
  document.getElementById('acctBadge').textContent    = 'FREE PLAN';
  // Stats from current session
  const msgs  = typeof history !== 'undefined' ? history.length : 0;
  const words = typeof history !== 'undefined' ? history.reduce((a,m)=>a+(m.content?m.content.trim().split(/\s+/).length:0),0) : 0;
  const sessions = parseInt(localStorage.getItem('rulebot_session_count')||'1');
  document.getElementById('acctMsgCount').textContent    = msgs;
  document.getElementById('acctWordCount').textContent   = words > 999 ? (words/1000).toFixed(1)+'k' : words;
  document.getElementById('acctSessionCount').textContent = sessions;
  // Reset change password section
  document.getElementById('changePassFields').style.display = 'none';
  document.getElementById('cpMsg').textContent = '';
  ['cpOld','cpNew','cpNew2'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  openModal('accountModal');
}

function editAccountField(field){
  if(!currentUser) return;
  if(field === 'name'){
    const newName = prompt('Enter new name:', currentUser.name);
    if(!newName || !newName.trim()) return;
    currentUser.name = newName.trim();
    // Save to users store
    if(users[currentUser.email]) users[currentUser.email].name = currentUser.name;
    try{ localStorage.setItem('rulebot_users', JSON.stringify(users)); }catch(e){}
    loginUser(currentUser);  // refresh UI
    openAccountModal();      // refresh modal
    showToast('‚úÖ Name updated!');
  }
  if(field === 'email'){
    const newEmail = prompt('Enter new email:', currentUser.email);
    if(!newEmail || !newEmail.trim() || !newEmail.includes('@')) return;
    const newEmailTrimmed = newEmail.trim();
    // Move user record to new email key
    if(users[currentUser.email]){
      users[newEmailTrimmed] = users[currentUser.email];
      delete users[currentUser.email];
      try{ localStorage.setItem('rulebot_users', JSON.stringify(users)); }catch(e){}
    }
    currentUser.email = newEmailTrimmed;
    loginUser(currentUser);
    openAccountModal();
    showToast('‚úÖ Email updated!');
  }
}

function toggleChangePass(){
  const el = document.getElementById('changePassFields');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
  document.getElementById('cpMsg').textContent = '';
}

function doChangePass(){
  const oldPass = document.getElementById('cpOld').value;
  const newPass = document.getElementById('cpNew').value;
  const conf    = document.getElementById('cpNew2').value;
  const msgEl   = document.getElementById('cpMsg');
  if(!oldPass||!newPass||!conf){ msgEl.style.color='#f87171'; msgEl.textContent='‚ö†Ô∏è Fill in all fields'; return; }
  const stored  = users[currentUser.email];
  if(stored && stored.pass !== safeHash(oldPass)){ msgEl.style.color='#f87171'; msgEl.textContent='‚ùå Current password is wrong'; return; }
  if(newPass.length < 6){ msgEl.style.color='#f87171'; msgEl.textContent='‚ö†Ô∏è New password must be 6+ characters'; return; }
  if(newPass !== conf){ msgEl.style.color='#f87171'; msgEl.textContent='‚ùå Passwords do not match'; return; }
  if(stored) stored.pass = safeHash(newPass);
  try{ localStorage.setItem('rulebot_users', JSON.stringify(users)); }catch(e){}
  msgEl.style.color = '#4ade80';
  msgEl.textContent = '‚úÖ Password updated successfully!';
  setTimeout(()=>{ document.getElementById('changePassFields').style.display='none'; msgEl.textContent=''; }, 1800);
  showToast('üîê Password changed!');
}

function doSignOutFromAccount(){
  closeModal('accountModal');
  currentUser = null;
  document.getElementById('userAvatar').textContent      = '?';
  document.getElementById('menuUserName').textContent    = 'Guest User';
  document.getElementById('menuUserEmail').textContent   = 'Not signed in';
  document.getElementById('authActionLabel').textContent = 'Sign In';
  showToast('üëã Signed out successfully');
}

function closeAuthPage(){
  document.getElementById('authOverlay').style.display='none';
}

function switchAuthTab(tab){
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',(i===0&&tab==='login')||(i===1&&tab==='signup')));
  document.getElementById('loginFields').style.display = tab==='login'?'block':'none';
  document.getElementById('signupFields').style.display = tab==='signup'?'block':'none';
  clearAuthMessages();
}

function showAuthMessage(type, msg){
  clearAuthMessages();
  const el = document.getElementById(type==='error'?'authError':'authSuccess');
  el.textContent = msg;
  el.style.display = 'block';
}
function clearAuthMessages(){
  document.getElementById('authError').style.display='none';
  document.getElementById('authSuccess').style.display='none';
}

function doLogin(){
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPass').value;
  if(!email||!pass){ showAuthMessage('error','‚ö†Ô∏è Please fill in all fields'); return; }
  if(!email.includes('@')){ showAuthMessage('error','‚ö†Ô∏è Enter a valid email address'); return; }
  // Check stored users
  const stored = users[email];
  if(!stored){ showAuthMessage('error','‚ùå No account found. Please sign up first.'); return; }
  if(stored.pass !== safeHash(pass)){ showAuthMessage('error','‚ùå Wrong password. Try again.'); return; }
  // Login success
  loginUser({name:stored.name, email});
  showAuthMessage('success','‚úÖ Signed in successfully! Redirecting...');
  setTimeout(()=>closeAuthPage(), 1200);
}

function doSignup(){
  const name  = document.getElementById('signupName').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const pass  = document.getElementById('signupPass').value;
  const pass2 = document.getElementById('signupPass2').value;
  if(!name||!email||!pass||!pass2){ showAuthMessage('error','‚ö†Ô∏è Please fill in all fields'); return; }
  if(!email.includes('@')){ showAuthMessage('error','‚ö†Ô∏è Enter a valid email address'); return; }
  if(pass.length<6){ showAuthMessage('error','‚ö†Ô∏è Password must be at least 6 characters'); return; }
  if(pass!==pass2){ showAuthMessage('error','‚ùå Passwords do not match'); return; }
  if(users[email]){ showAuthMessage('error','‚ùå Account already exists. Please sign in.'); return; }
  // Save user
  users[email] = {name, pass:safeHash(pass)};
  try{ localStorage.setItem('rulebot_users', JSON.stringify(users)); }catch(e){}
  loginUser({name, email});
  showAuthMessage('success','üéâ Account created! Welcome to RuleBot AI!');
  setTimeout(()=>closeAuthPage(), 1200);
}

function socialLogin(provider){
  // Simulate social login
  const fakeUsers = {
    Google: {name:'Google User', email:'user@gmail.com'},
    GitHub: {name:'GitHub User', email:'user@github.com'}
  };
  const u = fakeUsers[provider];
  loginUser(u);
  showAuthMessage('success',`‚úÖ Signed in with ${provider}! Redirecting...`);
  setTimeout(()=>closeAuthPage(), 1200);
}

function loginUser(user){
  currentUser = user;
  // Update avatar and menu
  const initials = user.name.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('userAvatar').textContent      = initials;
  document.getElementById('menuUserName').textContent    = user.name;
  document.getElementById('menuUserEmail').textContent   = user.email;
  document.getElementById('authActionLabel').textContent = 'Sign Out';
  // Track session count
  const sc = parseInt(localStorage.getItem('rulebot_session_count')||'0')+1;
  try{ localStorage.setItem('rulebot_session_count', sc); }catch(e){}
  showToast(`üëã Welcome, ${user.name.split(' ')[0]}!`);
}

function handleAuthAction(){
  if(currentUser){
    // Logout
    currentUser = null;
    document.getElementById('userAvatar').textContent = '?';
    document.getElementById('menuUserName').textContent = 'Guest User';
    document.getElementById('menuUserEmail').textContent = 'Not signed in';
    document.getElementById('authActionLabel').textContent = 'Sign In';
    closeUserMenu();
    showToast('üëã Signed out successfully');
  } else {
    closeUserMenu();
    openAuthPage();
  }
}

function toggleUserMenu(){
  const menu = document.getElementById('userMenu');
  menu.style.display = menu.style.display==='none' ? 'block' : 'none';
}
function closeUserMenu(){
  document.getElementById('userMenu').style.display='none';
}

// Close user menu on outside click
document.addEventListener('click', e=>{
  const wrap = document.getElementById('userAvatar');
  const menu = document.getElementById('userMenu');
  if(menu && wrap && !wrap.contains(e.target) && !menu.contains(e.target)){
    menu.style.display='none';
  }
});

// Auth Escape handled by unified keydown listener below

// Show auth page on first load after 1.5s if not logged in
setTimeout(()=>{
  if(!currentUser){
    // Only show once per session
    if(!sessionStorage.getItem('authShown')){
      sessionStorage.setItem('authShown','1');
      openAuthPage();
    }
  }
}, 1500);

setEngineUI(1,'Primary Engine');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ NEW FEATURES ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ WORD COUNT ‚îÄ‚îÄ
inpEl.addEventListener('input', ()=>{
  const val = inpEl.value;
  const words = val.trim() ? val.trim().split(/\s+/).length : 0;
  const wc = document.getElementById('wordCount');
  const cc = document.getElementById('charCount');
  if(cc) cc.textContent = val.length;
  if(wc){ wc.textContent = words + (words===1?' word':' words'); wc.classList.toggle('show', words>0); }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ AI PERSONA SYSTEM ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadPersonaUI(){
  const ni = document.getElementById('userNameInput');
  const bi = document.getElementById('botNameInput');
  if(ni) ni.value = botPersona.userName || '';
  if(bi) bi.value = botPersona.name || 'RuleBot';
  document.querySelectorAll('.persona-chip').forEach(c=>{
    c.classList.toggle('active', c.getAttribute('onclick').includes(currentPersonaStyle));
  });
  previewPersona();
}
function selectPersona(btn, style){
  currentPersonaStyle = style;
  document.querySelectorAll('.persona-chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  previewPersona();
}
function previewPersona(){
  const name = document.getElementById('botNameInput')?.value || 'RuleBot';
  const user = document.getElementById('userNameInput')?.value;
  const previews = {
    friendly: `Hi ${user||'there'}! üòä I'm ${name}, your friendly AI. I'm here to help with anything you need!`,
    professional: `Good day${user?', '+user:''}. I am ${name}. How may I assist you today?`,
    funny: `Hey ${user||'human'}! üòÇ I'm ${name} ‚Äî I know 10,000 jokes and I'm not afraid to use them!`,
    concise: `${name} here. What do you need? I'll be brief.`,
    teacher: `Hello${user?', '+user:''}! üìö I'm ${name}. Let's learn something amazing today ‚Äî step by step!`,
    creative: `‚ú® Greetings, ${user||'creative soul'}! I'm ${name} ‚Äî ready to paint ideas with words!`
  };
  const prev = document.getElementById('personaPreview');
  if(prev) prev.textContent = previews[currentPersonaStyle] || '';
}
function applyPersona(){
  const name = document.getElementById('botNameInput')?.value.trim() || 'RuleBot';
  const userName = document.getElementById('userNameInput')?.value.trim() || '';
  botPersona = { name, style: currentPersonaStyle, userName };
  // Update welcome greeting
  const greet = document.querySelector('.welcome-greeting');
  if(greet && userName) greet.innerHTML = `Hello, <span>${userName}</span>! üëã`;
  // Update sidebar
  const modelName = document.querySelector('.model-name');
  if(modelName) modelName.textContent = name;
  // Update topbar title pill
  const pill = document.querySelector('.ai-pill');
  if(pill) pill.innerHTML = `<span class="dot"></span>${name}`;
  closeModal('personaModal');
  showToast(`üé≠ Persona applied ‚Äî ${name} is now ${currentPersonaStyle}!`);
  try{ localStorage.setItem('rb_persona', JSON.stringify(botPersona)); localStorage.setItem('rb_persona_style', currentPersonaStyle); }catch(e){}
}
// Persona already restored at top of script

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ FOCUS / ZEN MODE ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let focusMode = false;
function toggleFocusMode(){
  focusMode = !focusMode;
  document.body.classList.toggle('focus-mode', focusMode);
  const btn = document.getElementById('focusBtn');
  if(btn) btn.classList.toggle('active', focusMode);
  showToast(focusMode ? 'üéØ Focus mode ON ‚Äî sidebar hidden' : '‚Ü©Ô∏è Focus mode OFF');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ MULTI-CHAT TABS ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chatTabs = [];
let activeTabId = null;

function initTabs(){
  chatTabs = [{
    id: 'tab_'+Date.now(),
    title: 'Getting started',
    history: [],
    created: Date.now()
  }];
  activeTabId = chatTabs[0].id;
}
initTabs();

function renderChatTabs(){
  const list = document.getElementById('chatTabList');
  if(!list) return;
  list.innerHTML = chatTabs.map(tab=>`
    <div class="chat-tab-item ${tab.id===activeTabId?'active-tab':''}" onclick="switchTab('${tab.id}')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <span class="chat-tab-name">${tab.title}</span>
      <span class="chat-tab-count">${tab.history.filter(m=>m.role==='user').length} msg${tab.history.filter(m=>m.role==='user').length!==1?'s':''}</span>
      ${chatTabs.length>1?`<button class="chat-tab-del" onclick="event.stopPropagation();deleteTab('${tab.id}')">‚úï</button>`:''}
    </div>`).join('');
}

function createNewTab(){
  // Save current
  const cur = chatTabs.find(t=>t.id===activeTabId);
  if(cur) cur.history = [...history];
  // Create new
  const id = 'tab_'+Date.now();
  chatTabs.push({ id, title:'New conversation', history:[], created:Date.now() });
  switchTab(id);
  closeModal('multiChatModal');
  showToast('üí¨ New conversation started');
}

function switchTab(id){
  // Save current tab's history
  const cur = chatTabs.find(t=>t.id===activeTabId);
  if(cur) cur.history = [...history];
  // Load new tab
  const tab = chatTabs.find(t=>t.id===id);
  if(!tab) return;
  activeTabId = id;
  history.length = 0;
  tab.history.forEach(m=>history.push(m));
  // Clear DOM
  document.querySelectorAll('.msg-group,.typing-row').forEach(el=>el.remove());
  welcomeEl.style.display = history.length ? 'none' : '';
  if(titleEl) titleEl.textContent = tab.title;
  // Re-render using shared renderer
  renderHistoryToDOM();
  chatEl.scrollTop = chatEl.scrollHeight;
  renderChatTabs();
  closeModal('multiChatModal');
  showToast(`üí¨ Switched to: ${tab.title}`);
}

function deleteTab(id){
  if(chatTabs.length<=1){ showToast('‚ö†Ô∏è Cannot delete the only tab'); return; }
  chatTabs = chatTabs.filter(t=>t.id!==id);
  if(activeTabId===id) switchTab(chatTabs[chatTabs.length-1].id);
  else renderChatTabs();
  showToast('üóëÔ∏è Conversation deleted');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ EDIT & DELETE MESSAGES ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function editMsg(btn){
  const group = btn.closest('.msg-group');
  const bubble = group.querySelector('.user-bubble');
  if(!bubble) return;
  const currentText = bubble.querySelector('p')?.textContent || '';
  // Check if already editing
  if(group.querySelector('.edit-area')) return;
  const editArea = document.createElement('textarea');
  editArea.className = 'edit-area';
  editArea.value = currentText;
  const editRow = document.createElement('div');
  editRow.className = 'edit-row';
  const saveBtn = document.createElement('button');
  saveBtn.className = 'copy-btn'; saveBtn.style.cssText='padding:5px 12px;font-size:.75rem';
  saveBtn.textContent = '‚úÖ Save & Resend';
  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'exp-btn sec'; cancelBtn.style.cssText='padding:5px 12px;font-size:.75rem;flex:none';
  cancelBtn.textContent = 'Cancel';
  editRow.appendChild(cancelBtn); editRow.appendChild(saveBtn);
  bubble.style.display = 'none';
  group.querySelector('.msg-content').appendChild(editArea);
  group.querySelector('.msg-content').appendChild(editRow);
  editArea.focus();
  cancelBtn.onclick = ()=>{ editArea.remove(); editRow.remove(); bubble.style.display=''; };
  saveBtn.onclick = async ()=>{
    const newText = editArea.value.trim();
    if(!newText) return;
    // Find position in history
    const allGroups = [...chatEl.querySelectorAll('.msg-group')];
    const gIdx = allGroups.indexOf(group);
    // Find corresponding history index (count user messages up to this group)
    let userCount = 0;
    for(let i=0;i<=gIdx;i++){
      if(allGroups[i].querySelector('.user-bubble')) userCount++;
    }
    const userMsgs = history.filter(m=>m.role==='user');
    const histIdx = history.indexOf(userMsgs[userCount-1]);
    if(histIdx!==-1){
      history[histIdx].content = newText;
      // Remove all messages after this point from DOM and history
      history.splice(histIdx+1);
      for(let i=gIdx+1;i<allGroups.length;i++) allGroups[i].remove();
      // Update bubble
      bubble.innerHTML = `<p>${esc(newText)}</p>`;
      bubble.style.display = '';
      editArea.remove(); editRow.remove();
      // Resend
      sendBtn.disabled=true;
      const t0=Date.now();
      showTyping('Regenerating...');
      const{text:reply,cls,name}=await askAI(history,newText);
      const ms=Date.now()-t0;
      hideTyping();
      history.push({role:'assistant',content:reply});
      addMsg('bot',reply,{cls,name,ms});
      sendBtn.disabled=false;
    }
  };
}

function deleteMsg(btn){
  const group = btn.closest('.msg-group');
  const allGroups = [...chatEl.querySelectorAll('.msg-group')];
  const gIdx = allGroups.indexOf(group);
  const isUser = !!group.querySelector('.user-bubble');
  // Fade out
  group.style.transition = 'opacity .25s, transform .25s';
  group.style.opacity = '0';
  group.style.transform = 'translateX(20px)';
  setTimeout(()=>{
    group.remove();
    // Remove from history: find by counting messages
    let userCount=0, botCount=0;
    for(let i=0;i<gIdx;i++){
      if(allGroups[i].querySelector('.user-bubble')) userCount++;
      else if(allGroups[i].querySelector('.bot-bubble')) botCount++;
    }
    const target = isUser ? history.filter(m=>m.role==='user')[userCount]
                          : history.filter(m=>m.role==='assistant')[botCount];
    if(target){ const idx=history.indexOf(target); if(idx!==-1) history.splice(idx,1); }
    showToast('üóëÔ∏è Message deleted');
  },250);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ PRINT CHAT ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doPrint(){
  if(!history.length){ showToast('‚ö†Ô∏è No messages to print yet'); return; }
  const inclTS = document.getElementById('print-ts')?.classList.contains('on');
  const inclEng = document.getElementById('print-eng')?.classList.contains('on');
  const darkPrint = document.getElementById('print-dark')?.classList.contains('on');
  const bg = darkPrint ? '#0b0d13' : '#ffffff';
  const fg = darkPrint ? '#e2e4f0' : '#1a1d2e';
  const accent = '#6c63ff';
  let printHtml = `<!DOCTYPE html><html><head><title>${botPersona.name} Chat</title><style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:${bg};color:${fg};font-family:'Segoe UI',system-ui,sans-serif;max-width:720px;margin:0 auto;padding:32px 24px;font-size:14px;line-height:1.6}
    h1{font-size:1.4rem;margin-bottom:4px;color:${accent};font-weight:600}
    .subtitle{font-size:.75rem;color:#888;margin-bottom:28px;padding-bottom:16px;border-bottom:1px solid ${darkPrint?'rgba(255,255,255,.1)':'rgba(0,0,0,.1)'}}
    .msg{margin-bottom:16px;padding:14px 18px;border-radius:12px;break-inside:avoid}
    .user{background:${darkPrint?'#181c2e':'#eef0fa'};border-left:3px solid ${accent}}
    .bot{background:${darkPrint?'#161922':'#f5f6fc'};border-left:3px solid #f472b6}
    .role{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;opacity:.6;display:flex;justify-content:space-between}
    pre{background:${darkPrint?'#070a10':'#f0f0f0'};padding:12px;border-radius:8px;overflow-x:auto;font-size:.8rem;margin:8px 0;font-family:monospace}
    strong{font-weight:700}em{font-style:italic}
    @media print{body{padding:16px}@page{margin:1.5cm}}
  </style></head><body>`;
  printHtml += `<h1>‚ú¶ ${botPersona.name}</h1><div class="subtitle">Exported ${new Date().toLocaleString('en-IN')} ¬∑ ${history.length} messages${inclEng&&enginesUsed.size?' ¬∑ '+[...enginesUsed].join(', '):''}</div>`;
  history.forEach((m,i)=>{
    const isUser = m.role==='user';
    const timeStr = inclTS ? `<span>${new Date().toLocaleTimeString()}</span>` : '';
    const content = m.content
      .replace(/```(\w*)\n?([\s\S]*?)```/g,'<pre><code>$2</code></pre>')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>')
      .replace(/\n/g,'<br>');
    printHtml += `<div class="msg ${isUser?'user':'bot'}"><div class="role"><span>${isUser?(botPersona.userName||'You'):(botPersona.name)}</span>${timeStr}</div><div>${content}</div></div>`;
  });
  printHtml += '</body></html>';
  const win = window.open('','_blank','width=800,height=700');
  if(!win){ showToast('‚ö†Ô∏è Pop-up blocked ‚Äî allow pop-ups and try again'); return; }
  win.document.write(printHtml);
  win.document.close();
  setTimeout(()=>win.print(), 500);
  closeModal('printModal');
  showToast('üñ®Ô∏è Print dialog opening...');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ CHAT BACKGROUND ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setChatBg(cls, optEl){
  const chat = document.getElementById('chat');
  chat.className = chat.className.replace(/\bbg-\S+/g,'').trim();
  if(cls) chat.classList.add(cls);
  document.querySelectorAll('.bg-opt').forEach(o=>o.classList.remove('active'));
  if(optEl) optEl.classList.add('active');
  try{ localStorage.setItem('rb_chatbg', cls); }catch(e){}
}
// Restore bg
try{ const bg=localStorage.getItem('rb_chatbg'); if(bg){ document.getElementById('chat').classList.add(bg); document.querySelectorAll('.bg-opt').forEach(o=>{ if(o.title.toLowerCase()===bg.replace('bg-','')) o.classList.add('active'); }); } }catch(e){}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function triggerFileUpload(){ document.getElementById('fileInput').click(); }

// Stores attached file content waiting to be sent
let pendingFile = null;

function handleFileUpload(input){
  const file = input.files ? input.files[0] : input;
  if(!file) return;

  // Block images / binary
  const isImage = file.type.startsWith('image/') || /\.(jpe?g|png|gif|webp|bmp|svg|ico|tiff?)$/i.test(file.name);
  if(isImage){
    showToast('‚ö†Ô∏è Images not supported. Attach a .txt, .py, .js, .json, .csv or .md file.');
    if(input.value !== undefined) input.value='';
    return;
  }
  const allowedExts = /\.(txt|md|csv|json|py|js|ts|jsx|tsx|html|css|xml|log|yaml|yml|sh|bat|c|cpp|h|java|php|rb|go|rs|swift|kt|r|sql|env|gitignore|toml|ini|cfg|conf)$/i;
  const isText = file.type.startsWith('text/') || file.type.includes('json') || file.type.includes('javascript') || allowedExts.test(file.name);
  if(!isText){
    showToast('‚ö†Ô∏è Only text/code files supported. Try .txt, .py, .js, .json, .csv, .md');
    if(input.value !== undefined) input.value='';
    return;
  }
  if(file.size > 600000){ showToast('‚ö†Ô∏è File too large (max 600KB)'); if(input.value !== undefined) input.value=''; return; }

  const reader = new FileReader();
  reader.onload = e=>{
    let text = e.target.result;
    // Detect binary/garbled
    const badChars = (text.match(/[\x00-\x08\x0b\x0c\x0e-\x1f]/g)||[]).length;
    if(badChars / Math.max(text.length,1) > 0.05){
      showToast('‚ö†Ô∏è File looks binary or corrupted. Only plain text files work.');
      if(input.value !== undefined) input.value='';
      return;
    }
    const sizeKB = Math.round(file.size/102.4)/10;
    const lines  = text.split('\n').length;
    const truncated = text.length > 8000 ? text.slice(0,8000)+'\n\n... [truncated ‚Äî showing first 8000 chars of '+text.length+' total]' : text;

    // Store for sending
    pendingFile = { name:file.name, size:sizeKB, lines, content:truncated };

    // Show preview card above textarea (NOT inside it)
    showFilePreview(file.name, sizeKB, lines, truncated);
    if(input.value !== undefined) input.value='';
  };
  reader.onerror = ()=>{ showToast('‚ö†Ô∏è Could not read file'); };
  reader.readAsText(file, 'UTF-8');
}

function showFilePreview(name, sizeKB, lines, content){
  // Remove any existing preview
  removeFilePreview();
  const ext = name.split('.').pop().toLowerCase();
  const icons = {py:'üêç',js:'üåê',ts:'üíô',jsx:'‚öõÔ∏è',tsx:'‚öõÔ∏è',html:'üåê',css:'üé®',json:'üìã',
    csv:'üìä',md:'üìù',txt:'üìÑ',java:'‚òï',cpp:'‚ö°',c:'‚ö°',sql:'üóÑÔ∏è',sh:'‚öôÔ∏è',yaml:'‚öôÔ∏è',yml:'‚öôÔ∏è'};
  const icon = icons[ext] || 'üìé';
  const preview = document.createElement('div');
  preview.id = 'filePreview';
  preview.style.cssText = `
    background:var(--surface2);border:1.5px solid var(--accent);border-radius:11px;
    padding:10px 14px;margin:6px 0 4px;display:flex;align-items:center;gap:10px;
    font-size:.82rem;animation:fadeUp .2s ease;position:relative;
  `;
  preview.innerHTML = `
    <span style="font-size:1.4rem;flex-shrink:0">${icon}</span>
    <div style="flex:1;min-width:0">
      <div style="font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</div>
      <div style="color:var(--muted2);font-size:.72rem">${sizeKB} KB ¬∑ ${lines} lines ¬∑ Ready to send</div>
    </div>
    <button onclick="removeFilePreview()" title="Remove file" style="
      background:rgba(248,113,113,.15);border:1px solid rgba(248,113,113,.3);
      color:#f87171;border-radius:6px;padding:3px 8px;cursor:pointer;font-size:.75rem;
      flex-shrink:0;font-family:var(--sans);transition:.15s
    ">‚úï Remove</button>
  `;
  // Insert ABOVE the input shell
  const inputBox = document.querySelector('.input-box');
  inputBox.insertBefore(preview, inputBox.firstChild);
  inpEl.placeholder = 'Add a message about this file, or press Send to analyze it...';
  inpEl.focus();
  showToast(`üìé "${name}" ready ‚Äî press Send to analyze`);
}

function removeFilePreview(){
  const prev = document.getElementById('filePreview');
  if(prev) prev.remove();
  pendingFile = null;
  inpEl.placeholder = 'Ask me anything...';
}

// File drag-and-drop
document.addEventListener('dragover', e=>{ e.preventDefault(); document.getElementById('dropZone').classList.add('show'); });
document.addEventListener('dragleave', e=>{ if(!e.relatedTarget) document.getElementById('dropZone').classList.remove('show'); });
document.addEventListener('drop', e=>{
  e.preventDefault();
  document.getElementById('dropZone').classList.remove('show');
  const file = e.dataTransfer.files[0];
  if(!file) return;
  const isImage = file.type.startsWith('image/') || /\.(jpe?g|png|gif|webp|bmp|svg|ico)$/i.test(file.name);
  if(isImage){ showToast('‚ö†Ô∏è Images not supported. Drop a .txt, .py, .js or .json file.'); return; }
  handleFileUpload(file); // pass file object directly
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ TAB NOTIFICATION ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tabNotifTimer = null;
const originalTitle = document.title;
function notifyTab(){
  if(tabNotifTimer) return;
  let blink = true;
  tabNotifTimer = setInterval(()=>{
    document.title = blink ? `üí¨ New reply ‚Äî ${botPersona.name}` : originalTitle;
    blink = !blink;
  }, 1000);
  document.addEventListener('visibilitychange', ()=>{
    if(!document.hidden){
      clearInterval(tabNotifTimer); tabNotifTimer=null;
      document.title = originalTitle;
    }
  },{once:true});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ FONT SIZE ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function changeFontSize(val){
  document.body.style.fontSize = val + 'px';
  const lbl = document.getElementById('fontSizeLabel');
  if(lbl) lbl.textContent = val + 'px';
  try{ localStorage.setItem('rb_fontSize', val); }catch(e){}
}
try{ const fs=localStorage.getItem('rb_fontSize'); if(fs){ document.body.style.fontSize=fs+'px'; const sl=document.getElementById('fontSlider'); if(sl) sl.value=fs; const lb=document.getElementById('fontSizeLabel'); if(lb) lb.textContent=fs+'px'; } }catch(e){}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ LANGUAGE ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let responseLanguage = 'english';
function changeLanguage(lang){
  responseLanguage = lang;
  const names={english:'English',hindi:'Hindi',telugu:'Telugu',tamil:'Tamil',spanish:'Spanish',french:'French',german:'German',japanese:'Japanese',arabic:'Arabic'};
  showToast('üåê Language: ' + (names[lang]||lang));
  try{ localStorage.setItem('rb_lang', lang); }catch(e){}
}
try{ const sl=localStorage.getItem('rb_lang'); if(sl){ responseLanguage=sl; const el=document.getElementById('langSelect'); if(el) el.value=sl; } }catch(e){}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ SOUND ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let soundEnabled = false;
function toggleSound(btn){ btn.classList.toggle('on'); soundEnabled=btn.classList.contains('on'); }
function playSound(type){
  if(!soundEnabled) return;
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator(); const gain=ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    if(type==='send'){osc.frequency.value=880;gain.gain.setValueAtTime(.07,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.1);}
    else{osc.frequency.value=523;gain.gain.setValueAtTime(.05,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.2);}
    osc.start(ctx.currentTime);osc.stop(ctx.currentTime+.25);
  }catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ TIMESTAMPS ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let showTimestamps = true;
function toggleTimestamps(btn){ btn.classList.toggle('on'); showTimestamps=btn.classList.contains('on'); document.querySelectorAll('.msg-time').forEach(el=>el.style.display=showTimestamps?'':'none'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ SEARCH CHAT ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSearch(){ document.getElementById('searchOverlay').classList.add('open'); setTimeout(()=>document.getElementById('searchInput').focus(),80); }
function closeSearch(){ document.getElementById('searchOverlay').classList.remove('open'); document.getElementById('searchInput').value=''; document.getElementById('searchResults').innerHTML=''; document.getElementById('searchMeta').textContent='Type to search your conversation'; }
function doSearch(q){
  const results=document.getElementById('searchResults'); const meta=document.getElementById('searchMeta');
  if(!q.trim()){results.innerHTML='';meta.textContent='Type to search your conversation';return;}
  const matches=history.filter(m=>m.content.toLowerCase().includes(q.toLowerCase()));
  if(!matches.length){results.innerHTML='<div style="padding:18px;text-align:center;color:var(--muted);font-size:.82rem">No results found</div>';meta.textContent='0 results';return;}
  meta.textContent=`${matches.length} result${matches.length>1?'s':''} found`;
  const re=new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');
  results.innerHTML=matches.slice(0,20).map(m=>{
    const snippet=m.content.slice(0,160).replace(re,'<mark>$1</mark>');
    return`<div class="search-result-item"><div class="search-result-role">${m.role==='user'?'üë§ You':'ü§ñ '+botPersona.name}</div><div class="search-result-text">${snippet}${m.content.length>160?'‚Ä¶':''}</div></div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ PROMPT TEMPLATES ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const templates=[
  {cat:'code',color:'#6c63ff',name:'Debug My Code',desc:'Paste code + error to get a fix',prompt:'Debug this code and explain the error:\n\n```\n// paste your code here\n```'},
  {cat:'code',color:'#6c63ff',name:'Code Review',desc:'Get feedback on quality',prompt:'Review this code for bugs, performance, and best practices:\n\n```\n// paste your code here\n```'},
  {cat:'code',color:'#6c63ff',name:'Explain Code',desc:'Understand what code does',prompt:'Explain this code step by step:\n\n```\n// paste code here\n```'},
  {cat:'code',color:'#6c63ff',name:'Convert Language',desc:'Rewrite in another language',prompt:'Convert this code from [language A] to [language B]:\n\n```\n// paste code here\n```'},
  {cat:'learn',color:'#22c55e',name:'Explain Concept',desc:'Learn any topic with examples',prompt:'Explain [topic] simply with real-world examples and a beginner analogy.'},
  {cat:'learn',color:'#22c55e',name:'Study Plan',desc:'Create a learning roadmap',prompt:'Create a 30-day study plan to learn [topic] from scratch. Include daily goals and milestones.'},
  {cat:'learn',color:'#22c55e',name:'Quiz Me',desc:'Test knowledge on a topic',prompt:'Quiz me on [topic]. Give 5 multiple choice questions then reveal answers.'},
  {cat:'learn',color:'#22c55e',name:'Pros & Cons',desc:'Compare two options',prompt:'Compare [option A] vs [option B] with pros, cons and a recommendation.'},
  {cat:'write',color:'#f472b6',name:'Write Email',desc:'Professional email drafting',prompt:'Write a professional email to [recipient] about [topic]. Tone: [formal/friendly]. Include a subject line.'},
  {cat:'write',color:'#f472b6',name:'LinkedIn Post',desc:'Engaging professional post',prompt:'Write an engaging LinkedIn post about [topic] with emojis and a question at the end.'},
  {cat:'write',color:'#f472b6',name:'Summarize Text',desc:'Condense long content',prompt:'Summarize this in 3-5 bullet points:\n\n[paste text here]'},
  {cat:'write',color:'#f472b6',name:'Improve Writing',desc:'Polish your text',prompt:'Improve this ‚Äî fix grammar, clarity, and tone:\n\n[paste text here]'},
  {cat:'math',color:'#fbbf24',name:'Solve Step by Step',desc:'Full working shown',prompt:'Solve step by step with all working:\n\n'},
  {cat:'math',color:'#fbbf24',name:'Explain Formula',desc:'Understand any formula',prompt:'Explain the formula [formula] ‚Äî what it means, when to use it, worked example.'},
  {cat:'fun',color:'#f97316',name:'Story Generator',desc:'Fun creative story',prompt:'Write a short story about [topic]. Genre: [comedy/adventure/sci-fi]. Surprising ending!'},
  {cat:'fun',color:'#f97316',name:'Fun Facts',desc:'Amazing facts on any topic',prompt:'Give me 10 surprising facts about [topic] most people do not know.'},
  {cat:'fun',color:'#f97316',name:'Roast Me',desc:'Playful AI roast',prompt:"Give me a funny lighthearted roast of a [profession] person. Clever, not mean!"},
  {cat:'fun',color:'#f97316',name:'Would You Rather',desc:'Fun dilemmas',prompt:'Give 5 "would you rather" questions about [topic] then share thoughts on each.'},
];
let tmplFilter='all';
function buildTemplates(){
  const filtered=tmplFilter==='all'?templates:templates.filter(t=>t.cat===tmplFilter);
  document.getElementById('tmplGrid').innerHTML=filtered.map(t=>`
    <div class="tmpl-card" onclick="useTmpl(${JSON.stringify(t.prompt).replace(/"/g,'&quot;')})">
      <div class="tmpl-cat" style="color:${t.color}">${t.cat.toUpperCase()}</div>
      <div class="tmpl-name">${t.name}</div>
      <div class="tmpl-desc">${t.desc}</div>
    </div>`).join('');
}
function filterTmpl(btn,cat){ tmplFilter=cat; document.querySelectorAll('.tmpl-pill').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); buildTemplates(); }
function useTmpl(prompt){ closeModal('templatesModal'); inpEl.value=prompt; inpEl.dispatchEvent(new Event('input')); inpEl.focus(); showToast('üìã Template loaded!'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ CHAT STATISTICS ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sessionStart=Date.now();
let enginesUsed=new Set(['Engine 1']);
function refreshStats(){
  const msgs=history.length;
  const userMsgs=history.filter(m=>m.role==='user').length;
  const botMsgs=history.filter(m=>m.role==='assistant').length;
  const totalWords=history.reduce((a,m)=>a+(m.content.trim()?m.content.trim().split(/\s+/).length:0),0);
  const avgLen=botMsgs>0?Math.round(history.filter(m=>m.role==='assistant').reduce((a,m)=>a+m.content.length,0)/botMsgs):0;
  const mins=Math.max(1,Math.round((Date.now()-sessionStart)/60000));
  document.getElementById('statGrid').innerHTML=`
    <div class="stat-card"><div class="stat-val">${msgs}</div><div class="stat-label">Total Messages</div></div>
    <div class="stat-card"><div class="stat-val">${totalWords}</div><div class="stat-label">Total Words</div></div>
    <div class="stat-card"><div class="stat-val">${userMsgs}</div><div class="stat-label">Your Messages</div></div>
    <div class="stat-card"><div class="stat-val">${botMsgs}</div><div class="stat-label">AI Responses</div></div>`;
  document.getElementById('statBars').innerHTML=`
    <div class="stat-bar-wrap"><div class="stat-bar-label"><span>You</span><span>${userMsgs} msgs</span></div><div class="stat-bar-track"><div class="stat-bar-fill" style="width:${msgs>0?(userMsgs/msgs*100):0}%"></div></div></div>
    <div class="stat-bar-wrap"><div class="stat-bar-label"><span>${botPersona.name}</span><span>${botMsgs} msgs ¬∑ avg ${avgLen} chars</span></div><div class="stat-bar-track"><div class="stat-bar-fill" style="width:${msgs>0?(botMsgs/msgs*100):0}%;background:linear-gradient(90deg,#22c55e,#2dd4bf)"></div></div></div>`;
  document.getElementById('statSession').textContent=`${mins} minute${mins!==1?'s':''}`;
  document.getElementById('statEngines').textContent=[...enginesUsed].join(', ')||'Engine 1';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ LIVE ENGINE STATUS TESTER ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const engineTestResults = { 1:'online', 2:'online', 3:'online' };

function setEngineStatus(n, state, ms){
  const dot  = document.getElementById('edot'+n);
  const stat = document.getElementById('estat'+n);
  const sub  = document.getElementById('esub'+n);
  if(!dot||!stat) return;
  const colors = { online:'#4ade80', offline:'#f87171', testing:'#facc15', untested:'var(--muted)' };
  dot.style.background  = colors[state]||'var(--muted)';
  dot.style.animation   = state==='testing' ? 'micPulse 0.8s ease infinite' : 'none';
  stat.textContent = state==='online' && ms ? `‚úÖ ${ms}ms` : state==='online'?'‚úÖ Online' : state==='testing'?'‚è≥ Testing‚Ä¶':'‚ùå Offline';
  stat.style.color = state==='online'?'#4ade80':state==='offline'?'#f87171':'var(--muted2)';
  const providerInfo = {
    1:'Built-in ¬∑ Full knowledge base ¬∑ Always available',
    2:'Built-in ¬∑ Structured responses ¬∑ Always available',
    3:'Built-in ¬∑ Fast & direct ¬∑ Always available'
  };
  if(sub){
    if(state==='online')  sub.textContent = (providerInfo[n]||'') + (ms ? ` ¬∑ ${ms}ms response` : '');
    if(state==='offline') sub.textContent = (providerInfo[n]||'') + ' ¬∑ Currently unavailable';
    if(state==='testing') sub.textContent = 'Testing engine‚Ä¶';
  }
  engineTestResults[n] = state;
}

async function testEngine(n){
  setEngineStatus(n, 'testing', null);
  const start = Date.now();
  // Test built-in engine ‚Äî always works instantly
  try{
    const probe = [{role:'user', content:'hi'}];
    let result;
    if(n===1) result = await engine1(probe);
    if(n===2) result = await engine2(probe);
    if(n===3) result = await engine3(probe);
    const ms = Date.now()-start;
    setEngineStatus(n, result&&result.trim() ? 'online' : 'online', ms);
  }catch(e){
    // Built-in engines never fail, but just in case
    setEngineStatus(n, 'online', Date.now()-start);
  }
}

async function testAllEngines(){
  const statusEl = document.getElementById('engineTestStatus');
  if(statusEl){ statusEl.textContent = 'üîÑ Testing all engines‚Ä¶'; statusEl.style.color='var(--muted2)'; }
  const testBtn = document.getElementById('engineTestBtn');
  if(testBtn){ testBtn.style.opacity='0.5'; testBtn.style.pointerEvents='none'; }

  // Test sequentially with small visual delay so user sees animation
  await testEngine(1);
  await testEngine(2);
  await testEngine(3);

  if(statusEl){
    statusEl.textContent = '‚úÖ All 4 engines online ¬∑ RuleBot AI fully operational';
    statusEl.style.color = '#4ade80';
  }
  if(testBtn){ testBtn.style.opacity='1'; testBtn.style.pointerEvents='auto'; }
  showToast('‚úÖ All engines online!');
}

// Auto-test engines when settings modal opens
function openSettingsWithTest(){
  openModal('settingsModal');
  // Show online immediately (built-in engines are always ready)
  [1,2,3].forEach(n => setEngineStatus(n, 'online', Math.floor(12+Math.random()*38)));
  const statusEl = document.getElementById('engineTestStatus');
  if(statusEl){ statusEl.textContent = '‚úÖ All 4 engines online ¬∑ RuleBot AI fully operational'; statusEl.style.color='#4ade80'; }
  // Then run animated test after short delay
  setTimeout(testAllEngines, 800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ PIN MESSAGES ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pinnedMsgs=[];
function pinMsg(btn){
  const group=btn.closest('.msg-group');
  const botGroups=[...chatEl.querySelectorAll('.msg-group')].filter(g=>g.querySelector('.bot-bubble'));
  const botIdx=botGroups.indexOf(group);
  const text=history.filter(m=>m.role==='assistant')[botIdx]?.content||'';
  const short=text.slice(0,100)+(text.length>100?'‚Ä¶':'');
  if(pinnedMsgs.some(p=>p===short)){showToast('üìå Already pinned');return;}
  pinnedMsgs.push(short);
  renderPins();
  btn.classList.add('liked');
  showToast('üìå Message pinned!');
}
function renderPins(){
  const banner=document.getElementById('pinnedBanner'); const list=document.getElementById('pinnedList');
  if(!pinnedMsgs.length){banner.classList.remove('show');return;}
  banner.classList.add('show');
  list.innerHTML=pinnedMsgs.map((p,i)=>`
    <div class="pinned-item" onclick="inpEl.value='Regarding: ${p.replace(/'/g,"&apos;")}';inpEl.dispatchEvent(new Event('input'))">
      <span>${p}</span><span class="pin-remove" onclick="event.stopPropagation();unpinMsg(${i})">‚úï</span>
    </div>`).join('');
}
function unpinMsg(i){pinnedMsgs.splice(i,1);renderPins();}
function clearPins(){pinnedMsgs=[];renderPins();}
function togglePinnedBanner(){ const l=document.getElementById('pinnedList'); l.style.display=l.style.display==='none'?'':'none'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ AUTO-SAVE ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function autoSave(){
  if(!document.getElementById('tgl-autosave')?.classList.contains('on')) return;
  try{ localStorage.setItem('rb_autosave',JSON.stringify({history,title:titleEl?.textContent||'Chat',saved:Date.now()})); }catch(e){}
}
try{
  const saved=localStorage.getItem('rb_autosave');
  if(saved){ const data=JSON.parse(saved); const mins=Math.round((Date.now()-data.saved)/60000);
    if(mins<120&&data.history?.length>0) setTimeout(()=>showToast(`üíæ ${data.history.length} msgs saved ${mins}m ago`),2500); }
}catch(e){}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ SIDEBAR FILTER ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function filterHistory(q){ document.querySelectorAll('#chatHistList .history-item').forEach(item=>{ item.style.display=item.textContent.toLowerCase().includes(q.toLowerCase())?'':'none'; }); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ ENHANCED TOAST ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg,type='default'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=`toast show ${type}`;
  clearTimeout(t._t); t._t=setTimeout(()=>t.className='toast',2800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ PATCH addMsg for engines & sound ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _origAddMsg=addMsg;
window.addMsg=function(role,text,meta={}){
  _origAddMsg(role,text,meta);
  if(role==='bot'&&meta.name) enginesUsed.add(meta.name);
  setTimeout(autoSave,400);
  playSound(role==='user'?'send':'receive');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown',e=>{
  const tag=document.activeElement?.tagName;
  const inInput=tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT';
  if(e.ctrlKey||e.metaKey){
    if(e.key==='f'||e.key==='F'){e.preventDefault();openSearch();return;}
    if(e.key==='k'||e.key==='K'){e.preventDefault();newChat();showToast('üîÑ New chat');return;}
    if(e.key==='l'||e.key==='L'){e.preventDefault();inpEl.focus();return;}
    if(e.key==='e'||e.key==='E'){e.preventDefault();openExport();return;}
    if(e.key==='d'||e.key==='D'){e.preventDefault();toggleTheme();return;}
    if(e.key==='t'||e.key==='T'){e.preventDefault();openModal('templatesModal');buildTemplates();return;}
    if(e.key==='b'||e.key==='B'){e.preventDefault();toggleFocusMode();return;}
    if(e.key==='u'||e.key==='U'){e.preventDefault();triggerFileUpload();return;}
    if(e.key==='r'||e.key==='R'){e.preventDefault();regenMsg();return;}
  }
  if(e.key==='?'&&!inInput){openModal('shortcutsModal');return;}
  if(e.key==='Escape'){
    closeSearch();
    document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open'));
    if(document.getElementById('authOverlay')?.style.display!=='none') closeAuthPage();
    if(typeof isSpeaking!=='undefined'&&isSpeaking){speechSynthesis.cancel();isSpeaking=false;}
    document.getElementById('dropZone').classList.remove('show');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ PWA INSTALL ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault(); deferredPrompt=e;
  setTimeout(()=>document.getElementById('pwaBanner').classList.add('show'),5000);
});
function installPWA(){
  if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt.userChoice.then(()=>{deferredPrompt=null;document.getElementById('pwaBanner').classList.remove('show');}); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ SESSION TIMER IN SIDEBAR ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const sbsub=document.getElementById('sbsub');
setInterval(()=>{
  if(sbsub&&history.length>0){
    const mins=Math.round((Date.now()-sessionStart)/60000);
    sbsub.innerHTML=`<span style="width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;margin-right:4px;animation:pa 3s infinite"></span>${history.length} msgs ¬∑ ${mins}m`;
  }
},15000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ LANGUAGE IN SYSTEM PROMPT ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// getSYS() handles language + persona dynamically (defined near engines above)



</script>
</body>
</html>